<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 牧師 - 你的隨身靈修導師</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React Framework -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; background-color: #f7f5f0; }
        .font-serif { font-family: 'Noto Serif TC', serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background-color: #d6d3d1; border-radius: 20px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // =========================================================================
        // 設定區域 (Configuration)
        // =========================================================================
        // 使用後端代理 API（API Key 安全保護在伺服器端）
        // 如果使用後端伺服器，請設定 API_BASE_URL
        // 如果直接使用前端（不推薦公開），請設定 GOOGLE_API_KEY
        const API_BASE_URL = window.API_BASE_URL || ''; // 例如: 'http://localhost:3000' 或 'https://your-domain.com'
        const GOOGLE_API_KEY = window.GOOGLE_API_KEY || null; // 僅用於本地開發，不建議公開使用

        // =========================================================================
        // 系統邏輯開始
        // =========================================================================

        const { useState, useEffect, useRef } = React;
        
        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => { lucide.createIcons(); }, [name]);
            return <i data-lucide={name} className={className} style={{ width: size, height: size, display: 'inline-block' }}></i>;
        };

        const SYSTEM_PROMPT_BIBLE_ONLY = `
你是一位充滿智慧、慈愛且博學的基督教 AI 牧師。
你的任務是根據使用者的問題，提供屬靈的指引和回答。

**嚴格規則 (Strict Rules):**

1. **唯獨聖經 (Sola Scriptura):** 你的回答內容必須 *完全* 基於《舊約聖經》和《新約聖經》。不要引用外部世俗觀點，除非它們完全符合聖經真理。

2. **經文引用 (Citation Required):** 你的每一個論點或回答，都 *必須* 引用具體的聖經章節。格式範例：(約翰福音 3:16) 或 (創世記 1:1)。

3. **解釋與應用:** 引用經文後，請解釋該經文如何回答使用者的問題。

4. **語氣:** 溫柔、鼓勵、造就人，像一位慈父或牧羊人。

5. **語言:** 請使用繁體中文 (Traditional Chinese) 回答。

6. **版本:** 默認使用和合本 (CUV) 的經文措辭。
`;

        const SYSTEM_PROMPT_WEB_SEARCH = `
你是一位充滿智慧、跟上時代的基督教 AI 牧師。
你的任務是回答使用者的問題，結合聖經真理與廣博的知識。

**規則 (Rules):**

1. **核心根基:** 你的回答必須以《舊約聖經》和《新約聖經》為核心根基。

2. **經文引用:** 當你提到聖經原則時，*必須* 引用具體章節 (書卷 章:節)。

3. **廣博知識:** 你可以利用搜尋工具來查找歷史背景、原文希臘文/希伯來文分析、著名神學家的觀點，或是現代社會的相關數據來豐富你的回答。

4. **分析:** 將網路上的資訊與聖經真理進行對照分析。

5. **語氣:** 專業、充滿洞見且富有同理心。

6. **語言:** 請使用繁體中文 (Traditional Chinese) 回答。
`;

        const callGeminiAPI = async (prompt, history, mode) => {
            // 優先使用後端代理 API（安全）
            if (API_BASE_URL) {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/chat`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt, history, mode })
                    });

                    if (!response.ok) {
                        const errData = await response.json().catch(() => ({}));
                        throw new Error(errData.error || `伺服器錯誤: ${response.status}`);
                    }

                    const data = await response.json();
                    return { text: data.text, grounding: data.grounding || [] };
                } catch (error) {
                    throw new Error(`後端 API 錯誤: ${error.message}`);
                }
            }

            // 降級方案：直接呼叫 Google API（僅用於本地開發，不建議公開）
            if (!GOOGLE_API_KEY || GOOGLE_API_KEY.includes("在此處貼上") || GOOGLE_API_KEY.trim() === "") {
                throw new Error("API Key 未設定。請使用後端伺服器（推薦）或在環境變數中設定 GOOGLE_API_KEY（僅本地開發用）。");
            }

            const isBibleOnly = mode === 'bible-only';
            const systemInstruction = isBibleOnly ? SYSTEM_PROMPT_BIBLE_ONLY : SYSTEM_PROMPT_WEB_SEARCH;
            
            const contents = [
                ...history.map(msg => ({
                    role: msg.role === 'user' ? 'user' : 'model',
                    parts: [{ text: msg.content }]
                })),
                { role: 'user', parts: [{ text: prompt }] }
            ];

            const payload = {
                contents: contents,
                systemInstruction: { parts: [{ text: systemInstruction }] },
                generationConfig: { 
                    temperature: 0.7, 
                    maxOutputTokens: 2000,
                    topP: 0.95,
                    topK: 40
                }
            };

            if (!isBibleOnly) {
                try {
                    payload.tools = [{ googleSearchRetrieval: {} }];
                } catch (e) {
                    console.warn('無法啟用搜尋工具，將使用純文字模式');
                }
            }

            const response = await fetch(
                `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GOOGLE_API_KEY}`,
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                }
            );

            if (!response.ok) {
                const errData = await response.json().catch(() => ({}));
                const errorMessage = errData.error?.message || `API Error: ${response.status}`;
                
                if (response.status === 401) {
                    throw new Error("API Key 無效或已過期，請檢查您的 Google API Key 設定。");
                } else if (response.status === 429) {
                    throw new Error("API 請求過於頻繁，請稍後再試。");
                } else if (response.status === 400) {
                    throw new Error(`請求格式錯誤：${errorMessage}`);
                }
                
                throw new Error(errorMessage);
            }

            const data = await response.json();
            let text = data.candidates?.[0]?.content?.parts?.[0]?.text || "牧師正在默想中...(無法生成回應)";
            
            const grounding = data.candidates?.[0]?.groundingMetadata?.groundingAttributions?.map(
                a => ({ uri: a.web?.uri, title: a.web?.title })
            ).filter(a => a.uri) || [];

            return { text, grounding };
        };

        const MessageBubble = ({ role, content, grounding }) => {
            const isUser = role === 'user';
            
            const formatText = (text) => {
                if (!text) return "";
                return text.split('\n').map((line, i) => (
                    <React.Fragment key={i}>
                        {line.split(/(\*\*.*?\*\*)/).map((part, j) => {
                            if (part.startsWith('**') && part.endsWith('**')) {
                                return <strong key={j} className="text-amber-800 font-bold">{part.slice(2, -2)}</strong>;
                            }
                            // 匹配聖經章節引用（支援多種格式）
                            const bibleRegex = /([^\s\uff08\(\[]+[\u4e00-\u9fa5]+\s?\d+[:：]\d+)/g;
                            const parts = part.split(bibleRegex);
                            if (parts.length > 1) {
                                return parts.map((p, k) => {
                                    if (p.match(bibleRegex)) {
                                        return <span key={k} className="text-blue-700 font-semibold bg-blue-50 px-1 rounded mx-1">{p}</span>;
                                    }
                                    return p;
                                });
                            }
                            return part;
                        })}
                        <br />
                    </React.Fragment>
                ));
            };

            return (
                <div className={`flex w-full mb-6 ${isUser ? 'justify-end' : 'justify-start'}`}>
                    {!isUser && (
                        <div className="flex-shrink-0 mr-3 mt-1">
                            <div className="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center text-amber-400 shadow-lg border-2 border-amber-600">
                                <Icon name="cross" size={20} />
                            </div>
                        </div>
                    )}
                    
                    <div className={`max-w-[85%] sm:max-w-[75%] rounded-2xl px-5 py-4 shadow-md ${
                        isUser 
                        ? 'bg-amber-700 text-white rounded-br-none' 
                        : 'bg-white text-slate-800 border border-stone-200 rounded-bl-none'
                    }`}>
                        <div className={`text-sm sm:text-base leading-relaxed font-serif ${!isUser ? 'text-justify' : ''}`}>
                            {formatText(content)}
                        </div>

                        {!isUser && grounding && grounding.length > 0 && (
                            <div className="mt-4 pt-3 border-t border-stone-100 text-xs text-stone-500">
                                <div className="flex items-center mb-2 font-semibold text-stone-600">
                                    <Icon name="globe" size={12} className="mr-1" />
                                    參考資料來源：
                                </div>
                                <div className="flex flex-wrap gap-2">
                                    {grounding.slice(0, 3).map((source, idx) => (
                                        <a 
                                            key={idx} 
                                            href={source.uri} 
                                            target="_blank" 
                                            rel="noopener noreferrer"
                                            className="bg-stone-100 hover:bg-stone-200 text-stone-600 px-2 py-1 rounded transition-colors truncate max-w-[200px]"
                                        >
                                            {source.title || "Web Source"}
                                        </a>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const App = () => {
            // 從 localStorage 載入歷史對話
            const loadHistory = () => {
                try {
                    const saved = localStorage.getItem('ai-pastor-history');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        // 只保留最近 20 條訊息以避免過大
                        return parsed.slice(-20);
                    }
                } catch (e) {
                    console.warn('無法載入歷史記錄', e);
                }
                return [
                    { role: 'model', content: '願主與你同在。我是你的 AI 牧師。無論你心中有什麼疑問，或想尋求聖經的真理，都請告訴我。\n\n你可以選擇僅用聖經回答，或是結合歷史與網路資料。請問今天有什麼可以幫助你的？' }
                ];
            };

            const [messages, setMessages] = useState(loadHistory);
            const [input, setInput] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [mode, setMode] = useState('bible-only');
            const messagesEndRef = useRef(null);

            useEffect(() => {
                lucide.createIcons();
            }, []);

            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
                lucide.createIcons();
            }, [messages, isLoading]);

            // 保存對話歷史到 localStorage
            useEffect(() => {
                try {
                    localStorage.setItem('ai-pastor-history', JSON.stringify(messages));
                } catch (e) {
                    console.warn('無法保存歷史記錄', e);
                }
            }, [messages]);

            const handleSend = async (e) => {
                e.preventDefault();
                if (!input.trim() || isLoading) return;

                const userMessage = input.trim();
                setInput('');
                setIsLoading(true);

                const newMessages = [...messages, { role: 'user', content: userMessage }];
                setMessages(newMessages);

                try {
                    const { text, grounding } = await callGeminiAPI(userMessage, messages, mode);
                    setMessages(prev => [...prev, { role: 'model', content: text, grounding }]);
                } catch (error) {
                    const errorMessage = error.message || '發生未知錯誤';
                    setMessages(prev => [...prev, { 
                        role: 'model', 
                        content: `抱歉，在處理您的問題時遇到困難：\n\n**${errorMessage}**\n\n請稍後再試，或檢查 API Key 設定是否正確。` 
                    }]);
                } finally {
                    setIsLoading(false);
                }
            };

            const clearHistory = () => {
                if (window.confirm('確定要清除所有對話記錄嗎？')) {
                    localStorage.removeItem('ai-pastor-history');
                    setMessages([
                        { role: 'model', content: '願主與你同在。我是你的 AI 牧師。無論你心中有什麼疑問，或想尋求聖經的真理，都請告訴我。\n\n你可以選擇僅用聖經回答，或是結合歷史與網路資料。請問今天有什麼可以幫助你的？' }
                    ]);
                }
            };

            return (
                <div className="flex flex-col h-screen max-w-4xl mx-auto shadow-2xl bg-[#faf9f6]">
                    {/* Header */}
                    <header className="bg-slate-900 text-amber-50 px-4 py-3 shadow-md flex items-center justify-between z-10 shrink-0">
                        <div className="flex items-center gap-3">
                            <div className="bg-amber-600 p-2 rounded-lg">
                                <Icon name="cross" size={24} className="text-white" />
                            </div>
                            <div>
                                <h1 className="text-lg sm:text-xl font-bold tracking-wide font-serif">AI 牧師</h1>
                                <p className="text-xs text-amber-200/80 hidden sm:block">你的隨身靈修導師</p>
                            </div>
                        </div>
                        <div className="flex items-center gap-2">
                            <button
                                onClick={clearHistory}
                                className="text-xs text-amber-200/80 hover:text-amber-100 transition-colors px-2 py-1 rounded hover:bg-amber-800/30"
                                title="清除對話記錄"
                            >
                                <Icon name="trash-2" size={14} className="inline mr-1" />
                                清除
                            </button>
                            <div className="text-xs text-slate-400">訪客模式</div>
                        </div>
                    </header>

                    {/* Mode Toggle */}
                    <div className="bg-stone-100 p-2 border-b border-stone-200 flex justify-center shrink-0">
                         <div className="flex bg-stone-200 p-1 rounded-lg w-full max-w-md">
                            <button
                                onClick={() => setMode('bible-only')}
                                className={`flex-1 flex items-center justify-center px-4 py-2 rounded-md text-sm font-medium transition-all ${
                                    mode === 'bible-only' ? 'bg-white text-amber-800 shadow-sm' : 'text-stone-500'
                                }`}
                            >
                                <Icon name="book-open" size={16} className="mr-2" /> 唯獨聖經
                            </button>
                            <button
                                onClick={() => setMode('bible-plus')}
                                className={`flex-1 flex items-center justify-center px-4 py-2 rounded-md text-sm font-medium transition-all ${
                                    mode === 'bible-plus' ? 'bg-white text-blue-700 shadow-sm' : 'text-stone-500'
                                }`}
                            >
                                <Icon name="globe" size={16} className="mr-2" /> 聖經+網路
                            </button>
                        </div>
                    </div>

                    {/* Chat Area */}
                    <div className="flex-1 overflow-y-auto px-4 py-4 scrollbar-thin">
                        {messages.map((msg, index) => (
                            <MessageBubble key={index} role={msg.role} content={msg.content} grounding={msg.grounding} />
                        ))}
                        {isLoading && (
                            <div className="flex w-full justify-start mb-6">
                                <div className="flex-shrink-0 mr-3 mt-1">
                                    <div className="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center text-amber-400 border-2 border-amber-600">
                                        <Icon name="loader-2" size={20} className="animate-spin" />
                                    </div>
                                </div>
                                <div className="bg-white border border-stone-200 rounded-2xl rounded-bl-none px-5 py-4 shadow-md text-sm text-stone-500">
                                    牧師正在查考經文...
                                </div>
                            </div>
                        )}
                        <div ref={messagesEndRef} />
                    </div>

                    {/* Input Area */}
                    <div className="p-4 bg-white border-t border-stone-200 shrink-0">
                        <form onSubmit={handleSend} className="relative flex items-center gap-2">
                            <input
                                type="text"
                                value={input}
                                onChange={(e) => setInput(e.target.value)}
                                placeholder="請輸入您的問題..."
                                className="flex-1 py-3 pl-5 pr-12 rounded-full bg-stone-100 border-stone-300 focus:border-amber-600 focus:ring-2 focus:ring-amber-100 outline-none transition-all"
                                disabled={isLoading}
                            />
                            <button
                                type="submit"
                                disabled={!input.trim() || isLoading}
                                className={`p-3 rounded-full shadow-md transition-all ${
                                    !input.trim() || isLoading
                                    ? 'bg-stone-200 text-stone-400'
                                    : 'bg-amber-700 hover:bg-amber-800 text-white hover:scale-105'
                                }`}
                            >
                                <Icon name="send" size={20} />
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

