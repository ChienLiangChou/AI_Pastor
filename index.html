<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>AI 牧師 - 你的隨身靈修導師</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React Framework -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { 
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; 
            background-color: #f7f5f0; 
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
        .font-serif { font-family: 'Noto Serif TC', serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background-color: #d6d3d1; border-radius: 20px; }
        
        /* 響應式優化 */
        @media (max-width: 640px) {
            /* 手機優化 */
            body {
                font-size: 14px;
            }
            /* 確保在手機上所有關鍵元素都能顯示 */
            #root {
                height: 100vh;
                height: 100dvh; /* 使用動態視窗高度，考慮瀏覽器 UI */
            }
        }
        
        @media (min-width: 641px) and (max-width: 1024px) {
            /* 平板優化 */
            body {
                font-size: 15px;
            }
        }
        
        @media (min-width: 1025px) {
            /* 桌面優化 */
            body {
                font-size: 16px;
            }
        }
        
        /* 觸控設備優化 */
        @media (hover: none) and (pointer: coarse) {
            button, a {
                min-height: 44px;
                min-width: 44px;
            }
        }
        
        /* 確保 flexbox 容器正確處理高度 */
        .flex-col {
            display: flex;
            flex-direction: column;
        }
        
        /* 防止內容溢出 */
        .overflow-hidden {
            overflow: hidden;
        }
        
        .min-h-0 {
            min-height: 0;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // =========================================================================
        // 設定區域 (Configuration)
        // =========================================================================
        // 使用後端代理 API（API Key 安全保護在伺服器端）
        // 在 Vercel 上，使用相對路徑自動指向同域的 API
        // 本地開發時，可以設定 API_BASE_URL 指向本地伺服器
        const API_BASE_URL = window.API_BASE_URL || ''; // 例如: 'http://localhost:3000' 或留空使用相對路徑（Vercel）
        const GOOGLE_API_KEY = window.GOOGLE_API_KEY || null; // 僅用於本地開發，不建議公開使用

        // =========================================================================
        // 系統邏輯開始
        // =========================================================================

        const { useState, useEffect, useRef } = React;
        
        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => { lucide.createIcons(); }, [name]);
            return <i data-lucide={name} className={className} style={{ width: size, height: size, display: 'inline-block' }}></i>;
        };

        const SYSTEM_PROMPT_BIBLE_ONLY = `
You are a wise, loving, and learned Christian AI Pastor.
Your task is to provide spiritual guidance and answers based on the user's questions.

**Strict Rules:**

1. **Sola Scriptura:** Your answers must be *completely* based on the Old Testament and New Testament. Do not cite external secular views unless they fully align with biblical truth.

2. **Citation Required:** Every point or answer you make *must* cite specific Bible verses. Format example: (John 3:16) or (Genesis 1:1).

3. **Explanation and Application:** After citing verses, explain how the verse answers the user's question.

4. **Tone:** Gentle, encouraging, and edifying, like a loving father or shepherd.

5. **Language:** Respond in the same language as the user's question. If the user asks in English, respond in English. If the user asks in Chinese, respond in Traditional Chinese.

6. **Version:** Default to CUV (Chinese Union Version) wording for Chinese responses.
`;

        const SYSTEM_PROMPT_WEB_SEARCH = `
You are a wise, up-to-date Christian AI Pastor.
Your task is to answer the user's questions, combining biblical truth with broad knowledge.

**Rules:**

1. **Core Foundation:** Your answers must be rooted in the Old Testament and New Testament.

2. **Scripture Citation:** When you mention biblical principles, *must* cite specific chapters and verses (book chapter:verse).

3. **Broad Knowledge:** You can use search tools to find historical background, original Greek/Hebrew analysis, views of famous theologians, or modern social data to enrich your answers.

4. **Analysis:** Compare and analyze information from the web with biblical truth.

5. **Tone:** Professional, insightful, and empathetic.

6. **Language:** Respond in the same language as the user's question. If the user asks in English, respond in English. If the user asks in Chinese, respond in Traditional Chinese.
`;

        const callGeminiAPI = async (prompt, history, mode) => {
            // 優先使用後端代理 API（安全）
            // 如果設定了 API_BASE_URL，使用它；否則使用相對路徑（適用於 Vercel）
            const apiUrl = API_BASE_URL ? `${API_BASE_URL}/api/chat` : '/api/chat';
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt, history, mode })
                });

                if (!response.ok) {
                    const errData = await response.json().catch(() => ({}));
                    throw new Error(errData.error || `伺服器錯誤: ${response.status}`);
                }

                const data = await response.json();
                return { text: data.text, grounding: data.grounding || [] };
            } catch (error) {
                // 如果後端 API 失敗且沒有設定 API_BASE_URL，嘗試降級到直接 API 調用
                if (!API_BASE_URL && GOOGLE_API_KEY) {
                    console.warn('後端 API 失敗，嘗試直接調用...');
                    // 繼續執行下面的直接 API 調用邏輯
                } else {
                    throw new Error(`後端 API 錯誤: ${error.message}`);
                }
            }

            // 降級方案：直接呼叫 Google API（僅用於本地開發，不建議公開）
            if (!GOOGLE_API_KEY || GOOGLE_API_KEY.includes("在此處貼上") || GOOGLE_API_KEY.trim() === "") {
                throw new Error("API Key 未設定。請使用後端伺服器（推薦）或在環境變數中設定 GOOGLE_API_KEY（僅本地開發用）。");
            }

            const isBibleOnly = mode === 'bible-only';
            const systemInstruction = isBibleOnly ? SYSTEM_PROMPT_BIBLE_ONLY : SYSTEM_PROMPT_WEB_SEARCH;
            
            const contents = [
                ...history.map(msg => ({
                    role: msg.role === 'user' ? 'user' : 'model',
                    parts: [{ text: msg.content }]
                })),
                { role: 'user', parts: [{ text: prompt }] }
            ];

            const payload = {
                contents: contents,
                systemInstruction: { parts: [{ text: systemInstruction }] },
                generationConfig: { 
                    temperature: 0.7, 
                    maxOutputTokens: 2000,
                    topP: 0.95,
                    topK: 40
                }
            };

            if (!isBibleOnly) {
                // 注意：googleSearchRetrieval 已被棄用，但前端降級方案暫時不使用搜索工具
                // 因為搜索工具需要在後端配置
                // payload.tools = [{ googleSearchRetrieval: {} }]; // 已棄用
                console.log('Web search mode: Using model knowledge without external search tool (fallback mode)');
            }

            const response = await fetch(
                `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GOOGLE_API_KEY}`,
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                }
            );

            if (!response.ok) {
                const errData = await response.json().catch(() => ({}));
                const errorMessage = errData.error?.message || `API Error: ${response.status}`;
                
                if (response.status === 401) {
                    throw new Error("API Key 無效或已過期，請檢查您的 Google API Key 設定。");
                } else if (response.status === 429) {
                    throw new Error("API 請求過於頻繁，請稍後再試。");
                } else if (response.status === 400) {
                    throw new Error(`請求格式錯誤：${errorMessage}`);
                }
                
                throw new Error(errorMessage);
            }

            const data = await response.json();
            let text = data.candidates?.[0]?.content?.parts?.[0]?.text || "牧師正在默想中...(無法生成回應)";
            
            const grounding = data.candidates?.[0]?.groundingMetadata?.groundingAttributions?.map(
                a => ({ uri: a.web?.uri, title: a.web?.title })
            ).filter(a => a.uri) || [];

            return { text, grounding };
        };

        const MessageBubble = ({ role, content, grounding }) => {
            const isUser = role === 'user';
            
            const formatText = (text) => {
                if (!text) return "";
                return text.split('\n').map((line, i) => (
                    <React.Fragment key={i}>
                        {line.split(/(\*\*.*?\*\*)/).map((part, j) => {
                            if (part.startsWith('**') && part.endsWith('**')) {
                                return <strong key={j} className="text-amber-800 font-bold">{part.slice(2, -2)}</strong>;
                            }
                            // 匹配聖經章節引用（支援多種格式）
                            const bibleRegex = /([^\s\uff08\(\[]+[\u4e00-\u9fa5]+\s?\d+[:：]\d+)/g;
                            const parts = part.split(bibleRegex);
                            if (parts.length > 1) {
                                return parts.map((p, k) => {
                                    if (p.match(bibleRegex)) {
                                        return <span key={k} className="text-blue-700 font-semibold bg-blue-50 px-1 rounded mx-1">{p}</span>;
                                    }
                                    return p;
                                });
                            }
                            return part;
                        })}
                        <br />
                    </React.Fragment>
                ));
            };

            return (
                <div className={`flex w-full mb-6 ${isUser ? 'justify-end' : 'justify-start'}`}>
                    {!isUser && (
                        <div className="flex-shrink-0 mr-2 sm:mr-3 mt-1">
                            <div className="w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-slate-800 flex items-center justify-center text-amber-400 shadow-lg border-2 border-amber-600">
                                <Icon name="cross" size={16} className="sm:w-5 sm:h-5" />
                            </div>
                        </div>
                    )}
                    
                    <div className={`max-w-[90%] sm:max-w-[85%] md:max-w-[75%] rounded-2xl px-3 sm:px-4 md:px-5 py-3 sm:py-4 shadow-md ${
                        isUser 
                        ? 'bg-amber-700 text-white rounded-br-none' 
                        : 'bg-white text-slate-800 border border-stone-200 rounded-bl-none'
                    }`}>
                        <div className={`text-xs sm:text-sm md:text-base leading-relaxed font-serif ${!isUser ? 'text-justify' : ''}`}>
                            {formatText(content)}
                        </div>

                        {!isUser && grounding && grounding.length > 0 && (
                            <div className="mt-3 sm:mt-4 pt-2 sm:pt-3 border-t border-stone-100 text-xs text-stone-500">
                                <div className="flex items-center mb-1.5 sm:mb-2 font-semibold text-stone-600">
                                    <Icon name="globe" size={12} className="mr-1" />
                                    <span className="text-xs sm:text-sm">參考資料來源：</span>
                                </div>
                                <div className="flex flex-wrap gap-1.5 sm:gap-2">
                                    {grounding.slice(0, 3).map((source, idx) => (
                                        <a 
                                            key={idx} 
                                            href={source.uri} 
                                            target="_blank" 
                                            rel="noopener noreferrer"
                                            className="bg-stone-100 active:bg-stone-200 text-stone-600 px-2 py-1 rounded transition-colors truncate max-w-[150px] sm:max-w-[200px] text-xs"
                                        >
                                            {source.title || "Web Source"}
                                        </a>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const App = () => {
            // 從 localStorage 載入歷史對話
            const loadHistory = () => {
                try {
                    const saved = localStorage.getItem('ai-pastor-history');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        // 只保留最近 20 條訊息以避免過大
                        return parsed.slice(-20);
                    }
                } catch (e) {
                    console.warn('無法載入歷史記錄', e);
                }
                return [
                    { role: 'model', content: '願主與你同在。我是你的 AI 牧師。無論你心中有什麼疑問，或想尋求聖經的真理，都請告訴我。\n\n你可以選擇僅用聖經回答，或是結合歷史與網路資料。請問今天有什麼可以幫助你的？' }
                ];
            };

            const [messages, setMessages] = useState(loadHistory);
            const [input, setInput] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [mode, setMode] = useState('bible-only');
            const messagesEndRef = useRef(null);

            useEffect(() => {
                lucide.createIcons();
            }, []);

            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
                lucide.createIcons();
            }, [messages, isLoading]);

            // 保存對話歷史到 localStorage
            useEffect(() => {
                try {
                    localStorage.setItem('ai-pastor-history', JSON.stringify(messages));
                } catch (e) {
                    console.warn('無法保存歷史記錄', e);
                }
            }, [messages]);

            const handleSend = async (e) => {
                if (e && e.preventDefault) {
                    e.preventDefault();
                }
                if (!input.trim() || isLoading) return;

                const userMessage = input.trim();
                setInput('');
                setIsLoading(true);

                const newMessages = [...messages, { role: 'user', content: userMessage }];
                setMessages(newMessages);

                try {
                    const { text, grounding } = await callGeminiAPI(userMessage, messages, mode);
                    setMessages(prev => [...prev, { role: 'model', content: text, grounding }]);
                } catch (error) {
                    const errorMessage = error.message || '發生未知錯誤';
                    setMessages(prev => [...prev, { 
                        role: 'model', 
                        content: `抱歉，在處理您的問題時遇到困難：\n\n**${errorMessage}**\n\n請稍後再試，或檢查 API Key 設定是否正確。` 
                    }]);
                } finally {
                    setIsLoading(false);
                }
            };

            const clearHistory = () => {
                if (window.confirm('確定要清除所有對話記錄嗎？')) {
                    localStorage.removeItem('ai-pastor-history');
                    setMessages([
                        { role: 'model', content: '願主與你同在。我是你的 AI 牧師。無論你心中有什麼疑問，或想尋求聖經的真理，都請告訴我。\n\n你可以選擇僅用聖經回答，或是結合歷史與網路資料。請問今天有什麼可以幫助你的？' }
                    ]);
                }
            };

            return (
                <div className="flex flex-col h-screen w-full max-w-4xl mx-auto shadow-2xl bg-[#faf9f6] overflow-hidden">
                    {/* Header - 極致緊湊的設計 */}
                    <header className="bg-slate-900 text-amber-50 px-2 sm:px-4 py-0.5 sm:py-1.5 shadow-md flex items-center justify-between z-10 shrink-0">
                        <div className="flex items-center gap-1 sm:gap-2">
                            <div className="bg-amber-600 p-0.5 sm:p-1 rounded-lg">
                                <Icon name="cross" size={14} className="sm:w-5 sm:h-5 text-white" />
                            </div>
                            <div>
                                <h1 className="text-xs sm:text-base md:text-xl font-bold tracking-wide font-serif">AI 牧師</h1>
                                <p className="text-xs text-amber-200/80 hidden sm:block">你的隨身靈修導師</p>
                            </div>
                        </div>
                        <div className="flex items-center gap-0.5 sm:gap-2">
                            <button
                                onClick={clearHistory}
                                className="text-xs sm:text-sm text-amber-200/80 hover:text-amber-100 transition-colors px-1 sm:px-2 py-0.5 sm:py-1 rounded hover:bg-amber-800/30 active:bg-amber-800/50"
                                title="清除對話記錄"
                            >
                                <Icon name="trash-2" size={11} className="sm:w-3.5 sm:h-3.5 inline mr-0.5 sm:mr-1" />
                                <span className="hidden sm:inline">清除</span>
                            </button>
                            <div className="text-xs text-slate-400 hidden sm:block">訪客模式</div>
                        </div>
                    </header>

                    {/* Mode Toggle - 極致緊湊的設計 */}
                    <div className="bg-stone-100 p-0.5 sm:p-1.5 border-b border-stone-200 flex justify-center shrink-0">
                         <div className="flex bg-stone-200 p-0.5 sm:p-1 rounded-lg w-full max-w-md">
                            <button
                                onClick={() => setMode('bible-only')}
                                className={`flex-1 flex items-center justify-center px-1 sm:px-3 md:px-4 py-1 sm:py-1.5 md:py-2 rounded-md text-xs sm:text-sm font-medium transition-all active:scale-95 ${
                                    mode === 'bible-only' ? 'bg-white text-amber-800 shadow-sm' : 'text-stone-500'
                                }`}
                            >
                                <Icon name="book-open" size={10} className="sm:w-4 sm:h-4 mr-0.5 sm:mr-1.5" /> 
                                <span className="whitespace-nowrap text-xs sm:text-sm">唯獨聖經</span>
                            </button>
                            <button
                                onClick={() => setMode('bible-plus')}
                                className={`flex-1 flex items-center justify-center px-1 sm:px-3 md:px-4 py-1 sm:py-1.5 md:py-2 rounded-md text-xs sm:text-sm font-medium transition-all active:scale-95 ${
                                    mode === 'bible-plus' ? 'bg-white text-blue-700 shadow-sm' : 'text-stone-500'
                                }`}
                            >
                                <Icon name="globe" size={10} className="sm:w-4 sm:h-4 mr-0.5 sm:mr-1.5" /> 
                                <span className="whitespace-nowrap text-xs sm:text-sm">聖經+網路</span>
                            </button>
                        </div>
                    </div>

                    {/* Chat Area - 使用 flex-1 確保佔用剩餘空間 */}
                    <div className="flex-1 overflow-y-auto px-2 sm:px-4 py-1.5 sm:py-3 md:py-4 scrollbar-thin min-h-0">
                        {messages.map((msg, index) => (
                            <MessageBubble key={index} role={msg.role} content={msg.content} grounding={msg.grounding} />
                        ))}
                        {isLoading && (
                            <div className="flex w-full justify-start mb-4 sm:mb-6">
                                <div className="flex-shrink-0 mr-2 sm:mr-3 mt-1">
                                    <div className="w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-slate-800 flex items-center justify-center text-amber-400 border-2 border-amber-600">
                                        <Icon name="loader-2" size={16} className="sm:w-5 sm:h-5 animate-spin" />
                                    </div>
                                </div>
                                <div className="bg-white border border-stone-200 rounded-2xl rounded-bl-none px-4 sm:px-5 py-3 sm:py-4 shadow-md text-xs sm:text-sm text-stone-500">
                                    牧師正在查考經文...
                                </div>
                            </div>
                        )}
                        <div ref={messagesEndRef} />
                    </div>

                    {/* Input Area - 固定在底部，支援多行輸入（5行） */}
                    <div className="p-1.5 sm:p-2.5 md:p-4 bg-white border-t border-stone-200 shrink-0 safe-area-inset-bottom">
                        <form onSubmit={handleSend} className="relative flex items-end gap-1 sm:gap-2">
                            <div className="flex-1 relative">
                                <textarea
                                    value={input}
                                    onChange={(e) => setInput(e.target.value)}
                                    onKeyDown={(e) => {
                                        // 按 Enter 發送（Shift+Enter 換行）
                                        if (e.key === 'Enter' && !e.shiftKey) {
                                            e.preventDefault();
                                            handleSend(e);
                                        }
                                    }}
                                    placeholder="請輸入您的問題..."
                                    rows={5}
                                    className="w-full py-2 sm:py-2.5 md:py-3 pl-3 sm:pl-4 md:pl-5 pr-9 sm:pr-11 md:pr-14 rounded-2xl bg-stone-100 border border-stone-300 focus:border-amber-600 focus:ring-2 focus:ring-amber-100 outline-none transition-all text-sm sm:text-base resize-none overflow-y-auto max-h-40 sm:max-h-48 md:max-h-52 font-serif"
                                    disabled={isLoading}
                                    style={{ minHeight: '5rem', lineHeight: '1.5' }}
                                />
                            </div>
                            <button
                                type="submit"
                                disabled={!input.trim() || isLoading}
                                className={`p-2 sm:p-2.5 md:p-3 rounded-full shadow-md transition-all active:scale-95 shrink-0 mb-0.5 sm:mb-1 ${
                                    !input.trim() || isLoading
                                    ? 'bg-stone-200 text-stone-400'
                                    : 'bg-amber-700 hover:bg-amber-800 active:bg-amber-900 text-white'
                                }`}
                            >
                                <Icon name="send" size={16} className="sm:w-4 sm:h-4 md:w-5 md:h-5" />
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

