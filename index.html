<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>AI 牧師 - 你的隨身靈修導師</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React Framework -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* 固定整個頁面，防止滑動 */
        html {
            height: 100%;
            height: 100dvh;
            width: 100%;
            overflow: hidden;
            position: fixed;
            touch-action: none;
            overscroll-behavior: none;
            -webkit-overflow-scrolling: touch;
        }
        
        body { 
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; 
            background: linear-gradient(135deg, #f5f7fa 0%, #e8eef5 50%, #f0f4f8 100%);
            background-attachment: fixed;
            margin: 0;
            padding: 0;
            overflow: hidden;
            overflow-x: hidden;
            overflow-y: hidden;
            width: 100%;
            height: 100%;
            height: 100dvh;
            position: fixed;
            touch-action: pan-y;
            overscroll-behavior: none;
            -webkit-overflow-scrolling: touch;
            -webkit-user-select: none;
            user-select: none;
        }
        
        /* 防止文字選擇（可選，如果需要可以移除） */
        * {
            -webkit-tap-highlight-color: transparent;
        }
        
        /* 允許輸入框選擇文字 */
        input, textarea {
            -webkit-user-select: text;
            user-select: text;
        }
        .font-serif { font-family: 'Noto Serif TC', serif; }
        
        /* 優雅的滾動條設計 */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.02); border-radius: 10px; }
        ::-webkit-scrollbar-thumb { 
            background: linear-gradient(180deg, #cbd5e1 0%, #94a3b8 100%);
            border-radius: 10px;
            transition: background 0.3s ease;
        }
        ::-webkit-scrollbar-thumb:hover { 
            background: linear-gradient(180deg, #94a3b8 0%, #64748b 100%);
        }
        
        /* 動畫效果 */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        
        .message-enter {
            animation: fadeInUp 0.4s ease-out;
        }
        
        .button-press {
            animation: pulse 0.2s ease-out;
        }
        
        /* 響應式優化 */
        @media (max-width: 640px) {
            /* 手機優化 */
            body {
                font-size: 14px;
            }
            /* 確保在手機上所有關鍵元素都能顯示 */
            #root {
                height: 100vh;
                height: 100dvh; /* 使用動態視窗高度，考慮瀏覽器 UI */
                width: 100%;
                overflow: hidden;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
            }
            
            /* 固定 header 高度 - 進一步減少 */
            header {
                height: 38px !important;
                min-height: 38px !important;
                max-height: 38px !important;
                padding: 0.25rem 0.5rem !important;
            }
            
            /* Header 標題文字更小 */
            header h1 {
                font-size: 0.75rem !important;
                line-height: 1.2 !important;
            }
            
            /* 固定模式切換高度 - 進一步減少 */
            .mode-toggle-container {
                height: 36px !important;
                min-height: 36px !important;
                max-height: 36px !important;
                padding: 0.25rem !important;
            }
            
            /* 模式切換按鈕更小 */
            .mode-toggle-container button {
                padding: 0.25rem 0.5rem !important;
                font-size: 0.7rem !important;
            }
            
            /* 固定輸入區域高度 - 進一步減少 */
            .input-container {
                min-height: 60px !important;
                max-height: 60px !important;
                padding: 0.375rem !important;
            }
            
            /* 計算聊天區域高度：100vh - header(38px) - mode toggle(36px) - input(60px) */
            .chat-area {
                height: calc(100vh - 38px - 36px - 60px) !important;
                height: calc(100dvh - 38px - 36px - 60px) !important;
                min-height: 0 !important;
                overflow-y: auto !important;
            }
            
            /* 確保 textarea 在輸入容器內正確顯示 */
            .input-container textarea {
                max-height: 2.5rem !important;
                padding-top: 0.375rem !important;
                padding-bottom: 0.375rem !important;
                font-size: 0.8rem !important;
                line-height: 1.3 !important;
            }
            
            /* 確保主容器使用正確的高度 */
            .flex.flex-col.h-screen {
                height: 100vh !important;
                height: 100dvh !important;
                width: 100% !important;
                max-width: 100% !important;
                overflow: hidden !important;
                position: relative !important;
            }
            
            /* 防止水平滾動 */
            * {
                max-width: 100%;
                box-sizing: border-box;
            }
            
            /* 防止彈性滾動 */
            body, html {
                overscroll-behavior-y: none !important;
                overscroll-behavior-x: none !important;
                -webkit-overflow-scrolling: touch;
            }
        }
        
        @media (min-width: 641px) and (max-width: 1024px) {
            /* 平板優化 */
            body {
                font-size: 15px;
            }
        }
        
        @media (min-width: 1025px) {
            /* 桌面優化 */
            body {
                font-size: 16px;
            }
        }
        
        /* 觸控設備優化 */
        @media (hover: none) and (pointer: coarse) {
            button, a {
                min-height: 44px;
                min-width: 44px;
            }
        }
        
        /* 確保 flexbox 容器正確處理高度 */
        .flex-col {
            display: flex;
            flex-direction: column;
        }
        
        /* 防止內容溢出 */
        .overflow-hidden {
            overflow: hidden;
        }
        
        .min-h-0 {
            min-height: 0;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // =========================================================================
        // 設定區域 (Configuration)
        // =========================================================================
        // 使用後端代理 API（API Key 安全保護在伺服器端）
        // 在 Vercel 上，使用相對路徑自動指向同域的 API
        // 本地開發時，可以設定 API_BASE_URL 指向本地伺服器
        const API_BASE_URL = window.API_BASE_URL || ''; // 例如: 'http://localhost:3000' 或留空使用相對路徑（Vercel）
        const GOOGLE_API_KEY = window.GOOGLE_API_KEY || null; // 僅用於本地開發，不建議公開使用

        // =========================================================================
        // 系統邏輯開始
        // =========================================================================

        const { useState, useEffect, useRef } = React;
        
        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => { lucide.createIcons(); }, [name]);
            return <i data-lucide={name} className={className} style={{ width: size, height: size, display: 'inline-block' }}></i>;
        };

        const SYSTEM_PROMPT_BIBLE_ONLY = `
You are a wise, loving, and learned Christian AI Pastor.
Your task is to provide spiritual guidance and answers based on the user's questions.

**IMPORTANT: You can answer ANY type of question, including:**
- Personal life problems (relationships, work, family, finances, health, etc.)
- Spiritual questions and biblical interpretation
- Ethical dilemmas and moral questions
- Life decisions and guidance
- Emotional struggles and challenges
- Any question where the user seeks biblical wisdom

**Strict Rules:**

1. **Sola Scriptura:** Your answers must be *completely* based on the Old Testament and New Testament. Do not cite external secular views unless they fully align with biblical truth.

2. **Citation Required:** Every point or answer you make *must* cite specific Bible verses. Format example: (John 3:16) or (Genesis 1:1).

3. **Explanation and Application:** After citing verses, explain how the verse answers the user's question. For personal life problems, show how biblical principles apply to their specific situation.

4. **Active Guidance and Questioning (CRITICAL):** You MUST actively guide users to express their problems more clearly. Don't just answer the surface question - dig deeper to understand their real concerns.
   - Ask follow-up questions to clarify: "能多告訴我一些細節嗎？" or "What specific situation are you facing?"
   - Probe gently: "聽起來你可能有更深層的困擾，願意多分享一些嗎？" or "It sounds like there might be more to this. Can you tell me more?"
   - Show genuine interest: "我想更了解你的情況，這樣才能給你最適合的建議。" or "I'd like to understand your situation better so I can give you the most helpful guidance."
   - Guide users to express emotions: "你現在的感受是什麼？" or "How are you feeling about this?"
   - Help identify root causes: "你覺得這個問題的根本原因是什麼？" or "What do you think is the root cause of this issue?"
   - Be like a caring friend who wants to truly understand, not just give quick answers.

5. **Tone (CRITICAL):** Respond in a relaxed, friendly, and humorous way, like chatting with a close friend. Be warm, approachable, and conversational. Use natural language, occasional light humor (when appropriate), and make the conversation feel like you're talking to a friend over coffee. Avoid being overly formal, preachy, or academic. Be genuine, relatable, and easy-going while still being respectful and encouraging.

5. **Language Matching (CRITICAL):** You MUST respond in the EXACT same language as the user's question. This is MANDATORY and non-negotiable.
   - If the user asks in English, you MUST respond entirely in English.
   - If the user asks in Chinese (Traditional or Simplified), you MUST respond entirely in Traditional Chinese.
   - If the user asks in Japanese, you MUST respond entirely in Japanese.
   - If the user asks in Korean, you MUST respond entirely in Korean.
   - If the user asks in Spanish, you MUST respond entirely in Spanish.
   - If the user asks in French, you MUST respond entirely in French.
   - If the user asks in any other language, you MUST respond in that same language.
   - DO NOT mix languages. DO NOT translate the user's question to another language. Use the EXACT language the user used.

6. **Version:** Default to CUV (Chinese Union Version) wording for Chinese responses.
`;

        const SYSTEM_PROMPT_WEB_SEARCH = `
You are a wise, up-to-date Christian AI Pastor.
Your task is to answer the user's questions, combining biblical truth with broad knowledge.

**IMPORTANT: You can answer ANY type of question, including:**
- Personal life problems (relationships, work, family, finances, health, etc.)
- Spiritual questions and biblical interpretation
- Ethical dilemmas and moral questions
- Life decisions and guidance
- Emotional struggles and challenges
- Any question where the user seeks biblical wisdom combined with practical resources

**Rules:**

1. **Core Foundation:** Your answers must be rooted in the Old Testament and New Testament.

2. **Scripture Citation:** When you mention biblical principles, *must* cite specific chapters and verses (book chapter:verse).

3. **Broad Knowledge:** You can use search tools to find historical background, original Greek/Hebrew analysis, views of famous theologians, modern social data, Christian counseling resources, and practical advice from Christian sources to enrich your answers.

4. **Analysis:** Compare and analyze information from the web with biblical truth. For personal life problems, combine biblical principles with practical Christian resources and guidance.

5. **Active Guidance and Questioning (CRITICAL):** You MUST actively guide users to express their problems more clearly. Don't just answer the surface question - dig deeper to understand their real concerns.
   - Ask follow-up questions to clarify: "能多告訴我一些細節嗎？" or "What specific situation are you facing?"
   - Probe gently: "聽起來你可能有更深層的困擾，願意多分享一些嗎？" or "It sounds like there might be more to this. Can you tell me more?"
   - Show genuine interest: "我想更了解你的情況，這樣才能給你最適合的建議。" or "I'd like to understand your situation better so I can give you the most helpful guidance."
   - Guide users to express emotions: "你現在的感受是什麼？" or "How are you feeling about this?"
   - Help identify root causes: "你覺得這個問題的根本原因是什麼？" or "What do you think is the root cause of this issue?"
   - Be like a caring friend who wants to truly understand, not just give quick answers.

6. **Tone (CRITICAL):** Respond in a relaxed, friendly, and humorous way, like chatting with a close friend. Be warm, approachable, and conversational. Use natural language, occasional light humor (when appropriate), and make the conversation feel like you're talking to a friend over coffee. Avoid being overly formal, preachy, or academic. Be genuine, relatable, and easy-going while still being respectful, insightful, and encouraging.

6. **Language Matching (CRITICAL):** You MUST respond in the EXACT same language as the user's question. This is MANDATORY and non-negotiable.
   - If the user asks in English, you MUST respond entirely in English.
   - If the user asks in Chinese (Traditional or Simplified), you MUST respond entirely in Traditional Chinese.
   - If the user asks in Japanese, you MUST respond entirely in Japanese.
   - If the user asks in Korean, you MUST respond entirely in Korean.
   - If the user asks in Spanish, you MUST respond entirely in Spanish.
   - If the user asks in French, you MUST respond entirely in French.
   - If the user asks in any other language, you MUST respond in that same language.
   - DO NOT mix languages. DO NOT translate the user's question to another language. Use the EXACT language the user used.
   - All citations, explanations, and disclaimers MUST be in the same language as the user's question.
`;

        const callGeminiAPI = async (prompt, history, mode) => {
            // 優先使用後端代理 API（安全）
            // 如果設定了 API_BASE_URL，使用它；否則使用相對路徑（適用於 Vercel）
            const apiUrl = API_BASE_URL ? `${API_BASE_URL}/api/chat` : '/api/chat';
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt, history, mode })
                });

                if (!response.ok) {
                    const errData = await response.json().catch(() => ({}));
                    throw new Error(errData.error || `伺服器錯誤: ${response.status}`);
                }

                const data = await response.json();
                return { text: data.text, grounding: data.grounding || [] };
            } catch (error) {
                // 如果後端 API 失敗且沒有設定 API_BASE_URL，嘗試降級到直接 API 調用
                if (!API_BASE_URL && GOOGLE_API_KEY) {
                    console.warn('後端 API 失敗，嘗試直接調用...');
                    // 繼續執行下面的直接 API 調用邏輯
                } else {
                    throw new Error(`後端 API 錯誤: ${error.message}`);
                }
            }

            // 降級方案：直接呼叫 Google API（僅用於本地開發，不建議公開）
            if (!GOOGLE_API_KEY || GOOGLE_API_KEY.includes("在此處貼上") || GOOGLE_API_KEY.trim() === "") {
                throw new Error("API Key 未設定。請使用後端伺服器（推薦）或在環境變數中設定 GOOGLE_API_KEY（僅本地開發用）。");
            }

            const isBibleOnly = mode === 'bible-only';
            const systemInstruction = isBibleOnly ? SYSTEM_PROMPT_BIBLE_ONLY : SYSTEM_PROMPT_WEB_SEARCH;
            
            const contents = [
                ...history.map(msg => ({
                    role: msg.role === 'user' ? 'user' : 'model',
                    parts: [{ text: msg.content }]
                })),
                { role: 'user', parts: [{ text: prompt }] }
            ];

            const payload = {
                contents: contents,
                systemInstruction: { parts: [{ text: systemInstruction }] },
                generationConfig: { 
                    temperature: 0.7, 
                    maxOutputTokens: 2000,
                    topP: 0.95,
                    topK: 40
                }
            };

            if (!isBibleOnly) {
                // 注意：googleSearchRetrieval 已被棄用，但前端降級方案暫時不使用搜索工具
                // 因為搜索工具需要在後端配置
                // payload.tools = [{ googleSearchRetrieval: {} }]; // 已棄用
                console.log('Web search mode: Using model knowledge without external search tool (fallback mode)');
            }

            const response = await fetch(
                `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GOOGLE_API_KEY}`,
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                }
            );

            if (!response.ok) {
                const errData = await response.json().catch(() => ({}));
                const errorMessage = errData.error?.message || `API Error: ${response.status}`;
                
                if (response.status === 401) {
                    throw new Error("API Key 無效或已過期，請檢查您的 Google API Key 設定。");
                } else if (response.status === 429) {
                    throw new Error("API 請求過於頻繁，請稍後再試。");
                } else if (response.status === 400) {
                    throw new Error(`請求格式錯誤：${errorMessage}`);
                }
                
                throw new Error(errorMessage);
            }

            const data = await response.json();
            let text = data.candidates?.[0]?.content?.parts?.[0]?.text || "牧師正在默想中...(無法生成回應)";
            
            const grounding = data.candidates?.[0]?.groundingMetadata?.groundingAttributions?.map(
                a => ({ uri: a.web?.uri, title: a.web?.title })
            ).filter(a => a.uri) || [];

            return { text, grounding };
        };

        const MessageBubble = ({ role, content, grounding }) => {
            const isUser = role === 'user';
            
            const formatText = (text) => {
                if (!text) return "";
                return text.split('\n').map((line, i) => (
                    <React.Fragment key={i}>
                        {line.split(/(\*\*.*?\*\*)/).map((part, j) => {
                            if (part.startsWith('**') && part.endsWith('**')) {
                                return <strong key={j} className={`font-bold ${isUser ? 'text-amber-50' : 'text-amber-700'}`}>{part.slice(2, -2)}</strong>;
                            }
                            // 匹配聖經章節引用（支援多種格式）
                            const bibleRegex = /([^\s\uff08\(\[]+[\u4e00-\u9fa5]+\s?\d+[:：]\d+)/g;
                            const parts = part.split(bibleRegex);
                            if (parts.length > 1) {
                                return parts.map((p, k) => {
                                    if (p.match(bibleRegex)) {
                                        return <span key={k} className={`font-semibold px-2 py-0.5 rounded-md mx-1 ${
                                            isUser 
                                                ? 'bg-amber-600/30 text-amber-100 border border-amber-400/30' 
                                                : 'text-blue-700 bg-blue-50 border border-blue-200'
                                        }`}>{p}</span>;
                                    }
                                    return p;
                                });
                            }
                            return part;
                        })}
                        <br />
                    </React.Fragment>
                ));
            };

            return (
                <div className={`flex w-full mb-6 message-enter ${isUser ? 'justify-end' : 'justify-start'}`}>
                    {!isUser && (
                        <div className="flex-shrink-0 mr-2 sm:mr-3 mt-1">
                            <div className="w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-gradient-to-br from-slate-800 to-slate-900 flex items-center justify-center text-amber-400 shadow-lg border-2 border-amber-500/50 ring-2 ring-amber-500/20">
                                <Icon name="cross" size={16} className="sm:w-5 sm:h-5" />
                            </div>
                        </div>
                    )}
                    
                    <div className={`max-w-[90%] sm:max-w-[85%] md:max-w-[75%] rounded-3xl px-4 sm:px-5 md:px-6 py-3.5 sm:py-4 md:py-5 ${
                        isUser 
                        ? 'bg-gradient-to-br from-amber-600 via-amber-700 to-amber-800 text-white rounded-br-md shadow-lg shadow-amber-900/30' 
                        : 'bg-white text-slate-800 border border-stone-200/80 rounded-bl-md shadow-lg shadow-stone-200/50 backdrop-blur-sm'
                    }`}>
                        <div className={`text-xs sm:text-sm md:text-base leading-relaxed font-serif ${!isUser ? 'text-justify' : ''}`}>
                            {formatText(content)}
                        </div>

                        {!isUser && grounding && grounding.length > 0 && (
                            <div className="mt-3 sm:mt-4 pt-3 sm:pt-4 border-t border-stone-100 text-xs text-stone-500">
                                <div className="flex items-center mb-2 sm:mb-2.5 font-semibold text-stone-600">
                                    <Icon name="globe" size={12} className="mr-1.5 text-blue-600" />
                                    <span className="text-xs sm:text-sm">參考資料來源：</span>
                                </div>
                                <div className="flex flex-wrap gap-2 sm:gap-2.5">
                                    {grounding.slice(0, 3).map((source, idx) => (
                                        <a 
                                            key={idx} 
                                            href={source.uri} 
                                            target="_blank" 
                                            rel="noopener noreferrer"
                                            className="bg-gradient-to-r from-stone-50 to-stone-100 hover:from-stone-100 hover:to-stone-200 active:from-stone-200 active:to-stone-300 text-stone-700 px-3 py-1.5 rounded-lg transition-all duration-200 truncate max-w-[150px] sm:max-w-[200px] text-xs border border-stone-200/50 shadow-sm hover:shadow-md"
                                        >
                                            {source.title || "Web Source"}
                                        </a>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const App = () => {
            // 從 localStorage 載入歷史對話
            const loadHistory = () => {
                try {
                    const saved = localStorage.getItem('ai-pastor-history');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        // 只保留最近 20 條訊息以避免過大
                        return parsed.slice(-20);
                    }
                } catch (e) {
                    console.warn('無法載入歷史記錄', e);
                }
                return [
                    { role: 'model', content: '願主與你同在。我是你的 AI 牧師。無論你心中有什麼疑問，或想尋求聖經的真理，都請告訴我。\n\n你可以選擇僅用聖經回答，或是結合歷史與網路資料。請問今天有什麼可以幫助你的？' }
                ];
            };

            const [messages, setMessages] = useState(loadHistory);
            const [input, setInput] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [mode, setMode] = useState('bible-only');
            const messagesEndRef = useRef(null);

            useEffect(() => {
                lucide.createIcons();
            }, []);

            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
                lucide.createIcons();
            }, [messages, isLoading]);

            // 保存對話歷史到 localStorage
            useEffect(() => {
                try {
                    localStorage.setItem('ai-pastor-history', JSON.stringify(messages));
                } catch (e) {
                    console.warn('無法保存歷史記錄', e);
                }
            }, [messages]);

            const handleSend = async (e) => {
                if (e && e.preventDefault) {
                    e.preventDefault();
                }
                if (!input.trim() || isLoading) return;

                const userMessage = input.trim();
                setInput('');
                setIsLoading(true);

                const newMessages = [...messages, { role: 'user', content: userMessage }];
                setMessages(newMessages);

                try {
                    const { text, grounding } = await callGeminiAPI(userMessage, messages, mode);
                    setMessages(prev => [...prev, { role: 'model', content: text, grounding }]);
                } catch (error) {
                    const errorMessage = error.message || '發生未知錯誤';
                    setMessages(prev => [...prev, { 
                        role: 'model', 
                        content: `抱歉，在處理您的問題時遇到困難：\n\n**${errorMessage}**\n\n請稍後再試，或檢查 API Key 設定是否正確。` 
                    }]);
                } finally {
                    setIsLoading(false);
                }
            };

            const clearHistory = () => {
                if (window.confirm('確定要清除所有對話記錄嗎？')) {
                    localStorage.removeItem('ai-pastor-history');
                    setMessages([
                        { role: 'model', content: '願主與你同在。我是你的 AI 牧師。無論你心中有什麼疑問，或想尋求聖經的真理，都請告訴我。\n\n你可以選擇僅用聖經回答，或是結合歷史與網路資料。請問今天有什麼可以幫助你的？' }
                    ]);
                }
            };

            return (
                <div className="flex flex-col h-screen w-full max-w-4xl mx-auto shadow-2xl bg-gradient-to-b from-white via-[#faf9f6] to-[#f5f7fa] overflow-hidden" style={{ width: '100%', maxWidth: '100%', position: 'relative', overflow: 'hidden' }}>
                    {/* Header - 極致緊湊的設計，確保模式切換和輸入框可見 */}
                    <header className="bg-gradient-to-r from-slate-900 via-slate-800 to-slate-900 text-amber-50 px-2 sm:px-4 py-0.5 sm:py-1.5 shadow-lg shadow-slate-900/20 flex items-center justify-between z-10 shrink-0 border-b border-amber-500/20" style={{ height: '38px', minHeight: '38px', maxHeight: '38px' }}>
                        <div className="flex items-center gap-1 sm:gap-2 min-w-0 flex-1">
                            <div className="bg-gradient-to-br from-amber-500 to-amber-600 p-0.5 sm:p-1 rounded-lg shrink-0 shadow-md shadow-amber-600/30">
                                <Icon name="cross" size={12} className="sm:w-4 sm:h-4 text-white" />
                            </div>
                            <div className="min-w-0">
                                <h1 className="text-xs sm:text-base md:text-xl font-bold tracking-wide font-serif truncate bg-gradient-to-r from-amber-50 to-amber-100 bg-clip-text text-transparent">AI 牧師</h1>
                                <p className="text-xs text-amber-200/80 hidden sm:block">你的隨身靈修導師</p>
                            </div>
                        </div>
                        <div className="flex items-center gap-1 sm:gap-2 shrink-0">
                            <span className="text-[10px] sm:text-xs text-amber-200/70 whitespace-nowrap">按這裡清除所有對話紀錄</span>
                            <button
                                onClick={clearHistory}
                                className="text-xs sm:text-sm text-amber-200/80 hover:text-amber-100 transition-all duration-200 px-1 sm:px-1.5 py-0.5 rounded-lg hover:bg-amber-800/40 active:bg-amber-800/60 active:scale-95 shrink-0 hover:shadow-md"
                                title="清除對話記錄"
                            >
                                <Icon name="trash-2" size={12} className="sm:w-3.5 sm:h-3.5" />
                            </button>
                            <div className="text-xs text-slate-400/80 hidden sm:block">訪客模式</div>
                        </div>
                    </header>

                    {/* Mode Toggle - 極致緊湊的設計，確保與輸入框同時可見 */}
                    <div className="mode-toggle-container bg-gradient-to-b from-stone-50 to-stone-100 p-0.5 sm:p-1.5 border-b border-stone-200/80 flex justify-center shrink-0 shadow-sm" style={{ height: '36px', minHeight: '36px', maxHeight: '36px' }}>
                         <div className="flex bg-stone-200/60 backdrop-blur-sm p-0.5 sm:p-1 rounded-xl w-full max-w-md shadow-inner">
                            <button
                                onClick={() => setMode('bible-only')}
                                className={`flex-1 flex items-center justify-center px-1 sm:px-2 md:px-4 py-0.5 sm:py-1 md:py-2 rounded-lg text-[10px] sm:text-xs md:text-sm font-medium transition-all duration-200 active:scale-95 ${
                                    mode === 'bible-only' 
                                        ? 'bg-gradient-to-r from-amber-50 to-amber-100 text-amber-800 shadow-md shadow-amber-200/50 border border-amber-300/50' 
                                        : 'text-stone-500 hover:text-stone-700 hover:bg-stone-100/50'
                                }`}
                            >
                                <Icon name="book-open" size={10} className="sm:w-3.5 sm:h-3.5 mr-0.5 sm:mr-1" /> 
                                <span className="whitespace-nowrap text-[10px] sm:text-xs md:text-sm">唯獨聖經</span>
                            </button>
                            <button
                                onClick={() => setMode('bible-plus')}
                                className={`flex-1 flex items-center justify-center px-1 sm:px-2 md:px-4 py-0.5 sm:py-1 md:py-2 rounded-lg text-[10px] sm:text-xs md:text-sm font-medium transition-all duration-200 active:scale-95 ${
                                    mode === 'bible-plus' 
                                        ? 'bg-gradient-to-r from-blue-50 to-blue-100 text-blue-700 shadow-md shadow-blue-200/50 border border-blue-300/50' 
                                        : 'text-stone-500 hover:text-stone-700 hover:bg-stone-100/50'
                                }`}
                            >
                                <Icon name="globe" size={10} className="sm:w-3.5 sm:h-3.5 mr-0.5 sm:mr-1" /> 
                                <span className="whitespace-nowrap text-[10px] sm:text-xs md:text-sm">聖經+網路</span>
                            </button>
                        </div>
                    </div>

                    {/* Chat Area - 使用 flex-1 確保佔用剩餘空間，不擠壓固定元素 */}
                    <div className="chat-area flex-1 overflow-y-auto px-2 sm:px-4 py-1 sm:py-2 md:py-4 scrollbar-thin min-h-0">
                        {messages.map((msg, index) => (
                            <MessageBubble key={index} role={msg.role} content={msg.content} grounding={msg.grounding} />
                        ))}
                        {isLoading && (
                            <div className="flex w-full justify-start mb-4 sm:mb-6 message-enter">
                                <div className="flex-shrink-0 mr-2 sm:mr-3 mt-1">
                                    <div className="w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-gradient-to-br from-slate-800 to-slate-900 flex items-center justify-center text-amber-400 border-2 border-amber-500/50 ring-2 ring-amber-500/20 shadow-lg">
                                        <Icon name="loader-2" size={16} className="sm:w-5 sm:h-5 animate-spin" />
                                    </div>
                                </div>
                                <div className="bg-gradient-to-br from-white to-stone-50 border border-stone-200/80 rounded-3xl rounded-bl-md px-4 sm:px-5 py-3 sm:py-4 shadow-lg shadow-stone-200/50 backdrop-blur-sm text-xs sm:text-sm text-stone-600">
                                    <span className="inline-flex items-center gap-2">
                                        <span className="animate-pulse">牧師正在查考經文</span>
                                        <span className="flex gap-1">
                                            <span className="w-1 h-1 bg-amber-500 rounded-full animate-bounce" style={{ animationDelay: '0ms' }}></span>
                                            <span className="w-1 h-1 bg-amber-500 rounded-full animate-bounce" style={{ animationDelay: '150ms' }}></span>
                                            <span className="w-1 h-1 bg-amber-500 rounded-full animate-bounce" style={{ animationDelay: '300ms' }}></span>
                                        </span>
                                    </span>
                                </div>
                            </div>
                        )}
                        <div ref={messagesEndRef} />
                    </div>

                    {/* Input Area - 固定在底部，支援多行輸入（3行） */}
                    <div className="input-container bg-gradient-to-t from-white via-white to-stone-50 border-t border-stone-200/80 shrink-0 safe-area-inset-bottom shadow-lg shadow-stone-200/30" style={{ minHeight: '60px', maxHeight: '60px', padding: '0.375rem' }}>
                        <form onSubmit={handleSend} className="relative flex items-end gap-1 sm:gap-2">
                            <div className="flex-1 relative">
                                <textarea
                                    value={input}
                                    onChange={(e) => setInput(e.target.value)}
                                    onKeyDown={(e) => {
                                        // 按 Enter 發送（Shift+Enter 換行）
                                        if (e.key === 'Enter' && !e.shiftKey) {
                                            e.preventDefault();
                                            handleSend(e);
                                        }
                                    }}
                                    placeholder="請輸入您的問題..."
                                    rows={3}
                                    className="w-full py-1 sm:py-1.5 md:py-3 pl-2 sm:pl-4 md:pl-5 pr-8 sm:pr-11 md:pr-14 rounded-2xl bg-gradient-to-br from-stone-50 to-stone-100 border border-stone-300/80 focus:border-amber-500 focus:ring-2 focus:ring-amber-200/50 outline-none transition-all duration-200 resize-none overflow-y-auto font-serif shadow-inner placeholder:text-stone-400"
                                    disabled={isLoading}
                                    style={{ 
                                        minHeight: '2.25rem', 
                                        maxHeight: '2.5rem',
                                        lineHeight: '1.3',
                                        fontSize: '0.8rem'
                                    }}
                                />
                            </div>
                            <button
                                type="submit"
                                disabled={!input.trim() || isLoading}
                                className={`p-2 sm:p-2.5 md:p-3 rounded-full shadow-lg transition-all duration-200 active:scale-90 shrink-0 mb-0.5 sm:mb-1 ${
                                    !input.trim() || isLoading
                                    ? 'bg-gradient-to-br from-stone-200 to-stone-300 text-stone-400 cursor-not-allowed'
                                    : 'bg-gradient-to-br from-amber-600 via-amber-700 to-amber-800 hover:from-amber-700 hover:via-amber-800 hover:to-amber-900 active:from-amber-800 active:via-amber-900 active:to-amber-950 text-white shadow-amber-900/30 hover:shadow-xl hover:shadow-amber-900/40 hover:scale-105'
                                }`}
                            >
                                <Icon name="send" size={16} className="sm:w-4 sm:h-4 md:w-5 md:h-5" />
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

