<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>AI Pastor - Your Spiritual Companion</title>
    
    <!-- Meta Tags for Social Media Preview (WhatsApp, Facebook, etc.) -->
    <meta name="description" content="AI Pastor - An AI-powered spiritual companion to help you explore biblical truths, deepen your faith, and find guidance through Scripture. Available in English, Traditional Chinese, and Simplified Chinese.">
    
    <!-- Open Graph / Facebook / WhatsApp -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://ai-pastor.vercel.app">
    <meta property="og:title" content="AI Pastor - Your Spiritual Companion">
    <meta property="og:description" content="AI Pastor - An AI-powered spiritual companion to help you explore biblical truths, deepen your faith, and find guidance through Scripture. Available in English, Traditional Chinese, and Simplified Chinese.">
    <meta property="og:image" content="https://ai-pastor.vercel.app/og-image.png">
    <meta property="og:locale" content="en_US">
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://ai-pastor.vercel.app">
    <meta name="twitter:title" content="AI Pastor - Your Spiritual Companion">
    <meta name="twitter:description" content="AI Pastor - An AI-powered spiritual companion to help you explore biblical truths, deepen your faith, and find guidance through Scripture.">
    <meta name="twitter:image" content="https://ai-pastor.vercel.app/og-image.png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React Framework -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Three.js for 3D rendering -->
    <script src="https://unpkg.com/three@0.160.0/build/three.min.js" 
            onload="console.log('âœ… Three.js è¼‰å…¥æˆåŠŸ'); window.THREE_LOADED = true; if(window.THREE) window.dispatchEvent(new Event('threejsloaded'));" 
            onerror="console.error('âŒ Three.js è¼‰å…¥å¤±æ•—'); window.THREE_LOADED = false;"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* å›ºå®šæ•´å€‹é é¢ï¼Œé˜²æ­¢æ»‘å‹• */
        html {
            height: 100%;
            height: 100dvh;
            width: 100%;
            overflow: hidden;
            position: fixed;
            touch-action: none;
            overscroll-behavior: none;
            -webkit-overflow-scrolling: touch;
        }
        
        body { 
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; 
            background: linear-gradient(135deg, #0a0a1a 0%, #1a0a1a 50%, #0a1a0a 100%);
            background-attachment: fixed;
            margin: 0;
            padding: 0;
            overflow: hidden;
            overflow-x: hidden;
            overflow-y: hidden;
            width: 100%;
            height: 100%;
            height: 100dvh;
            position: fixed;
            touch-action: pan-y;
            overscroll-behavior: none;
            -webkit-overflow-scrolling: touch;
            -webkit-user-select: none;
            user-select: none;
        }
        
        /* é˜²æ­¢æ–‡å­—é¸æ“‡ï¼ˆå¯é¸ï¼Œå¦‚æœéœ€è¦å¯ä»¥ç§»é™¤ï¼‰ */
        * {
            -webkit-tap-highlight-color: transparent;
        }
        
        /* å…è¨±è¼¸å…¥æ¡†é¸æ“‡æ–‡å­— */
        input, textarea {
            -webkit-user-select: text;
            user-select: text;
        }
        .font-serif { font-family: 'Noto Serif TC', serif; }
        
        /* å„ªé›…çš„æ»¾å‹•æ¢è¨­è¨ˆ */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.02); border-radius: 10px; }
        ::-webkit-scrollbar-thumb { 
            background: linear-gradient(180deg, #cbd5e1 0%, #94a3b8 100%);
            border-radius: 10px;
            transition: background 0.3s ease;
        }
        ::-webkit-scrollbar-thumb:hover { 
            background: linear-gradient(180deg, #94a3b8 0%, #64748b 100%);
        }
        
        /* å‹•ç•«æ•ˆæœ */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        
        .message-enter {
            animation: fadeInUp 0.4s ease-out;
        }
        
        .button-press {
            animation: pulse 0.2s ease-out;
        }
        
        /* éŸ¿æ‡‰å¼å„ªåŒ– */
        @media (max-width: 640px) {
            /* æ‰‹æ©Ÿå„ªåŒ– */
            body {
                font-size: 14px;
            }
            /* ç¢ºä¿åœ¨æ‰‹æ©Ÿä¸Šæ‰€æœ‰é—œéµå…ƒç´ éƒ½èƒ½é¡¯ç¤º */
            #root {
                height: 100vh;
                height: 100dvh; /* ä½¿ç”¨å‹•æ…‹è¦–çª—é«˜åº¦ï¼Œè€ƒæ…®ç€è¦½å™¨ UI */
                width: 100%;
                overflow: hidden;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
            }
            
            /* å›ºå®š header é«˜åº¦ - é€²ä¸€æ­¥æ¸›å°‘ */
            header {
                height: 38px !important;
                min-height: 38px !important;
                max-height: 38px !important;
                padding: 0.25rem 0.5rem !important;
            }
            
            /* Header æ¨™é¡Œæ–‡å­—æ›´å° */
            header h1 {
                font-size: 0.75rem !important;
                line-height: 1.2 !important;
            }
            
            /* å›ºå®šæ¨¡å¼åˆ‡æ›é«˜åº¦ - é€²ä¸€æ­¥æ¸›å°‘ */
            .mode-toggle-container {
                height: 36px !important;
                min-height: 36px !important;
                max-height: 36px !important;
                padding: 0.25rem !important;
            }
            
            /* æ¨¡å¼åˆ‡æ›æŒ‰éˆ•æ›´å° */
            .mode-toggle-container button {
                padding: 0.25rem 0.5rem !important;
                font-size: 0.7rem !important;
            }
            
            /* å›ºå®šè¼¸å…¥å€åŸŸé«˜åº¦ - é€²ä¸€æ­¥æ¸›å°‘ */
            .input-container {
                min-height: 60px !important;
                max-height: 60px !important;
                padding: 0.375rem !important;
            }
            
            /* è¨ˆç®—èŠå¤©å€åŸŸé«˜åº¦ï¼š100vh - header(38px) - mode toggle(36px) - input(60px) */
            .chat-area {
                height: calc(100vh - 38px - 36px - 60px) !important;
                height: calc(100dvh - 38px - 36px - 60px) !important;
                min-height: 0 !important;
                overflow-y: auto !important;
            }
            
            /* ç¢ºä¿ textarea åœ¨è¼¸å…¥å®¹å™¨å…§æ­£ç¢ºé¡¯ç¤º */
            .input-container textarea {
                max-height: 2.5rem !important;
                padding-top: 0.375rem !important;
                padding-bottom: 0.375rem !important;
                font-size: 0.8rem !important;
                line-height: 1.3 !important;
            }
            
            /* ç¢ºä¿ä¸»å®¹å™¨ä½¿ç”¨æ­£ç¢ºçš„é«˜åº¦ */
            .flex.flex-col.h-screen {
                height: 100vh !important;
                height: 100dvh !important;
                width: 100% !important;
                max-width: 100% !important;
                overflow: hidden !important;
                position: relative !important;
            }
            
            /* é˜²æ­¢æ°´å¹³æ»¾å‹• */
            * {
                max-width: 100%;
                box-sizing: border-box;
            }
            
            /* é˜²æ­¢å½ˆæ€§æ»¾å‹• */
            body, html {
                overscroll-behavior-y: none !important;
                overscroll-behavior-x: none !important;
                -webkit-overflow-scrolling: touch;
            }
        }
        
        @media (min-width: 641px) and (max-width: 1024px) {
            /* å¹³æ¿å„ªåŒ– */
            body {
                font-size: 15px;
            }
        }
        
        @media (min-width: 1025px) {
            /* æ¡Œé¢å„ªåŒ– */
            body {
                font-size: 16px;
            }
        }
        
        /* è§¸æ§è¨­å‚™å„ªåŒ– */
        @media (hover: none) and (pointer: coarse) {
            button, a {
                min-height: 44px;
                min-width: 44px;
            }
        }
        
        /* ç¢ºä¿ flexbox å®¹å™¨æ­£ç¢ºè™•ç†é«˜åº¦ */
        .flex-col {
            display: flex;
            flex-direction: column;
        }
        
        /* é˜²æ­¢å…§å®¹æº¢å‡º */
        .overflow-hidden {
            overflow: hidden;
        }
        
        .min-h-0 {
            min-height: 0;
        }
        
        /* 3D æœªä¾†æ„Ÿæ¨£å¼ */
        .futuristic-glow {
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.3),
                        0 0 40px rgba(251, 191, 36, 0.2),
                        0 0 60px rgba(251, 191, 36, 0.1);
        }
        
        .futuristic-border {
            border: 1px solid rgba(251, 191, 36, 0.3);
            box-shadow: inset 0 0 10px rgba(251, 191, 36, 0.1);
        }
        
        .message-3d {
            transform-style: preserve-3d;
            transition: transform 0.3s ease;
        }
        
        .message-3d:hover {
            transform: translateZ(10px) scale(1.02);
        }
        
        /* 3D Canvas å®¹å™¨ */
        .canvas-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
        }
        
        /* ç™¼å…‰å‹•ç•« */
        @keyframes glow-pulse {
            0%, 100% {
                opacity: 0.5;
                filter: brightness(1);
            }
            50% {
                opacity: 1;
                filter: brightness(1.5);
            }
        }
        
        .glow-animate {
            animation: glow-pulse 3s ease-in-out infinite;
        }
        
        /* 3D æ–‡å­—æ•ˆæœ */
        .text-3d {
            text-shadow: 0 0 10px rgba(251, 191, 36, 0.5),
                         0 0 20px rgba(251, 191, 36, 0.3),
                         0 0 30px rgba(251, 191, 36, 0.2);
        }
        
        /* æ–‡å­—æƒå…‰æ•ˆæœï¼ˆæŒ‰ç…§æ‚¨æä¾›çš„ä»£ç¢¼ï¼‰ */
        @keyframes shine {
            to { background-position: 200% center; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // =========================================================================
        // è¨­å®šå€åŸŸ (Configuration)
        // =========================================================================
        // ä½¿ç”¨å¾Œç«¯ä»£ç† APIï¼ˆAPI Key å®‰å…¨ä¿è­·åœ¨ä¼ºæœå™¨ç«¯ï¼‰
        // åœ¨ Vercel ä¸Šï¼Œä½¿ç”¨ç›¸å°è·¯å¾‘è‡ªå‹•æŒ‡å‘åŒåŸŸçš„ API
        // æœ¬åœ°é–‹ç™¼æ™‚ï¼Œå¯ä»¥è¨­å®š API_BASE_URL æŒ‡å‘æœ¬åœ°ä¼ºæœå™¨
        const API_BASE_URL = window.API_BASE_URL || 'https://ai-pastor-ealr.onrender.com'; // Render å¾Œç«¯ URL
        const GOOGLE_API_KEY = window.GOOGLE_API_KEY || null; // åƒ…ç”¨æ–¼æœ¬åœ°é–‹ç™¼ï¼Œä¸å»ºè­°å…¬é–‹ä½¿ç”¨

        // =========================================================================
        // ç³»çµ±é‚è¼¯é–‹å§‹
        // =========================================================================

        const { useState, useEffect, useRef } = React;
        const THREE = window.THREE;
        
        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => { lucide.createIcons(); }, [name]);
            return <i data-lucide={name} className={className} style={{ width: size, height: size, display: 'inline-block' }}></i>;
        };

        // =========================================================================
        // 2D ç²’å­è–èª•æ¨¹èƒŒæ™¯ï¼ˆå‚™ç”¨æ–¹æ¡ˆï¼Œç¢ºä¿åœ¨æ‰€æœ‰è¨­å‚™ä¸Šéƒ½èƒ½é¡¯ç¤ºï¼‰
        // =========================================================================
        const ChristmasBackground2D = ({ containerRef }) => {
            const canvasRef = useRef(null);
            const animationIdRef = useRef(null);
            const snowflakesRef = useRef([]);
            
            useEffect(() => {
                const canvas = canvasRef.current;
                if (!canvas || !containerRef?.current) return;
                
                const ctx = canvas.getContext('2d');
                let animationId = null;
                
                const updateCanvasSize = () => {
                    if (!containerRef?.current || !canvas) return;
                    const container = containerRef.current;
                    const rect = container.getBoundingClientRect();
                    const dpr = window.devicePixelRatio || 1;
                    const width = rect.width;
                    const height = rect.height;
                    
                    canvas.style.width = width + 'px';
                    canvas.style.height = height + 'px';
                    canvas.width = width * dpr;
                    canvas.height = height * dpr;
                    ctx.scale(dpr, dpr);
                    
                    return { width, height };
                };
                
                // é›ªèŠ±é¡
                class Snowflake {
                    constructor(width, height) {
                        this.x = Math.random() * width;
                        this.y = Math.random() * height;
                        this.size = Math.random() * 3 + 1;
                        this.speed = Math.random() * 2 + 0.5;
                        this.wind = (Math.random() - 0.5) * 0.5;
                        this.opacity = Math.random() * 0.5 + 0.5;
                    }
                    
                    update(width, height) {
                        this.y += this.speed;
                        this.x += this.wind;
                        
                        if (this.y > height) {
                            this.y = -10;
                            this.x = Math.random() * width;
                        }
                        if (this.x < 0) this.x = width;
                        if (this.x > width) this.x = 0;
                    }
                    
                    draw(ctx) {
                        ctx.save();
                        ctx.globalAlpha = this.opacity;
                        ctx.fillStyle = '#ffffff';
                        ctx.beginPath();
                        ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.restore();
                    }
                }
                
                // åˆå§‹åŒ–é›ªèŠ±
                const initSnowflakes = () => {
                    const { width, height } = updateCanvasSize();
                    if (!width || !height) return;
                    
                    snowflakesRef.current = [];
                    const count = 100;
                    for (let i = 0; i < count; i++) {
                        snowflakesRef.current.push(new Snowflake(width, height));
                    }
                };
                
                // ç¹ªè£½è–èª•æ¨¹ï¼ˆç°¡åŒ–ç‰ˆï¼‰
                const drawChristmasTree = (ctx, x, y, size) => {
                    ctx.save();
                    // æ¨¹å¹¹
                    ctx.fillStyle = '#8B4513';
                    ctx.fillRect(x - size * 0.1, y, size * 0.2, size * 0.3);
                    
                    // æ¨¹è‘‰ï¼ˆä¸‰è§’å½¢ï¼‰
                    ctx.fillStyle = '#228B22';
                    for (let i = 0; i < 3; i++) {
                        const layerSize = size * (1 - i * 0.3);
                        ctx.beginPath();
                        ctx.moveTo(x, y - size * 0.8 + i * size * 0.3);
                        ctx.lineTo(x - layerSize * 0.5, y - size * 0.3 + i * size * 0.3);
                        ctx.lineTo(x + layerSize * 0.5, y - size * 0.3 + i * size * 0.3);
                        ctx.closePath();
                        ctx.fill();
                    }
                    
                    // æ˜Ÿæ˜Ÿ
                    ctx.fillStyle = '#FFD700';
                    ctx.beginPath();
                    ctx.moveTo(x, y - size * 0.9);
                    for (let i = 0; i < 5; i++) {
                        const angle = (Math.PI * 2 * i) / 5 - Math.PI / 2;
                        const x1 = x + Math.cos(angle) * size * 0.15;
                        const y1 = y - size * 0.9 + Math.sin(angle) * size * 0.15;
                        ctx.lineTo(x1, y1);
                    }
                    ctx.closePath();
                    ctx.fill();
                    ctx.restore();
                };
                
                // ç¹ªè£½æ˜Ÿæ˜Ÿ
                const drawStar = (ctx, x, y, size, opacity) => {
                    ctx.save();
                    ctx.globalAlpha = opacity;
                    ctx.fillStyle = '#FFD700';
                    ctx.beginPath();
                    for (let i = 0; i < 5; i++) {
                        const angle = (Math.PI * 2 * i) / 5 - Math.PI / 2;
                        const x1 = x + Math.cos(angle) * size;
                        const y1 = y + Math.sin(angle) * size;
                        if (i === 0) ctx.moveTo(x1, y1);
                        else ctx.lineTo(x1, y1);
                    }
                    ctx.closePath();
                    ctx.fill();
                    ctx.restore();
                };
                
                // ç²’å­é¡ï¼ˆç”¨æ–¼ç²’å­æ¨¹ï¼‰
                class Particle {
                    constructor(x, y, heightRatio) {
                        this.x = x;
                        this.y = y;
                        this.heightRatio = heightRatio; // 0 åˆ° 1ï¼Œè¡¨ç¤ºåœ¨æ¨¹ä¸­çš„é«˜åº¦
                        this.size = (0.15 - heightRatio * 0.1) * (0.8 + Math.random() * 0.4);
                        this.baseOpacity = 0.7 + Math.random() * 0.3;
                        this.phase = Math.random() * Math.PI * 2;
                        this.speed = 0.5 + Math.random() * 1.5;
                    }
                    
                    update() {
                        this.phase += 0.02;
                    }
                    
                    draw(ctx, centerX, centerY, treeHeight) {
                        ctx.save();
                        const opacity = this.baseOpacity + Math.sin(this.phase * this.speed) * 0.2;
                        ctx.globalAlpha = opacity;
                        
                        // é¡è‰²æ¼¸è®Šï¼šé ‚éƒ¨ç™½è‰²ï¼Œå‘ä¸‹æ¼¸è®Šåˆ°ç²‰ç´…è‰²
                        const whiteAmount = 1 - this.heightRatio * 0.6;
                        const pinkAmount = this.heightRatio * 0.8;
                        const r = Math.min(255, (whiteAmount + pinkAmount * 0.8) * 255);
                        const g = Math.min(255, (whiteAmount + pinkAmount * 0.3) * 255);
                        const b = Math.min(255, (whiteAmount + pinkAmount * 1.0) * 255);
                        
                        ctx.fillStyle = `rgb(${r}, ${g}, ${b})`;
                        ctx.shadowBlur = 10;
                        ctx.shadowColor = `rgba(${r}, ${g}, ${b}, 0.8)`;
                        ctx.beginPath();
                        ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.restore();
                    }
                }
                
                // å‰µå»ºç²’å­æ¨¹
                const createParticleTree = (centerX, centerY, treeHeight, treeWidth) => {
                    const particles = [];
                    const particleCount = 300;
                    
                    for (let i = 0; i < particleCount; i++) {
                        const heightRatio = Math.random(); // 0 åˆ° 1
                        const radius = heightRatio * treeWidth;
                        const angle = Math.random() * Math.PI * 2;
                        
                        // ä¸­å¿ƒå¯†é›†ï¼Œå¤–åœç¨€ç–
                        const distance = Math.random() < 0.3 ? 
                            Math.random() * radius * 0.5 : 
                            radius * 0.5 + Math.random() * radius * 0.5;
                        
                        const x = centerX + Math.cos(angle) * distance;
                        const y = centerY - heightRatio * treeHeight;
                        
                        particles.push(new Particle(x, y, heightRatio));
                    }
                    
                    return particles;
                };
                
                let particleTree = null;
                let treeCenterX = 0;
                let treeCenterY = 0;
                
                // åˆå§‹åŒ–ç²’å­æ¨¹
                const initParticleTree = () => {
                    const { width, height } = updateCanvasSize();
                    if (!width || !height) return;
                    
                    treeCenterX = width * 0.5;
                    treeCenterY = height * 0.7;
                    particleTree = createParticleTree(treeCenterX, treeCenterY, height * 0.5, width * 0.3);
                };
                
                // å‹•ç•«å¾ªç’°
                const animate = () => {
                    const { width, height } = updateCanvasSize();
                    if (!width || !height) {
                        animationId = requestAnimationFrame(animate);
                        return;
                    }
                    
                    // æ·±é»‘è‰²èƒŒæ™¯
                    ctx.fillStyle = '#000000';
                    ctx.fillRect(0, 0, width, height);
                    
                    // ç¹ªè£½ç´°å°èƒŒæ™¯æ˜Ÿæ˜Ÿ
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                    for (let i = 0; i < 200; i++) {
                        const x = (i * 37) % width;
                        const y = (i * 53) % height;
                        const size = Math.random() * 0.5;
                        ctx.beginPath();
                        ctx.arc(x, y, size, 0, Math.PI * 2);
                        ctx.fill();
                    }
                    
                    // æ›´æ–°å’Œç¹ªè£½ç²’å­æ¨¹
                    if (particleTree) {
                        particleTree.forEach(particle => {
                            particle.update();
                            particle.draw(ctx, treeCenterX, treeCenterY, height * 0.5);
                        });
                    }
                    
                    // é ‚éƒ¨ç™¼å…‰æ˜Ÿæ˜Ÿ
                    const time = Date.now() * 0.001;
                    const starSize = 8 + Math.sin(time * 2) * 2;
                    const starOpacity = 0.8 + Math.sin(time * 2) * 0.2;
                    ctx.save();
                    ctx.globalAlpha = starOpacity;
                    ctx.fillStyle = '#FFB6C1';
                    ctx.shadowBlur = 20;
                    ctx.shadowColor = '#FFB6C1';
                    ctx.beginPath();
                    for (let i = 0; i < 5; i++) {
                        const angle = (Math.PI * 2 * i) / 5 - Math.PI / 2;
                        const x = treeCenterX + Math.cos(angle) * starSize;
                        const y = treeCenterY - height * 0.5 + Math.sin(angle) * starSize;
                        if (i === 0) ctx.moveTo(x, y);
                        else ctx.lineTo(x, y);
                    }
                    ctx.closePath();
                    ctx.fill();
                    ctx.restore();
                    
                    // åº•éƒ¨ç™¼å…‰åœ“ç’°
                    const ringY = treeCenterY + height * 0.1;
                    for (let i = 0; i < 3; i++) {
                        const ringRadius = 30 + i * 15;
                        const ringOpacity = (0.3 - i * 0.1) * (0.8 + Math.sin(time * 1.5 + i) * 0.2);
                        ctx.save();
                        ctx.strokeStyle = `rgba(255, 105, 180, ${ringOpacity})`;
                        ctx.lineWidth = 2;
                        ctx.beginPath();
                        ctx.arc(treeCenterX, ringY, ringRadius, 0, Math.PI * 2);
                        ctx.stroke();
                        ctx.restore();
                    }
                    
                    // ç¹ªè£½ " Merry Christmas" æ–‡å­—
                    ctx.save();
                    ctx.fillStyle = '#FFB6C1';
                    ctx.font = `italic ${Math.min(24, width * 0.06)}px 'Noto Serif TC', serif`;
                    ctx.textAlign = 'left';
                    ctx.textBaseline = 'middle';
                    ctx.shadowBlur = 15;
                    ctx.shadowColor = '#FFB6C1';
                    const textX = width * 0.1;
                    const textY = height * 0.5;
                    ctx.fillText(' Merry Christmas', textX, textY);
                    ctx.restore();
                    
                    // æ›´æ–°å’Œç¹ªè£½é›ªèŠ±
                    snowflakesRef.current.forEach(snowflake => {
                        snowflake.update(width, height);
                        snowflake.draw(ctx);
                    });
                    
                    animationId = requestAnimationFrame(animate);
                };
                
                // åˆå§‹åŒ–
                setTimeout(() => {
                    initSnowflakes();
                    initParticleTree();
                    animate();
                }, 100);
                
                // è™•ç†çª—å£å¤§å°è®ŠåŒ–
                const handleResize = () => {
                    initSnowflakes();
                };
                window.addEventListener('resize', handleResize);
                
                // æ¸…ç†
                return () => {
                    if (animationId) cancelAnimationFrame(animationId);
                    window.removeEventListener('resize', handleResize);
                };
            }, [containerRef]);
            
            return (
                <canvas
                    ref={canvasRef}
                    className="absolute top-0 left-0 pointer-events-none"
                    style={{
                        zIndex: 0,
                        width: '100%',
                        height: '100%',
                        position: 'absolute',
                        top: 0,
                        left: 0,
                        right: 0,
                        bottom: 0,
                        backgroundColor: '#000000' // æ·±é»‘è‰²èƒŒæ™¯
                    }}
                />
            );
        };

        // =========================================================================
        // 3D ç«‹é«”æ˜Ÿç©ºå®‡å®™ + è–èª•ç¯€å ´æ™¯ï¼ˆä½¿ç”¨åŸç”Ÿ Three.jsï¼‰
        // =========================================================================
        const FuturisticScene = ({ containerRef }) => {
            const canvasRef = useRef(null);
            const sceneRef = useRef(null);
            const rendererRef = useRef(null);
            const cameraRef = useRef(null);
            const animationIdRef = useRef(null);
            const starSystemsRef = useRef(null);
            const treeSystemRef = useRef(null);
            const [error, setError] = useState(null);
            const [threeLoaded, setThreeLoaded] = useState(false);
            
            useEffect(() => {
                let retryCount = 0;
                const maxRetries = 50; // æœ€å¤šå˜—è©¦ 5 ç§’
                
                // ç­‰å¾… Three.js è¼‰å…¥
                const checkThreeJS = () => {
                    if (window.THREE && window.THREE.Scene) {
                        console.log('âœ… Three.js å·²è¼‰å…¥');
                        setThreeLoaded(true);
                        setTimeout(initScene, 200); // ç¨å¾®å»¶é²ç¢ºä¿å®Œå…¨è¼‰å…¥
                        return;
                    }
                    
                    retryCount++;
                    if (retryCount < maxRetries) {
                        setTimeout(checkThreeJS, 100);
                    } else {
                        console.warn('âŒ Three.js è¼‰å…¥è¶…æ™‚ï¼Œä½¿ç”¨ 2D å‚™ç”¨èƒŒæ™¯');
                        setError('Three.js timeout');
                    }
                };
                
                const initScene = () => {
                    console.log('ğŸ¨ é–‹å§‹åˆå§‹åŒ– 3D å ´æ™¯...');
                    
                    // æª¢æŸ¥ Three.js æ˜¯å¦è¼‰å…¥
                    if (!window.THREE || !window.THREE.Scene) {
                        console.warn('Three.js æœªè¼‰å…¥ï¼Œä½¿ç”¨å‚™ç”¨ 2D èƒŒæ™¯');
                        setError('Three.js not loaded');
                        return;
                    }
                    
                    // ç­‰å¾…å®¹å™¨æº–å‚™å¥½
                    if (!canvasRef.current || !containerRef?.current) {
                        console.log('â³ ç­‰å¾…å®¹å™¨æº–å‚™...');
                        setTimeout(() => {
                            if (canvasRef.current && containerRef?.current) {
                                initScene(); // é‡æ–°å˜—è©¦åˆå§‹åŒ–
                            } else {
                                console.warn('å®¹å™¨æœªæº–å‚™å¥½');
                                setError('Container not ready');
                            }
                        }, 200);
                        return;
                    }
                    
                    const THREE = window.THREE;
                    
                    try {
                        const container = containerRef.current;
                        let width = container.clientWidth;
                        let height = container.clientHeight;
                        
                        console.log(`ğŸ“ å®¹å™¨å°ºå¯¸: ${width}x${height}`);
                        
                        // ç¢ºä¿æœ‰æœ‰æ•ˆçš„å°ºå¯¸
                        if (width === 0 || height === 0) {
                            width = window.innerWidth || 800;
                            height = window.innerHeight || 600;
                            console.log(`ğŸ“ ä½¿ç”¨çª—å£å°ºå¯¸: ${width}x${height}`);
                        }
                        
                        // å‰µå»ºå ´æ™¯
                        const scene = new THREE.Scene();
                        scene.background = new THREE.Color(0x000000); // æ·±é»‘è‰²èƒŒæ™¯
                        sceneRef.current = scene;
                        console.log('âœ… å ´æ™¯å‰µå»ºæˆåŠŸï¼ŒèƒŒæ™¯è‰²: é»‘è‰²');
                        
                        // å‰µå»ºç›¸æ©Ÿï¼ˆç¨å¾®æ‹‰é«˜ï¼ŒæŒ‰ç…§æ‚¨æä¾›çš„ä»£ç¢¼ï¼‰
                        const camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 1000);
                        camera.position.set(0, 5, 10); // ç›¸æ©Ÿä½ç½®ç¨å¾®æ‹‰é«˜
                        cameraRef.current = camera;
                        console.log('âœ… ç›¸æ©Ÿå‰µå»ºæˆåŠŸï¼Œä½ç½®:', camera.position);
                        
                        // å‰µå»ºæ¸²æŸ“å™¨ï¼ˆç§»å‹•è¨­å‚™å„ªåŒ–ï¼‰
                        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                        console.log(`ğŸ“± ç§»å‹•è¨­å‚™: ${isMobile}`);
                        
                        let renderer;
                        try {
                            // ç¢ºä¿ canvas å­˜åœ¨
                            if (!canvasRef.current) {
                                console.error('âŒ Canvas å…ƒç´ ä¸å­˜åœ¨');
                                setError('Canvas not found');
                                return;
                            }
                            
                            console.log('ğŸ¨ å‰µå»º WebGL æ¸²æŸ“å™¨ï¼Œcanvas:', canvasRef.current);
                            
                            renderer = new THREE.WebGLRenderer({ 
                                canvas: canvasRef.current,
                                alpha: false, // ä¸é€æ˜ï¼Œä½¿ç”¨æ·±è‰²èƒŒæ™¯
                                antialias: !isMobile,
                                powerPreference: "high-performance"
                            });
                            
                            renderer.setSize(width, height);
                            renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, isMobile ? 1.5 : 2));
                            renderer.setClearColor(0x000000, 1); // æ·±é»‘è‰²èƒŒæ™¯
                            rendererRef.current = renderer;
                            console.log('âœ… WebGL æ¸²æŸ“å™¨å‰µå»ºæˆåŠŸï¼Œå°ºå¯¸:', width, 'x', height);
                            
                            // ç«‹å³æ¸²æŸ“ä¸€æ¬¡æ¸¬è©¦
                            renderer.render(scene, camera);
                            console.log('âœ… æ¸¬è©¦æ¸²æŸ“å®Œæˆ');
                        } catch (e) {
                            console.error('âŒ WebGL æ¸²æŸ“å™¨å‰µå»ºå¤±æ•—:', e);
                            setError('WebGL not supported');
                            return;
                        }
                        
                        // ========== å‰µå»ºæ·±è‰²èƒŒæ™¯æ˜Ÿç©º ==========
                        console.log('âœ¨ å‰µå»ºèƒŒæ™¯æ˜Ÿç©º...');
                        
                        // ç´°å°çš„èƒŒæ™¯æ˜Ÿæ˜Ÿç²’å­ï¼ˆæ·±ç©ºæ„Ÿï¼‰
                        const backgroundStarCount = isMobile ? 500 : 1000;
                        const bgPositions = new Float32Array(backgroundStarCount * 3);
                        const bgColors = new Float32Array(backgroundStarCount * 3);
                        
                        for (let i = 0; i < backgroundStarCount; i++) {
                            const i3 = i * 3;
                            bgPositions[i3] = (Math.random() - 0.5) * 40;
                            bgPositions[i3 + 1] = (Math.random() - 0.5) * 40;
                            bgPositions[i3 + 2] = (Math.random() - 0.5) * 20 - 10;
                            
                            // éå¸¸æ·¡çš„ç™½è‰²æ˜Ÿæ˜Ÿ
                            const brightness = 0.3 + Math.random() * 0.3;
                            bgColors[i3] = brightness;
                            bgColors[i3 + 1] = brightness;
                            bgColors[i3 + 2] = brightness;
                        }
                        
                        const bgStarGeometry = new THREE.BufferGeometry();
                        bgStarGeometry.setAttribute('position', new THREE.BufferAttribute(bgPositions, 3));
                        bgStarGeometry.setAttribute('color', new THREE.BufferAttribute(bgColors, 3));
                        
                        const bgStarMaterial = new THREE.PointsMaterial({
                            size: 0.05,
                            vertexColors: true,
                            transparent: true,
                            opacity: 0.6,
                            sizeAttenuation: true
                        });
                        
                        const backgroundStars = new THREE.Points(bgStarGeometry, bgStarMaterial);
                        scene.add(backgroundStars);
                        
                        // ========== å‰µå»ºèºæ—‹ç²’å­è–èª•æ¨¹ï¼ˆä½¿ç”¨æ‚¨æä¾›çš„æ•¸å­¸å…¬å¼ï¼‰==========
                        console.log('ğŸ„ å‰µå»ºèºæ—‹ç²’å­è–èª•æ¨¹...');
                        
                        const particleCount = isMobile ? 5000 : 15000;
                        const positions = [];
                        const colors = [];
                        
                        // é¡è‰²å®šç¾©ï¼ˆéŠ€è‰²/ç™½è‰²/ç²‰è‰²ç³»ï¼Œç¬¦åˆåœ–ç‰‡é¢¨æ ¼ï¼‰
                        const color1 = new THREE.Color('#FFB6C1'); // æ·ºç²‰è‰²
                        const color2 = new THREE.Color('#FFD700'); // é‡‘è‰²
                        const color3 = new THREE.Color('#FFFFFF'); // ç™½è‰²
                        const color4 = new THREE.Color('#FF69B4'); // ç²‰ç´…è‰²
                        const color5 = new THREE.Color('#C0C0C0'); // éŠ€è‰²
                        
                        // --- æ ¸å¿ƒæ•¸å­¸é‚è¼¯ï¼šèºæ—‹åœ“éŒï¼ˆå®Œå…¨æŒ‰ç…§æ‚¨æä¾›çš„å…¬å¼ï¼‰---
                        for (let i = 0; i < particleCount; i++) {
                            // y: é«˜åº¦ï¼Œå¾ -5 åˆ° 5
                            const y = (Math.random() - 0.5) * 10;
                            
                            // radius: åŠå¾‘ã€‚é«˜åº¦è¶Šé«˜(yè¶Šå¤§)ï¼ŒåŠå¾‘è¶Šå°ã€‚
                            // æŠŠ y å¾ [-5, 5] æ˜ å°„åˆ° [5, 0] çš„åŠå¾‘ç¯„åœ
                            const radius = (5 - y) * 0.4;
                            
                            // angle: è§’åº¦ã€‚è®“ç²’å­æ—‹è½‰åˆ†ä½ˆï¼Œç”¢ç”Ÿèºæ—‹ç´‹ç†
                            const angle = i * 0.2 + y * 5.0; // y * 5.0 ç”¢ç”Ÿèºæ—‹æ•ˆæœ
                            
                            // åŠ ä¸Šä¸€é»éš¨æ©Ÿæ€§ï¼Œä¸è®“æ¨¹å¤ªæ­»æ¿
                            const randomR = radius + (Math.random() - 0.5) * 0.5;
                            
                            const x = Math.cos(angle) * randomR;
                            const z = Math.sin(angle) * randomR;
                            
                            positions.push(x, y, z);
                            
                            // é¡è‰²åˆ†é…ï¼šé ‚éƒ¨ç™½è‰²/éŠ€è‰²ï¼Œå‘ä¸‹æ¼¸è®Šåˆ°ç²‰è‰²/é‡‘è‰²ï¼ˆç¬¦åˆåœ–ç‰‡é¢¨æ ¼ï¼‰
                            const heightRatio = (y + 5) / 10; // 0 åˆ° 1
                            const rand = Math.random();
                            
                            if (heightRatio > 0.75) {
                                // é ‚éƒ¨ï¼šä¸»è¦æ˜¯ç™½è‰²å’ŒéŠ€è‰²
                                if (rand < 0.7) {
                                    colors.push(color3.r, color3.g, color3.b); // ç™½è‰²
                                } else {
                                    colors.push(color5.r, color5.g, color5.b); // éŠ€è‰²
                                }
                            } else if (heightRatio > 0.5) {
                                // ä¸­ä¸Šéƒ¨ï¼šç™½è‰²å’Œæ·ºç²‰è‰²æ··åˆ
                                if (rand < 0.5) {
                                    colors.push(color3.r, color3.g, color3.b); // ç™½è‰²
                                } else {
                                    colors.push(color1.r, color1.g, color1.b); // æ·ºç²‰è‰²
                                }
                            } else if (heightRatio > 0.25) {
                                // ä¸­ä¸‹éƒ¨ï¼šç²‰è‰²ç‚ºä¸»
                                if (rand < 0.7) {
                                    colors.push(color4.r, color4.g, color4.b); // ç²‰ç´…è‰²
                                } else {
                                    colors.push(color1.r, color1.g, color1.b); // æ·ºç²‰è‰²
                                }
                            } else {
                                // åº•éƒ¨ï¼šç²‰è‰²å’Œé‡‘è‰²
                                if (rand < 0.6) {
                                    colors.push(color4.r, color4.g, color4.b); // ç²‰ç´…è‰²
                                } else {
                                    colors.push(color2.r, color2.g, color2.b); // é‡‘è‰²
                                }
                            }
                        }
                        
                        const treeGeometry = new THREE.BufferGeometry();
                        treeGeometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
                        treeGeometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
                        
                        const treeMaterial = new THREE.PointsMaterial({
                            size: 0.15,
                            vertexColors: true,
                            blending: THREE.AdditiveBlending, // ç™¼å…‰ç–ŠåŠ æ¨¡å¼ï¼ˆé—œéµï¼ï¼‰
                            depthWrite: false,
                            transparent: true,
                            opacity: 0.8,
                            sizeAttenuation: true
                        });
                        
                        const particleTree = new THREE.Points(treeGeometry, treeMaterial);
                        particleTree.position.set(0, 0, -5);
                        scene.add(particleTree);
                        console.log('âœ… èºæ—‹ç²’å­æ¨¹å·²å‰µå»ºï¼Œç²’å­æ•¸:', particleCount);
                        
                        // é ‚éƒ¨ç™¼å…‰æ˜Ÿæ˜Ÿï¼ˆæ¨¹é ‚ï¼‰
                        const topStarGeo = new THREE.OctahedronGeometry(0.3, 0);
                        const topStarMat = new THREE.MeshBasicMaterial({
                            color: 0xFFB6C1,
                            transparent: true,
                            opacity: 0.9
                        });
                        const topStar = new THREE.Mesh(topStarGeo, topStarMat);
                        topStar.position.set(0, 5.2, -5);
                        topStar.rotation.z = Math.PI / 4;
                        scene.add(topStar);
                        
                        // æ·»åŠ åº•éƒ¨çš„å…‰ç’°ï¼ˆå®Œå…¨æŒ‰ç…§æ‚¨æä¾›çš„ä»£ç¢¼ï¼‰
                        const ringGeo = new THREE.TorusGeometry(2.0, 0.05, 16, 100);
                        const ringMat = new THREE.MeshBasicMaterial({ 
                            color: 0xFF69B4,
                            transparent: true,
                            opacity: 0.6
                        });
                        const ring = new THREE.Mesh(ringGeo, ringMat);
                        ring.rotation.x = -Math.PI / 2;
                        ring.position.set(0, -5, -5);
                        scene.add(ring);
                        console.log('âœ… åº•éƒ¨å…‰ç’°å·²å‰µå»º');
                        
                        // å­˜å„²ç”¨æ–¼å‹•ç•«
                        starSystemsRef.current = [{ stars: backgroundStars, geometry: bgStarGeometry }];
                        treeSystemRef.current = { 
                            tree: particleTree, 
                            geometry: treeGeometry,
                            topStar: topStar,
                            ring: ring
                        };
                        
                        const starSystems = starSystemsRef.current;
                        const treeSystem = treeSystemRef.current;
                    
                        // ========== å‰µå»ºå…‰æºç³»çµ± ==========
                        console.log('ğŸ’¡ å‰µå»ºå…‰æºç³»çµ±...');
                        
                        // æ·»åŠ éœ§æ°£æ•ˆæœï¼Œè®“é è™•çš„ç²’å­è®Šæš—ï¼Œæ›´æœ‰å±¤æ¬¡æ„Ÿ
                        scene.fog = new THREE.FogExp2(0x000000, 0.05);
                        
                        // ç’°å¢ƒå…‰ï¼ˆå¾ˆæš—ï¼Œä¸»è¦é ç²’å­è‡ªèº«ç™¼å…‰ï¼‰
                        const ambientLight = new THREE.AmbientLight(0x000000, 0.1);
                        scene.add(ambientLight);
                        
                        // é»å…‰æºï¼ˆç…§äº®ç²’å­æ¨¹ï¼‰
                        const pointLight = new THREE.PointLight(0xFFB6C1, 1.0, 50);
                        pointLight.position.set(0, 0, -4);
                        scene.add(pointLight);
                    
                        // ========== å‹•ç•«å¾ªç’° ==========
                        console.log('ğŸ¬ å•Ÿå‹•å‹•ç•«å¾ªç’°...');
                        const clock = new THREE.Clock();
                        
                        const animate = () => {
                            animationIdRef.current = requestAnimationFrame(animate);
                            const elapsedTime = clock.getElapsedTime();
                            
                            // 1. èƒŒæ™¯æ˜Ÿæ˜Ÿç·©æ…¢æ—‹è½‰
                            backgroundStars.rotation.y = elapsedTime * 0.05;
                            
                            // 2. è®“æ•´æ£µæ¨¹æ—‹è½‰ï¼ˆæŒ‰ç…§æ‚¨æä¾›çš„ä»£ç¢¼ï¼‰
                            if (treeSystem && treeSystem.tree) {
                                treeSystem.tree.rotation.y = elapsedTime * 0.3;
                            }
                            
                            // 3. é ‚éƒ¨æ˜Ÿæ˜Ÿæ—‹è½‰
                            if (treeSystem && treeSystem.topStar) {
                                treeSystem.topStar.rotation.y = elapsedTime * 0.5;
                                treeSystem.topStar.rotation.x = elapsedTime * 0.3;
                            }
                            
                            // 4. åº•éƒ¨å…‰ç’°è„ˆè¡å¼ç¸®æ”¾ï¼ˆæŒ‰ç…§æ‚¨æä¾›çš„ä»£ç¢¼ï¼‰
                            if (treeSystem && treeSystem.ring) {
                                const scale = 1 + Math.sin(elapsedTime * 2) * 0.1;
                                treeSystem.ring.scale.set(scale, scale, scale);
                            }
                            
                            // 5. ç›¸æ©Ÿè¼•å¾®ç§»å‹•ï¼ˆå‰µé€ æ²‰æµ¸æ„Ÿï¼‰
                            camera.position.x = Math.sin(elapsedTime * 0.1) * 0.3;
                            camera.position.y = 5 + Math.cos(elapsedTime * 0.08) * 0.2;
                            camera.lookAt(0, 0, -5);
                            
                            renderer.render(scene, camera);
                        };
                        animate();
                        console.log('âœ… å ´æ™¯åˆå§‹åŒ–å®Œæˆï¼å‹•ç•«å¾ªç’°å·²å•Ÿå‹•');
                        console.log('ğŸ“Š å ´æ™¯çµ±è¨ˆ:', {
                            objects: scene.children.length,
                            backgroundStars: backgroundStars ? 'å·²å‰µå»º' : 'æœªå‰µå»º',
                            particleTree: particleTree ? 'å·²å‰µå»º' : 'æœªå‰µå»º',
                            topStar: topStar ? 'å·²å‰µå»º' : 'æœªå‰µå»º',
                            ring: ring ? 'å·²å‰µå»º' : 'æœªå‰µå»º'
                        });
                        
                        // ç«‹å³æ¸²æŸ“ä¸€æ¬¡ç¢ºä¿å¯è¦‹
                        setTimeout(() => {
                            if (renderer && scene && camera) {
                                renderer.render(scene, camera);
                                console.log('âœ… åˆå§‹æ¸²æŸ“å®Œæˆ');
                            } else {
                                console.error('âŒ æ¸²æŸ“å™¨ã€å ´æ™¯æˆ–ç›¸æ©Ÿä¸å­˜åœ¨');
                            }
                        }, 100);
                    
                    // è™•ç†çª—å£å¤§å°è®ŠåŒ–
                    const handleResize = () => {
                        if (!containerRef?.current || !camera || !renderer) return;
                        const newWidth = containerRef.current.clientWidth || window.innerWidth;
                        const newHeight = containerRef.current.clientHeight || window.innerHeight;
                        if (newWidth > 0 && newHeight > 0) {
                            camera.aspect = newWidth / newHeight;
                            camera.updateProjectionMatrix();
                            renderer.setSize(newWidth, newHeight);
                        }
                    };
                    
                    window.addEventListener('resize', handleResize);
                    
                    // æ¸…ç†å‡½æ•¸
                    return () => {
                        if (animationIdRef.current) {
                            cancelAnimationFrame(animationIdRef.current);
                        }
                        window.removeEventListener('resize', handleResize);
                        // æ¸…ç†æ‰€æœ‰è³‡æº
                        if (starSystemsRef.current) {
                            starSystemsRef.current.forEach(system => {
                                if (system.geometry) system.geometry.dispose();
                                if (system.material) system.material.dispose();
                            });
                        }
                        if (treeSystemRef.current) {
                            const treeSystem = treeSystemRef.current;
                            if (treeSystem.geometry) treeSystem.geometry.dispose();
                            if (treeMaterial) treeMaterial.dispose();
                            if (treeSystem.topStar) {
                                treeSystem.topStar.traverse(child => {
                                    if (child.geometry) child.geometry.dispose();
                                    if (child.material) child.material.dispose();
                                });
                            }
                            if (treeSystem.ring) {
                                if (treeSystem.ring.geometry) treeSystem.ring.geometry.dispose();
                                if (treeSystem.ring.material) treeSystem.ring.material.dispose();
                            }
                        }
                        if (rendererRef.current) rendererRef.current.dispose();
                    };
                    } catch (err) {
                        console.error('âŒ 3D å ´æ™¯åˆå§‹åŒ–éŒ¯èª¤:', err);
                        setError(err.message);
                    }
                };
                
                // é–‹å§‹æª¢æŸ¥
                checkThreeJS();
            }, [containerRef]);
            
            // å¦‚æœæœ‰éŒ¯èª¤ï¼Œä¸é¡¯ç¤º 3D canvasï¼Œè®“ 2D èƒŒæ™¯é¡¯ç¤º
            if (error) {
                console.log('âš ï¸ 3D å ´æ™¯éŒ¯èª¤ï¼Œä½¿ç”¨ 2D å‚™ç”¨èƒŒæ™¯');
                return null;
            }
            
            // å¦‚æœæœ‰éŒ¯èª¤ï¼Œä¸é¡¯ç¤º 3D canvasï¼Œè®“ 2D èƒŒæ™¯é¡¯ç¤º
            if (error) {
                console.log('âš ï¸ 3D å ´æ™¯éŒ¯èª¤ï¼Œä½¿ç”¨ 2D å‚™ç”¨èƒŒæ™¯');
                return null;
            }
            
            return (
                <canvas
                    ref={canvasRef}
                    className="absolute top-0 left-0 pointer-events-none"
                    style={{
                        zIndex: 1, // 3D åœ¨ 2D ä¹‹ä¸Š
                        width: '100%',
                        height: '100%',
                        position: 'absolute',
                        top: 0,
                        left: 0,
                        right: 0,
                        bottom: 0,
                        backgroundColor: '#000000', // æ·±é»‘è‰²èƒŒæ™¯
                        display: 'block'
                    }}
                />
            );
        };

        // =========================================================================
        // èˆŠçš„ 2D ç²’å­èƒŒæ™¯ç³»çµ±ï¼ˆä¿ç•™ä½œç‚ºå‚™ç”¨ï¼‰
        // =========================================================================
        const ParticleBackground = ({ containerRef }) => {
            const canvasRef = useRef(null);
            const animationFrameRef = useRef(null);
            const particlesRef = useRef([]);
            const isVisibleRef = useRef(true);
            const resizeObserverRef = useRef(null);

            useEffect(() => {
                const canvas = canvasRef.current;
                if (!canvas || !containerRef?.current) return;

                const ctx = canvas.getContext('2d');
                let animationId = null;

                // æª¢æ¸¬è¨­å‚™æ€§èƒ½
                const isLowEndDevice = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) 
                    || (navigator.hardwareConcurrency && navigator.hardwareConcurrency <= 2);
                
                // æ ¹æ“šè¨­å‚™æ€§èƒ½èª¿æ•´ç²’å­æ•¸é‡
                const particleCount = isLowEndDevice ? 15 : 25;

                // ç²’å­é¡
                class Particle {
                    constructor(width, height) {
                        this.x = Math.random() * width;
                        this.y = Math.random() * height;
                        this.size = Math.random() * 2 + 1;
                        this.speedX = (Math.random() - 0.5) * 0.3;
                        this.speedY = (Math.random() - 0.5) * 0.3;
                        this.opacity = Math.random() * 0.3 + 0.1; // ä½é€æ˜åº¦ï¼Œä¸å¹²æ“¾é–±è®€
                        this.hue = 35 + Math.random() * 20; // é‡‘è‰²/ç¥ç€è‰²ç¯„åœ (35-55)
                        this.angle = Math.random() * Math.PI * 2;
                        this.radius = Math.random() * 50 + 20;
                    }

                    update(width, height) {
                        // ç·©æ…¢çš„åœ“å‘¨é‹å‹•
                        this.angle += 0.002;
                        this.x += Math.cos(this.angle) * 0.2 + this.speedX;
                        this.y += Math.sin(this.angle) * 0.2 + this.speedY;

                        // é‚Šç•Œè™•ç†
                        if (this.x < 0 || this.x > width) this.speedX *= -1;
                        if (this.y < 0 || this.y > height) this.speedY *= -1;

                        // ä¿æŒåœ¨ç•«å¸ƒå…§
                        this.x = Math.max(0, Math.min(width, this.x));
                        this.y = Math.max(0, Math.min(height, this.y));
                    }

                    draw(ctx) {
                        ctx.save();
                        ctx.globalAlpha = this.opacity;
                        
                        // ç¹ªè£½ç™¼å…‰ç²’å­
                        const gradient = ctx.createRadialGradient(
                            this.x, this.y, 0,
                            this.x, this.y, this.size * 2
                        );
                        gradient.addColorStop(0, `hsla(${this.hue}, 70%, 60%, 1)`);
                        gradient.addColorStop(0.5, `hsla(${this.hue}, 70%, 60%, 0.5)`);
                        gradient.addColorStop(1, `hsla(${this.hue}, 70%, 60%, 0)`);
                        
                        ctx.fillStyle = gradient;
                        ctx.beginPath();
                        ctx.arc(this.x, this.y, this.size * 2, 0, Math.PI * 2);
                        ctx.fill();
                        
                        ctx.restore();
                    }
                }

                // æ›´æ–° Canvas å°ºå¯¸
                const updateCanvasSize = () => {
                    if (!containerRef?.current || !canvas) return;
                    
                    const container = containerRef.current;
                    const rect = container.getBoundingClientRect();
                    
                    // ä½¿ç”¨å¯¦éš›åƒç´ å°ºå¯¸ï¼Œç¢ºä¿é«˜ DPI é¡¯ç¤ºæ­£ç¢º
                    const dpr = window.devicePixelRatio || 1;
                    const width = rect.width;
                    const height = rect.height;
                    
                    // è¨­ç½® Canvas çš„é¡¯ç¤ºå°ºå¯¸
                    canvas.style.width = width + 'px';
                    canvas.style.height = height + 'px';
                    
                    // è¨­ç½® Canvas çš„å¯¦éš›åƒç´ å°ºå¯¸ï¼ˆè€ƒæ…® DPRï¼‰
                    canvas.width = width * dpr;
                    canvas.height = height * dpr;
                    
                    // ç¸®æ”¾ç¹ªåœ–ä¸Šä¸‹æ–‡ä»¥åŒ¹é… DPR
                    ctx.scale(dpr, dpr);
                    
                    return { width, height };
                };

                // åˆå§‹åŒ–ç²’å­
                const initParticles = () => {
                    const { width, height } = updateCanvasSize();
                    if (!width || !height) return;
                    
                    particlesRef.current = [];
                    for (let i = 0; i < particleCount; i++) {
                        particlesRef.current.push(new Particle(width, height));
                    }
                };

                // ç¹ªè£½é€£æ¥ç·šï¼ˆå¯é¸ï¼Œæ›´å¾®å¦™çš„è¦–è¦ºæ•ˆæœï¼‰
                const drawConnections = (width, height) => {
                    const particles = particlesRef.current;
                    for (let i = 0; i < particles.length; i++) {
                        for (let j = i + 1; j < particles.length; j++) {
                            const dx = particles[i].x - particles[j].x;
                            const dy = particles[i].y - particles[j].y;
                            const distance = Math.sqrt(dx * dx + dy * dy);

                            if (distance < 120) {
                                ctx.save();
                                ctx.globalAlpha = (120 - distance) / 120 * 0.1; // éå¸¸ä½çš„é€æ˜åº¦
                                ctx.strokeStyle = `hsl(35, 70%, 60%)`;
                                ctx.lineWidth = 0.5;
                                ctx.beginPath();
                                ctx.moveTo(particles[i].x, particles[i].y);
                                ctx.lineTo(particles[j].x, particles[j].y);
                                ctx.stroke();
                                ctx.restore();
                            }
                        }
                    }
                };

                // å‹•ç•«å¾ªç’°
                const animate = () => {
                    if (!isVisibleRef.current) {
                        animationId = requestAnimationFrame(animate);
                        return;
                    }

                    const { width, height } = updateCanvasSize();
                    if (!width || !height || particlesRef.current.length === 0) {
                        animationId = requestAnimationFrame(animate);
                        return;
                    }

                    // æª¢æŸ¥æ˜¯å¦éœ€è¦é‡æ–°åˆå§‹åŒ–ç²’å­ï¼ˆå°ºå¯¸è®ŠåŒ–ï¼‰
                    const firstParticle = particlesRef.current[0];
                    if (firstParticle && (firstParticle.x > width || firstParticle.y > height)) {
                        initParticles();
                    }

                    // æ¸…é™¤ç•«å¸ƒï¼ˆä½¿ç”¨åŠé€æ˜ä»¥å¯¦ç¾æ‹–å°¾æ•ˆæœï¼‰
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
                    ctx.fillRect(0, 0, width, height);

                    // æ›´æ–°å’Œç¹ªè£½ç²’å­
                    particlesRef.current.forEach(particle => {
                        particle.update(width, height);
                        particle.draw(ctx);
                    });

                    // ç¹ªè£½é€£æ¥ç·šï¼ˆå¯é¸ï¼‰
                    drawConnections(width, height);

                    animationId = requestAnimationFrame(animate);
                };

                // è™•ç†çª—å£å¤§å°è®ŠåŒ–
                const handleResize = () => {
                    initParticles();
                };

                // è™•ç†é é¢å¯è¦‹æ€§ï¼ˆç¯€çœæ€§èƒ½ï¼‰
                const handleVisibilityChange = () => {
                    isVisibleRef.current = !document.hidden;
                };

                // ä½¿ç”¨ ResizeObserver ç›£è½å®¹å™¨å°ºå¯¸è®ŠåŒ–
                if (containerRef?.current && window.ResizeObserver) {
                    resizeObserverRef.current = new ResizeObserver(() => {
                        initParticles();
                    });
                    resizeObserverRef.current.observe(containerRef.current);
                }

                // åˆå§‹åŒ–
                setTimeout(() => {
                    initParticles();
                    animate();
                }, 100); // ç¨å¾®å»¶é²ç¢ºä¿å®¹å™¨å·²æ¸²æŸ“

                // ç›£è½äº‹ä»¶
                window.addEventListener('resize', handleResize);
                document.addEventListener('visibilitychange', handleVisibilityChange);

                // æ¸…ç†å‡½æ•¸
                return () => {
                    if (animationId) {
                        cancelAnimationFrame(animationId);
                    }
                    if (resizeObserverRef.current) {
                        resizeObserverRef.current.disconnect();
                    }
                    window.removeEventListener('resize', handleResize);
                    document.removeEventListener('visibilitychange', handleVisibilityChange);
                };
            }, [containerRef]);

            return (
                <canvas
                    ref={canvasRef}
                    className="absolute top-0 left-0 pointer-events-none"
                    style={{
                        zIndex: 0,
                        opacity: 0.4, // é™ä½é€æ˜åº¦ï¼Œç¢ºä¿ä¸å¹²æ“¾å…§å®¹
                        width: '100%',
                        height: '100%',
                        position: 'absolute',
                        top: 0,
                        left: 0,
                        right: 0,
                        bottom: 0
                    }}
                />
            );
        };

        const SYSTEM_PROMPT_BIBLE_ONLY = `
You are a wise, loving, and learned Christian AI Pastor.
Your identity and role are CRITICAL: You are a Christian pastor, and you MUST maintain this identity in ALL conversations.

**YOUR IDENTITY AS A PASTOR:**
- You are a Christian pastor providing spiritual guidance
- You speak from a pastoral perspective, using biblical wisdom
- You care for the spiritual well-being of your congregation (the user)
- You are NOT a general AI assistant, therapist, lawyer, doctor, or financial advisor
- You MUST stay within the boundaries of pastoral care

**TOPICS YOU CAN DISCUSS (Within Pastoral Role):**
- Spiritual questions and biblical interpretation
- Prayer, Bible reading, and spiritual disciplines
- Faith-related life decisions and guidance
- Personal life problems from a SPIRITUAL/BIBLICAL perspective (relationships, work, family, finances, health - but only as they relate to faith and biblical principles)
- Ethical dilemmas and moral questions from a biblical perspective
- Emotional struggles and challenges from a SPIRITUAL perspective
- Church life, ministry, and service
- Questions about God, Jesus, the Holy Spirit, salvation, and Christian doctrine
- How to apply biblical principles to daily life

**TOPICS OUTSIDE YOUR PASTORAL ROLE (MUST REDIRECT):**
- Severe mental health issues requiring professional therapy (depression, anxiety disorders, PTSD, etc.)
- Legal advice or legal problems (need a lawyer)
- Medical diagnosis, treatment recommendations, or health emergencies (need a doctor)
- Complex marital/family crises requiring professional counseling (need professional family counselor)
- Financial investment advice or detailed financial planning (need a financial advisor)
- Technical career advice unrelated to faith (need a career counselor)
- Purely secular topics with no spiritual dimension
- Any situation requiring immediate professional intervention (crisis, abuse, etc.)

**CRITICAL: When Topics Are Outside Your Role:**
If the user asks about topics outside your pastoral role, you MUST:
1. Gently but clearly remind them: "ä½œç‚ºä½ çš„ç‰§å¸«ï¼Œæˆ‘ç†è§£ä½ çš„å›°æ“¾ï¼Œä½†é€™å€‹å•é¡Œè¶…å‡ºäº†æˆ‘ä½œç‚ºç‰§å¸«èƒ½å¤ æä¾›çš„å¹«åŠ©ç¯„åœã€‚" (Chinese) or "As your pastor, I understand your concern, but this matter is beyond what I can help with in my pastoral role." (English)
2. Explain why: "é€™é¡å•é¡Œéœ€è¦å°ˆæ¥­çš„ [å°ˆæ¥­é¡å‹] ä¾†å”åŠ©ï¼Œè€Œä¸æ˜¯ç‰§å¸«çš„è·è²¬ç¯„åœã€‚" (Chinese) or "This type of issue requires a professional [professional type], which is outside a pastor's role." (English)
3. Direct them appropriately: "æˆ‘å»ºè­°ä½ å»æ‰¾æ•™æœƒçš„ç‰§å¸«ï¼Œä»–å€‘å¯ä»¥ç‚ºä½ æä¾›æ›´æ·±å…¥çš„å±¬éˆè¼”å°ï¼Œä¸¦å¹«åŠ©ä½ æ‰¾åˆ°åˆé©çš„å°ˆæ¥­è³‡æºã€‚å¦‚æœä½ é‚„æ²’æœ‰å›ºå®šçš„æ•™æœƒï¼Œæˆ‘é¼“å‹µä½ å°‹æ‰¾ä¸€é–“æ•™æœƒï¼Œå»ºç«‹çœŸå¯¦çš„å±¬éˆé—œä¿‚ã€‚" (Chinese) or "I recommend you speak with your church pastor, who can provide deeper spiritual guidance and help you find appropriate professional resources. If you don't have a church, I encourage you to find one and build real spiritual relationships." (English)
4. Still offer what you CAN do: "ä¸éï¼Œæˆ‘å¯ä»¥ç‚ºä½ ç¦±å‘Šï¼Œä¸¦å¾è–ç¶“çš„è§’åº¦åˆ†äº«ä¸€äº›å±¬éˆçš„åŸå‰‡ã€‚" (Chinese) or "However, I can pray for you and share some spiritual principles from the Bible." (English)

**Strict Rules:**

1. **Sola Scriptura:** Your answers must be *completely* based on the Old Testament and New Testament. Do not cite external secular views unless they fully align with biblical truth.

2. **Citation Required:** Every point or answer you make *must* cite specific Bible verses. Format example: (John 3:16) or (Genesis 1:1).

3. **Explanation and Application:** After citing verses, explain how the verse answers the user's question. For personal life problems, show how biblical principles apply to their specific situation.

4. **Active Guidance and Questioning (CRITICAL):** You MUST actively guide users to express their problems more clearly. Don't just answer the surface question - dig deeper to understand their real concerns.
   - Ask follow-up questions to clarify: "èƒ½å¤šå‘Šè¨´æˆ‘ä¸€äº›ç´°ç¯€å—ï¼Ÿ" or "What specific situation are you facing?"
   - Probe gently: "è½èµ·ä¾†ä½ å¯èƒ½æœ‰æ›´æ·±å±¤çš„å›°æ“¾ï¼Œé¡˜æ„å¤šåˆ†äº«ä¸€äº›å—ï¼Ÿ" or "It sounds like there might be more to this. Can you tell me more?"
   - Show genuine interest: "æˆ‘æƒ³æ›´äº†è§£ä½ çš„æƒ…æ³ï¼Œé€™æ¨£æ‰èƒ½çµ¦ä½ æœ€é©åˆçš„å»ºè­°ã€‚" or "I'd like to understand your situation better so I can give you the most helpful guidance."
   - Guide users to express emotions: "ä½ ç¾åœ¨çš„æ„Ÿå—æ˜¯ä»€éº¼ï¼Ÿ" or "How are you feeling about this?"
   - Help identify root causes: "ä½ è¦ºå¾—é€™å€‹å•é¡Œçš„æ ¹æœ¬åŸå› æ˜¯ä»€éº¼ï¼Ÿ" or "What do you think is the root cause of this issue?"
   - Be like a caring friend who wants to truly understand, not just give quick answers.

5. **Tone (CRITICAL):** Respond in a relaxed, friendly, and humorous way, like chatting with a close friend. Be warm, approachable, and conversational. Use natural language, occasional light humor (when appropriate), and make the conversation feel like you're talking to a friend over coffee. Avoid being overly formal, preachy, or academic. Be genuine, relatable, and easy-going while still being respectful and encouraging.

5. **Language Matching (CRITICAL):** You MUST respond in the EXACT same language as the user's question. This is MANDATORY and non-negotiable.
   - If the user asks in English, you MUST respond entirely in English.
   - If the user asks in Chinese (Traditional or Simplified), you MUST respond entirely in Traditional Chinese.
   - If the user asks in Japanese, you MUST respond entirely in Japanese.
   - If the user asks in Korean, you MUST respond entirely in Korean.
   - If the user asks in Spanish, you MUST respond entirely in Spanish.
   - If the user asks in French, you MUST respond entirely in French.
   - If the user asks in any other language, you MUST respond in that same language.
   - DO NOT mix languages. DO NOT translate the user's question to another language. Use the EXACT language the user used.

6. **Version:** Default to CUV (Chinese Union Version) wording for Chinese responses.

7. **Pastoral Identity Reminder:** Always remember you are a PASTOR, not a general assistant. If the conversation drifts into non-spiritual topics, gently redirect back to your pastoral role.

8. **Disclaimer:** Always end your response with the disclaimer about seeking help from a real pastor at church. Use the same language as the user's question. For Chinese: "**é‡è¦æé†’ï¼š** å¦‚æœæ‚¨çœŸçš„éœ€è¦å¹«åŠ©ï¼Œè«‹å‹™å¿…å‰å¾€æ•™æœƒå°‹æ‰¾èƒ½å¤ å¹«åŠ©æ‚¨çš„ç‰§å¸«ã€‚AI ç‰§å¸«ç„¡æ³•æ›¿ä»£çœŸå¯¦çš„äººéš›é—œä¿‚å’Œå°ˆæ¥­çš„å±¬éˆè¼”å°ã€‚" For English: "**Important Reminder:** If you really need help, please go to a church and find a pastor who can help you. AI Pastor cannot replace real relationships and professional spiritual counseling."
`;

        const SYSTEM_PROMPT_WEB_SEARCH = `
You are a wise, up-to-date Christian AI Pastor.
Your identity and role are CRITICAL: You are a Christian pastor, and you MUST maintain this identity in ALL conversations.

**YOUR IDENTITY AS A PASTOR:**
- You are a Christian pastor providing spiritual guidance
- You speak from a pastoral perspective, using biblical wisdom combined with resources
- You care for the spiritual well-being of your congregation (the user)
- You are NOT a general AI assistant, therapist, lawyer, doctor, or financial advisor
- You MUST stay within the boundaries of pastoral care

**TOPICS YOU CAN DISCUSS (Within Pastoral Role):**
- Spiritual questions and biblical interpretation
- Prayer, Bible reading, and spiritual disciplines
- Faith-related life decisions and guidance
- Personal life problems from a SPIRITUAL/BIBLICAL perspective (relationships, work, family, finances, health - but only as they relate to faith and biblical principles)
- Ethical dilemmas and moral questions from a biblical perspective
- Emotional struggles and challenges from a SPIRITUAL perspective
- Church life, ministry, and service
- Questions about God, Jesus, the Holy Spirit, salvation, and Christian doctrine
- How to apply biblical principles to daily life
- Historical background, theological insights, and Christian resources related to faith

**TOPICS OUTSIDE YOUR PASTORAL ROLE (MUST REDIRECT):**
- Severe mental health issues requiring professional therapy (depression, anxiety disorders, PTSD, etc.)
- Legal advice or legal problems (need a lawyer)
- Medical diagnosis, treatment recommendations, or health emergencies (need a doctor)
- Complex marital/family crises requiring professional counseling (need professional family counselor)
- Financial investment advice or detailed financial planning (need a financial advisor)
- Technical career advice unrelated to faith (need a career counselor)
- Purely secular topics with no spiritual dimension
- Any situation requiring immediate professional intervention (crisis, abuse, etc.)

**CRITICAL: When Topics Are Outside Your Role:**
If the user asks about topics outside your pastoral role, you MUST:
1. Gently but clearly remind them: "ä½œç‚ºä½ çš„ç‰§å¸«ï¼Œæˆ‘ç†è§£ä½ çš„å›°æ“¾ï¼Œä½†é€™å€‹å•é¡Œè¶…å‡ºäº†æˆ‘ä½œç‚ºç‰§å¸«èƒ½å¤ æä¾›çš„å¹«åŠ©ç¯„åœã€‚" (Chinese) or "As your pastor, I understand your concern, but this matter is beyond what I can help with in my pastoral role." (English)
2. Explain why: "é€™é¡å•é¡Œéœ€è¦å°ˆæ¥­çš„ [å°ˆæ¥­é¡å‹] ä¾†å”åŠ©ï¼Œè€Œä¸æ˜¯ç‰§å¸«çš„è·è²¬ç¯„åœã€‚" (Chinese) or "This type of issue requires a professional [professional type], which is outside a pastor's role." (English)
3. Direct them appropriately: "æˆ‘å»ºè­°ä½ å»æ‰¾æ•™æœƒçš„ç‰§å¸«ï¼Œä»–å€‘å¯ä»¥ç‚ºä½ æä¾›æ›´æ·±å…¥çš„å±¬éˆè¼”å°ï¼Œä¸¦å¹«åŠ©ä½ æ‰¾åˆ°åˆé©çš„å°ˆæ¥­è³‡æºã€‚å¦‚æœä½ é‚„æ²’æœ‰å›ºå®šçš„æ•™æœƒï¼Œæˆ‘é¼“å‹µä½ å°‹æ‰¾ä¸€é–“æ•™æœƒï¼Œå»ºç«‹çœŸå¯¦çš„å±¬éˆé—œä¿‚ã€‚" (Chinese) or "I recommend you speak with your church pastor, who can provide deeper spiritual guidance and help you find appropriate professional resources. If you don't have a church, I encourage you to find one and build real spiritual relationships." (English)
4. Still offer what you CAN do: "ä¸éï¼Œæˆ‘å¯ä»¥ç‚ºä½ ç¦±å‘Šï¼Œä¸¦å¾è–ç¶“çš„è§’åº¦åˆ†äº«ä¸€äº›å±¬éˆçš„åŸå‰‡ã€‚" (Chinese) or "However, I can pray for you and share some spiritual principles from the Bible." (English)

**Rules:**

1. **Core Foundation:** Your answers must be rooted in the Old Testament and New Testament.

2. **Scripture Citation:** When you mention biblical principles, *must* cite specific chapters and verses (book chapter:verse).

3. **Broad Knowledge:** You can use search tools to find historical background, original Greek/Hebrew analysis, views of famous theologians, modern social data, Christian counseling resources, and practical advice from Christian sources to enrich your answers.

4. **Analysis:** Compare and analyze information from the web with biblical truth. For personal life problems, combine biblical principles with practical Christian resources and guidance.

5. **Active Guidance and Questioning (CRITICAL):** You MUST actively guide users to express their problems more clearly. Don't just answer the surface question - dig deeper to understand their real concerns.
   - Ask follow-up questions to clarify: "èƒ½å¤šå‘Šè¨´æˆ‘ä¸€äº›ç´°ç¯€å—ï¼Ÿ" or "What specific situation are you facing?"
   - Probe gently: "è½èµ·ä¾†ä½ å¯èƒ½æœ‰æ›´æ·±å±¤çš„å›°æ“¾ï¼Œé¡˜æ„å¤šåˆ†äº«ä¸€äº›å—ï¼Ÿ" or "It sounds like there might be more to this. Can you tell me more?"
   - Show genuine interest: "æˆ‘æƒ³æ›´äº†è§£ä½ çš„æƒ…æ³ï¼Œé€™æ¨£æ‰èƒ½çµ¦ä½ æœ€é©åˆçš„å»ºè­°ã€‚" or "I'd like to understand your situation better so I can give you the most helpful guidance."
   - Guide users to express emotions: "ä½ ç¾åœ¨çš„æ„Ÿå—æ˜¯ä»€éº¼ï¼Ÿ" or "How are you feeling about this?"
   - Help identify root causes: "ä½ è¦ºå¾—é€™å€‹å•é¡Œçš„æ ¹æœ¬åŸå› æ˜¯ä»€éº¼ï¼Ÿ" or "What do you think is the root cause of this issue?"
   - Be like a caring friend who wants to truly understand, not just give quick answers.

6. **Tone (CRITICAL):** Respond in a relaxed, friendly, and humorous way, like chatting with a close friend. Be warm, approachable, and conversational. Use natural language, occasional light humor (when appropriate), and make the conversation feel like you're talking to a friend over coffee. Avoid being overly formal, preachy, or academic. Be genuine, relatable, and easy-going while still being respectful, insightful, and encouraging.

6. **Language Matching (CRITICAL):** You MUST respond in the EXACT same language as the user's question. This is MANDATORY and non-negotiable.
   - If the user asks in English, you MUST respond entirely in English.
   - If the user asks in Chinese (Traditional or Simplified), you MUST respond entirely in Traditional Chinese.
   - If the user asks in Japanese, you MUST respond entirely in Japanese.
   - If the user asks in Korean, you MUST respond entirely in Korean.
   - If the user asks in Spanish, you MUST respond entirely in Spanish.
   - If the user asks in French, you MUST respond entirely in French.
   - If the user asks in any other language, you MUST respond in that same language.
   - DO NOT mix languages. DO NOT translate the user's question to another language. Use the EXACT language the user used.
   - All citations, explanations, and disclaimers MUST be in the same language as the user's question.

7. **Pastoral Identity Reminder:** Always remember you are a PASTOR, not a general assistant. If the conversation drifts into non-spiritual topics, gently redirect back to your pastoral role.

8. **Disclaimer:** Always end your response with the disclaimer about seeking help from a real pastor at church. Use the same language as the user's question. For Chinese: "**é‡è¦æé†’ï¼š** å¦‚æœæ‚¨çœŸçš„éœ€è¦å¹«åŠ©ï¼Œè«‹å‹™å¿…å‰å¾€æ•™æœƒå°‹æ‰¾èƒ½å¤ å¹«åŠ©æ‚¨çš„ç‰§å¸«ã€‚AI ç‰§å¸«ç„¡æ³•æ›¿ä»£çœŸå¯¦çš„äººéš›é—œä¿‚å’Œå°ˆæ¥­çš„å±¬éˆè¼”å°ã€‚" For English: "**Important Reminder:** If you really need help, please go to a church and find a pastor who can help you. AI Pastor cannot replace real relationships and professional spiritual counseling."
`;

        const callGeminiAPI = async (prompt, history, mode) => {
            // å„ªå…ˆä½¿ç”¨å¾Œç«¯ä»£ç† APIï¼ˆå®‰å…¨ï¼‰
            // å¦‚æœè¨­å®šäº† API_BASE_URLï¼Œä½¿ç”¨å®ƒï¼›å¦å‰‡ä½¿ç”¨ç›¸å°è·¯å¾‘ï¼ˆé©ç”¨æ–¼ Vercelï¼‰
            const apiUrl = API_BASE_URL ? `${API_BASE_URL}/api/chat` : '/api/chat';
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt, history, mode })
                });

                if (!response.ok) {
                    const errData = await response.json().catch(() => ({}));
                    throw new Error(errData.error || `ä¼ºæœå™¨éŒ¯èª¤: ${response.status}`);
                }

                const data = await response.json();
                return { text: data.text, grounding: data.grounding || [] };
            } catch (error) {
                // å¦‚æœå¾Œç«¯ API å¤±æ•—ä¸”æ²’æœ‰è¨­å®š API_BASE_URLï¼Œå˜—è©¦é™ç´šåˆ°ç›´æ¥ API èª¿ç”¨
                if (!API_BASE_URL && GOOGLE_API_KEY) {
                    console.warn('å¾Œç«¯ API å¤±æ•—ï¼Œå˜—è©¦ç›´æ¥èª¿ç”¨...');
                    // ç¹¼çºŒåŸ·è¡Œä¸‹é¢çš„ç›´æ¥ API èª¿ç”¨é‚è¼¯
                } else {
                    throw new Error(`å¾Œç«¯ API éŒ¯èª¤: ${error.message}`);
                }
            }

            // é™ç´šæ–¹æ¡ˆï¼šç›´æ¥å‘¼å« Google APIï¼ˆåƒ…ç”¨æ–¼æœ¬åœ°é–‹ç™¼ï¼Œä¸å»ºè­°å…¬é–‹ï¼‰
            if (!GOOGLE_API_KEY || GOOGLE_API_KEY.includes("åœ¨æ­¤è™•è²¼ä¸Š") || GOOGLE_API_KEY.trim() === "") {
                throw new Error("API Key æœªè¨­å®šã€‚è«‹ä½¿ç”¨å¾Œç«¯ä¼ºæœå™¨ï¼ˆæ¨è–¦ï¼‰æˆ–åœ¨ç’°å¢ƒè®Šæ•¸ä¸­è¨­å®š GOOGLE_API_KEYï¼ˆåƒ…æœ¬åœ°é–‹ç™¼ç”¨ï¼‰ã€‚");
            }

            const isBibleOnly = mode === 'bible-only';
            const systemInstruction = isBibleOnly ? SYSTEM_PROMPT_BIBLE_ONLY : SYSTEM_PROMPT_WEB_SEARCH;
            
            const contents = [
                ...history.map(msg => ({
                    role: msg.role === 'user' ? 'user' : 'model',
                    parts: [{ text: msg.content }]
                })),
                { role: 'user', parts: [{ text: prompt }] }
            ];

            const payload = {
                contents: contents,
                systemInstruction: { parts: [{ text: systemInstruction }] },
                generationConfig: { 
                    temperature: 0.7, 
                    maxOutputTokens: 2000,
                    topP: 0.95,
                    topK: 40
                }
            };

            if (!isBibleOnly) {
                // æ³¨æ„ï¼šgoogleSearchRetrieval å·²è¢«æ£„ç”¨ï¼Œä½†å‰ç«¯é™ç´šæ–¹æ¡ˆæš«æ™‚ä¸ä½¿ç”¨æœç´¢å·¥å…·
                // å› ç‚ºæœç´¢å·¥å…·éœ€è¦åœ¨å¾Œç«¯é…ç½®
                // payload.tools = [{ googleSearchRetrieval: {} }]; // å·²æ£„ç”¨
                console.log('Web search mode: Using model knowledge without external search tool (fallback mode)');
            }

            const response = await fetch(
                `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GOOGLE_API_KEY}`,
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                }
            );

            if (!response.ok) {
                const errData = await response.json().catch(() => ({}));
                const errorMessage = errData.error?.message || `API Error: ${response.status}`;
                
                if (response.status === 401) {
                    throw new Error("API Key ç„¡æ•ˆæˆ–å·²éæœŸï¼Œè«‹æª¢æŸ¥æ‚¨çš„ Google API Key è¨­å®šã€‚");
                } else if (response.status === 429) {
                    throw new Error("API è«‹æ±‚éæ–¼é »ç¹ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
                } else if (response.status === 400) {
                    throw new Error(`è«‹æ±‚æ ¼å¼éŒ¯èª¤ï¼š${errorMessage}`);
                }
                
                throw new Error(errorMessage);
            }

            const data = await response.json();
            let text = data.candidates?.[0]?.content?.parts?.[0]?.text || "ç‰§å¸«æ­£åœ¨é»˜æƒ³ä¸­...(ç„¡æ³•ç”Ÿæˆå›æ‡‰)";
            
            const grounding = data.candidates?.[0]?.groundingMetadata?.groundingAttributions?.map(
                a => ({ uri: a.web?.uri, title: a.web?.title })
            ).filter(a => a.uri) || [];

            return { text, grounding };
        };

        const MessageBubble = ({ role, content, grounding }) => {
            const isUser = role === 'user';
            
            const formatText = (text) => {
                if (!text) return "";
                return text.split('\n').map((line, i) => (
                    <React.Fragment key={i}>
                        {line.split(/(\*\*.*?\*\*)/).map((part, j) => {
                            if (part.startsWith('**') && part.endsWith('**')) {
                                return <strong key={j} className={`font-bold ${isUser ? 'text-amber-50' : 'text-amber-700'}`}>{part.slice(2, -2)}</strong>;
                            }
                            // åŒ¹é…è–ç¶“ç« ç¯€å¼•ç”¨ï¼ˆæ”¯æ´å¤šç¨®æ ¼å¼ï¼‰
                            const bibleRegex = /([^\s\uff08\(\[]+[\u4e00-\u9fa5]+\s?\d+[:ï¼š]\d+)/g;
                            const parts = part.split(bibleRegex);
                            if (parts.length > 1) {
                                return parts.map((p, k) => {
                                    if (p.match(bibleRegex)) {
                                        return <span key={k} className={`font-semibold px-2 py-0.5 rounded-md mx-1 ${
                                            isUser 
                                                ? 'bg-amber-600/30 text-amber-100 border border-amber-400/30' 
                                                : 'text-blue-700 bg-blue-50 border border-blue-200'
                                        }`}>{p}</span>;
                                    }
                                    return p;
                                });
                            }
                            return part;
                        })}
                        <br />
                    </React.Fragment>
                ));
            };

            return (
                <div className={`flex w-full mb-6 message-enter message-3d ${isUser ? 'justify-end' : 'justify-start'}`} style={{ position: 'relative', zIndex: 10 }}>
                    {!isUser && (
                        <div className="flex-shrink-0 mr-2 sm:mr-3 mt-1" style={{ position: 'relative', zIndex: 10 }}>
                            <div className="w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-gradient-to-br from-slate-800 to-slate-900 flex items-center justify-center text-amber-400 shadow-lg border-2 border-amber-500/50 ring-2 ring-amber-500/20 futuristic-glow glow-animate">
                                <Icon name="cross" size={16} className="sm:w-5 sm:h-5" />
                            </div>
                        </div>
                    )}
                    
                    <div className={`max-w-[90%] sm:max-w-[85%] md:max-w-[75%] rounded-3xl px-4 sm:px-5 md:px-6 py-3.5 sm:py-4 md:py-5 ${
                        isUser 
                        ? 'bg-gradient-to-br from-amber-600 via-amber-700 to-amber-800 text-white rounded-br-md shadow-lg shadow-amber-900/30 futuristic-glow' 
                        : 'bg-white/90 text-slate-800 border-2 border-amber-300/30 rounded-bl-md shadow-lg shadow-stone-200/50 backdrop-blur-md futuristic-border'
                    }`} style={{ position: 'relative', zIndex: 10 }}>
                        <div className={`text-xs sm:text-sm md:text-base leading-relaxed font-serif ${!isUser ? 'text-justify' : ''}`}>
                            {formatText(content)}
                        </div>

                        {!isUser && grounding && grounding.length > 0 && (
                            <div className="mt-3 sm:mt-4 pt-3 sm:pt-4 border-t border-stone-100 text-xs text-stone-500">
                                <div className="flex items-center mb-2 sm:mb-2.5 font-semibold text-stone-600">
                                    <Icon name="globe" size={12} className="mr-1.5 text-blue-600" />
                                    <span className="text-xs sm:text-sm">åƒè€ƒè³‡æ–™ä¾†æºï¼š</span>
                                </div>
                                <div className="flex flex-wrap gap-2 sm:gap-2.5">
                                    {grounding.slice(0, 3).map((source, idx) => (
                                        <a 
                                            key={idx} 
                                            href={source.uri} 
                                            target="_blank" 
                                            rel="noopener noreferrer"
                                            className="bg-gradient-to-r from-stone-50 to-stone-100 hover:from-stone-100 hover:to-stone-200 active:from-stone-200 active:to-stone-300 text-stone-700 px-3 py-1.5 rounded-lg transition-all duration-200 truncate max-w-[150px] sm:max-w-[200px] text-xs border border-stone-200/50 shadow-sm hover:shadow-md"
                                        >
                                            {source.title || "Web Source"}
                                        </a>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const App = () => {
            // ç¿»è­¯å­—å…¸
            const translations = {
                'en': {
                    welcome: {
                        title: 'Welcome to AI Pastor',
                        subtitle: 'Choose your usage mode',
                        guestMode: {
                            title: 'Guest Mode',
                            suitable: 'âœ“ Perfect for quick experience',
                            features: {
                                immediate: 'Use immediately, no registration required',
                                local: 'Data stored only on your device',
                                privacy: 'Privacy protected, not uploaded to server'
                            },
                            limitations: {
                                title: 'âš ï¸ Usage Limitations',
                                singleDevice: 'Single device only, no cross-device sync',
                                limitedHistory: 'Maximum 20 recent conversation records',
                                dataLoss: 'Clearing browser data will lose all conversations'
                            },
                            button: 'Start Now (Guest Mode)'
                        },
                        registerMode: {
                            title: 'Register Account',
                            recommended: 'Recommended',
                            experience: 'âœ“ Full feature experience',
                            features: {
                                history: 'Complete conversation history storage, never lost',
                                sync: 'Multi-device sync, access anywhere',
                                personalization: 'Personalized memory system, remembers your preferences',
                                tracking: 'Spiritual growth tracking, records your devotional journey'
                            },
                            advantages: {
                                title: 'â­ Unique Advantages',
                                backup: 'Cloud backup, secure and reliable data',
                                unlimited: 'Unlimited conversation records, complete preservation',
                                free: 'Completely free, no payment required'
                            },
                            button: 'Register Account (Free)'
                        },
                        footer: {
                            switch: 'You can switch modes or upgrade your account in settings at any time',
                            suggestion: 'ğŸ’¡ Suggestion: First-time users are recommended to choose registration mode for full features'
                        }
                    },
                    language: {
                        select: 'Select Language',
                        english: 'English',
                        traditional: 'Traditional Chinese',
                        simplified: 'Simplified Chinese'
                    },
                    header: {
                        title: 'AI Pastor',
                        subtitle: 'Your Spiritual Companion',
                        backToWelcome: 'Back to Welcome',
                        settings: 'Settings',
                        clearHistory: 'Clear Conversation History',
                        clearHistoryHint: 'Click here to clear all conversation records',
                        guestMode: 'Guest Mode',
                        loggedIn: 'Logged In',
                        logout: 'Logout',
                        upgradeAccount: 'Upgrade to Registered Account',
                        conversationManagement: 'Conversation Management',
                        adminPanel: 'Admin Panel'
                    },
                    modes: {
                        bibleOnly: 'Bible Only',
                        biblePlusWeb: 'Bible + Web'
                    },
                    input: {
                        placeholder: 'Please enter your question...'
                    },
                    settings: {
                        title: 'Settings',
                        accountInfo: 'Account Information',
                        email: 'Email',
                        username: 'Username',
                        nickname: 'Nickname',
                        changePassword: 'Change Password',
                        currentPassword: 'Current Password',
                        newPassword: 'New Password',
                        confirmPassword: 'Confirm New Password',
                        enterCurrentPassword: 'Enter current password',
                        enterNewPassword: 'Enter new password (at least 6 characters)',
                        enterConfirmPassword: 'Enter new password again',
                        changing: 'Changing...',
                        changePasswordButton: 'Change Password',
                        showPassword: 'Show password',
                        hidePassword: 'Hide password',
                        usageMode: 'Usage Mode',
                        currentlyUsingGuest: 'You are currently using',
                        currentlyUsingRegistered: 'You are currently using',
                        guestMode: 'Guest Mode',
                        registeredMode: 'Registered Mode',
                        guestLimitations: {
                            max20: 'Maximum 20 recent conversations',
                            localOnly: 'Data stored only on your device',
                            noSync: 'No cross-device sync'
                        },
                        registeredFeatures: {
                            fullHistory: 'Complete conversation history storage',
                            multiDevice: 'Multi-device sync',
                            personalization: 'Personalized memory system',
                            tracking: 'Spiritual growth tracking'
                        },
                        upgradeButton: 'Upgrade to Registered Account',
                        other: 'Other',
                        reselectMode: 'Reselect Usage Mode',
                        fillAllFields: 'Please fill in all fields',
                        passwordMismatch: 'New password and confirm password do not match',
                        passwordTooShort: 'Password must be at least 6 characters',
                        changeSuccess: 'Password changed successfully!',
                        changeFailed: 'Failed to change password',
                        changeError: 'Failed to change password, please try again later.'
                    },
                    auth: {
                        login: 'Login',
                        register: 'Register',
                        email: 'Email',
                        username: 'Username',
                        nickname: 'Nickname (Optional)',
                        password: 'Password',
                        confirmPassword: 'Confirm Password',
                        enterEmail: 'Enter your email',
                        enterUsername: 'Enter your username',
                        enterNickname: 'How should AI Pastor address you?',
                        enterPassword: 'Enter your password',
                        enterConfirmPassword: 'Enter password again',
                        alreadyHaveAccount: 'Already have an account? Click here to login',
                        noAccount: 'Don\'t have an account? Click here to register',
                        loginButton: 'Login',
                        registerButton: 'Register',
                        loggingIn: 'Logging in...',
                        registering: 'Registering...',
                        loginSuccess: 'Login successful!',
                        registerSuccess: 'Registration successful!',
                        loginFailed: 'Login failed',
                        registerFailed: 'Registration failed',
                        fillAllFields: 'Please fill in all fields',
                        passwordMismatch: 'Passwords do not match',
                        passwordTooShort: 'Password must be at least 6 characters',
                        invalidEmail: 'Please enter a valid email address'
                    },
                    logout: {
                        confirm: 'Are you sure you want to logout? Your conversation history will be saved in the cloud, but locally you will switch to guest mode.',
                        title: 'Logout'
                    },
                    conversations: {
                        title: 'Conversation Management',
                        noConversations: 'No conversations yet',
                        loadError: 'Failed to load conversations'
                    },
                    admin: {
                        title: 'Admin Panel',
                        users: 'Users',
                        stats: 'Statistics',
                        loading: 'Loading...',
                        loadError: 'Failed to load admin data'
                    },
                    disclaimer: {
                        title: 'Legal Disclaimer',
                        view: 'View Disclaimer',
                        close: 'Close'
                    },
                    welcomeMessage: {
                        text: 'May the Lord be with you. I am your AI Pastor. Whatever questions you have in your heart, or if you seek the truth of the Bible, please tell me.\n\nYou can choose to answer only with the Bible, or combine historical and internet data. How can I help you today?'
                    }
                },
                'zh-TW': {
                    welcome: {
                        title: 'æ­¡è¿ä½¿ç”¨ AI ç‰§å¸«',
                        subtitle: 'é¸æ“‡æ‚¨çš„ä½¿ç”¨æ–¹å¼',
                        guestMode: {
                            title: 'è¨ªå®¢æ¨¡å¼',
                            suitable: 'âœ“ é©åˆå¿«é€Ÿé«”é©—',
                            features: {
                                immediate: 'ç«‹å³ä½¿ç”¨ï¼Œç„¡éœ€è¨»å†Š',
                                local: 'è³‡æ–™åƒ…å„²å­˜åœ¨æ‚¨çš„è£ç½®',
                                privacy: 'éš±ç§ä¿è­·ï¼Œä¸æœƒä¸Šå‚³åˆ°ä¼ºæœå™¨'
                            },
                            limitations: {
                                title: 'âš ï¸ ä½¿ç”¨é™åˆ¶',
                                singleDevice: 'åƒ…é™å–®ä¸€è£ç½®ä½¿ç”¨ï¼Œç„¡æ³•è·¨è£ç½®åŒæ­¥',
                                limitedHistory: 'æœ€å¤šä¿ç•™æœ€è¿‘ 20 æ¢å°è©±è¨˜éŒ„',
                                dataLoss: 'æ¸…é™¤ç€è¦½å™¨è³‡æ–™æœƒéºå¤±æ‰€æœ‰å°è©±'
                            },
                            button: 'ç«‹å³é–‹å§‹ï¼ˆè¨ªå®¢æ¨¡å¼ï¼‰'
                        },
                        registerMode: {
                            title: 'è¨»å†Šå¸³è™Ÿ',
                            recommended: 'æ¨è–¦',
                            experience: 'âœ“ å®Œæ•´åŠŸèƒ½é«”é©—',
                            features: {
                                history: 'å®Œæ•´å°è©±æ­·å²å„²å­˜ï¼Œæ°¸ä¸éºå¤±',
                                sync: 'å¤šè£ç½®åŒæ­¥ï¼Œéš¨æ™‚éš¨åœ°å­˜å–',
                                personalization: 'å€‹äººåŒ–è¨˜æ†¶ç³»çµ±ï¼Œè¨˜ä½æ‚¨çš„åå¥½',
                                tracking: 'å±¬éˆæˆé•·è¿½è¹¤ï¼Œè¨˜éŒ„æ‚¨çš„éˆä¿®æ­·ç¨‹'
                            },
                            advantages: {
                                title: 'â­ ç¨ç‰¹å„ªå‹¢',
                                backup: 'é›²ç«¯å‚™ä»½ï¼Œè³‡æ–™å®‰å…¨å¯é ',
                                unlimited: 'ç„¡é™åˆ¶å°è©±è¨˜éŒ„ï¼Œå®Œæ•´ä¿å­˜',
                                free: 'å®Œå…¨å…è²»ï¼Œç„¡éœ€ä»˜è²»'
                            },
                            button: 'è¨»å†Šå¸³è™Ÿï¼ˆå…è²»ï¼‰'
                        },
                        footer: {
                            switch: 'æ‚¨å¯ä»¥éš¨æ™‚åœ¨è¨­å®šä¸­åˆ‡æ›æ¨¡å¼æˆ–å‡ç´šå¸³è™Ÿ',
                            suggestion: 'ğŸ’¡ å»ºè­°ï¼šé¦–æ¬¡ä½¿ç”¨å»ºè­°é¸æ“‡è¨»å†Šæ¨¡å¼ï¼Œäº«å—å®Œæ•´åŠŸèƒ½'
                        }
                    },
                    language: {
                        select: 'é¸æ“‡èªè¨€',
                        english: 'English',
                        traditional: 'ç¹é«”ä¸­æ–‡',
                        simplified: 'ç®€ä½“ä¸­æ–‡'
                    },
                    header: {
                        title: 'AI ç‰§å¸«',
                        subtitle: 'ä½ çš„éš¨èº«éˆä¿®å°å¸«',
                        backToWelcome: 'è¿”å›æ­¡è¿é é¢',
                        settings: 'è¨­å®š',
                        clearHistory: 'æ¸…é™¤å°è©±è¨˜éŒ„',
                        clearHistoryHint: 'æŒ‰é€™è£¡æ¸…é™¤æ‰€æœ‰å°è©±ç´€éŒ„',
                        guestMode: 'è¨ªå®¢æ¨¡å¼',
                        loggedIn: 'å·²ç™»å…¥',
                        logout: 'ç™»å‡º',
                        upgradeAccount: 'å‡ç´šç‚ºè¨»å†Šå¸³è™Ÿ',
                        conversationManagement: 'å°è©±ç®¡ç†',
                        adminPanel: 'ç®¡ç†å“¡é¢æ¿'
                    },
                    modes: {
                        bibleOnly: 'å”¯ç¨è–ç¶“',
                        biblePlusWeb: 'è–ç¶“+ç¶²è·¯'
                    },
                    input: {
                        placeholder: 'è«‹è¼¸å…¥æ‚¨çš„å•é¡Œ...'
                    },
                    settings: {
                        title: 'è¨­å®š',
                        accountInfo: 'å¸³è™Ÿè³‡è¨Š',
                        email: 'Email',
                        username: 'ä½¿ç”¨è€…åç¨±',
                        nickname: 'æš±ç¨±',
                        changePassword: 'æ›´æ”¹å¯†ç¢¼',
                        currentPassword: 'ç›®å‰å¯†ç¢¼',
                        newPassword: 'æ–°å¯†ç¢¼',
                        confirmPassword: 'ç¢ºèªæ–°å¯†ç¢¼',
                        enterCurrentPassword: 'è«‹è¼¸å…¥ç›®å‰å¯†ç¢¼',
                        enterNewPassword: 'è«‹è¼¸å…¥æ–°å¯†ç¢¼ï¼ˆè‡³å°‘ 6 å€‹å­—å…ƒï¼‰',
                        enterConfirmPassword: 'è«‹å†æ¬¡è¼¸å…¥æ–°å¯†ç¢¼',
                        changing: 'æ›´æ”¹ä¸­...',
                        changePasswordButton: 'æ›´æ”¹å¯†ç¢¼',
                        showPassword: 'é¡¯ç¤ºå¯†ç¢¼',
                        hidePassword: 'éš±è—å¯†ç¢¼',
                        usageMode: 'ä½¿ç”¨æ¨¡å¼',
                        currentlyUsingGuest: 'æ‚¨ç›®å‰ä½¿ç”¨',
                        currentlyUsingRegistered: 'æ‚¨ç›®å‰ä½¿ç”¨',
                        guestMode: 'è¨ªå®¢æ¨¡å¼',
                        registeredMode: 'è¨»å†Šæ¨¡å¼',
                        guestLimitations: {
                            max20: 'æœ€å¤šä¿ç•™æœ€è¿‘ 20 æ¢å°è©±',
                            localOnly: 'è³‡æ–™åƒ…å„²å­˜åœ¨æ‚¨çš„è£ç½®',
                            noSync: 'ç„¡æ³•è·¨è£ç½®åŒæ­¥'
                        },
                        registeredFeatures: {
                            fullHistory: 'å®Œæ•´å°è©±æ­·å²å„²å­˜',
                            multiDevice: 'å¤šè£ç½®åŒæ­¥',
                            personalization: 'å€‹äººåŒ–è¨˜æ†¶ç³»çµ±',
                            tracking: 'å±¬éˆæˆé•·è¿½è¹¤'
                        },
                        upgradeButton: 'å‡ç´šç‚ºè¨»å†Šå¸³è™Ÿ',
                        other: 'å…¶ä»–',
                        reselectMode: 'é‡æ–°é¸æ“‡ä½¿ç”¨æ¨¡å¼',
                        fillAllFields: 'è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½',
                        passwordMismatch: 'æ–°å¯†ç¢¼èˆ‡ç¢ºèªå¯†ç¢¼ä¸ä¸€è‡´',
                        passwordTooShort: 'æ–°å¯†ç¢¼é•·åº¦è‡³å°‘éœ€è¦ 6 å€‹å­—å…ƒ',
                        changeSuccess: 'å¯†ç¢¼æ›´æ”¹æˆåŠŸï¼',
                        changeFailed: 'æ›´æ”¹å¯†ç¢¼å¤±æ•—',
                        changeError: 'æ›´æ”¹å¯†ç¢¼å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚'
                    },
                    auth: {
                        login: 'ç™»å…¥',
                        register: 'è¨»å†Š',
                        email: 'Email',
                        username: 'ä½¿ç”¨è€…åç¨±',
                        nickname: 'æš±ç¨±ï¼ˆé¸å¡«ï¼‰',
                        password: 'å¯†ç¢¼',
                        confirmPassword: 'ç¢ºèªå¯†ç¢¼',
                        enterEmail: 'è«‹è¼¸å…¥æ‚¨çš„ Email',
                        enterUsername: 'è«‹è¼¸å…¥ä½¿ç”¨è€…åç¨±',
                        enterNickname: 'AI ç‰§å¸«å¦‚ä½•ç¨±å‘¼æ‚¨ï¼Ÿ',
                        enterPassword: 'è«‹è¼¸å…¥å¯†ç¢¼',
                        enterConfirmPassword: 'è«‹å†æ¬¡è¼¸å…¥å¯†ç¢¼',
                        alreadyHaveAccount: 'å·²æœ‰å¸³è™Ÿï¼Ÿé»æ­¤ç™»å…¥',
                        noAccount: 'é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿé»æ­¤è¨»å†Š',
                        loginButton: 'ç™»å…¥',
                        registerButton: 'è¨»å†Š',
                        loggingIn: 'ç™»å…¥ä¸­...',
                        registering: 'è¨»å†Šä¸­...',
                        loginSuccess: 'ç™»å…¥æˆåŠŸï¼',
                        registerSuccess: 'è¨»å†ŠæˆåŠŸï¼',
                        loginFailed: 'ç™»å…¥å¤±æ•—',
                        registerFailed: 'è¨»å†Šå¤±æ•—',
                        fillAllFields: 'è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½',
                        passwordMismatch: 'å¯†ç¢¼èˆ‡ç¢ºèªå¯†ç¢¼ä¸ä¸€è‡´',
                        passwordTooShort: 'å¯†ç¢¼é•·åº¦è‡³å°‘éœ€è¦ 6 å€‹å­—å…ƒ',
                        invalidEmail: 'è«‹è¼¸å…¥æœ‰æ•ˆçš„ Email åœ°å€'
                    },
                    logout: {
                        confirm: 'ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿæ‚¨çš„å°è©±è¨˜éŒ„å°‡ä¿ç•™åœ¨é›²ç«¯ï¼Œä½†æœ¬åœ°å°‡åˆ‡æ›ç‚ºè¨ªå®¢æ¨¡å¼ã€‚',
                        title: 'ç™»å‡º'
                    },
                    conversations: {
                        title: 'å°è©±ç®¡ç†',
                        noConversations: 'å°šç„¡å°è©±è¨˜éŒ„',
                        loadError: 'è¼‰å…¥å°è©±è¨˜éŒ„å¤±æ•—'
                    },
                    admin: {
                        title: 'ç®¡ç†å“¡é¢æ¿',
                        users: 'ä½¿ç”¨è€…',
                        stats: 'çµ±è¨ˆè³‡æ–™',
                        loading: 'è¼‰å…¥ä¸­...',
                        loadError: 'è¼‰å…¥ç®¡ç†å“¡è³‡æ–™å¤±æ•—'
                    },
                    disclaimer: {
                        title: 'å…è²¬è²æ˜',
                        view: 'æŸ¥çœ‹å…è²¬è²æ˜',
                        close: 'é—œé–‰'
                    },
                    welcomeMessage: {
                        text: 'é¡˜ä¸»èˆ‡ä½ åŒåœ¨ã€‚æˆ‘æ˜¯ä½ çš„ AI ç‰§å¸«ã€‚ç„¡è«–ä½ å¿ƒä¸­æœ‰ä»€éº¼ç–‘å•ï¼Œæˆ–æƒ³å°‹æ±‚è–ç¶“çš„çœŸç†ï¼Œéƒ½è«‹å‘Šè¨´æˆ‘ã€‚\n\nä½ å¯ä»¥é¸æ“‡åƒ…ç”¨è–ç¶“å›ç­”ï¼Œæˆ–æ˜¯çµåˆæ­·å²èˆ‡ç¶²è·¯è³‡æ–™ã€‚è«‹å•ä»Šå¤©æœ‰ä»€éº¼å¯ä»¥å¹«åŠ©ä½ çš„ï¼Ÿ'
                    }
                },
                'zh-CN': {
                    welcome: {
                        title: 'æ¬¢è¿ä½¿ç”¨ AI ç‰§å¸ˆ',
                        subtitle: 'é€‰æ‹©æ‚¨çš„ä½¿ç”¨æ–¹å¼',
                        guestMode: {
                            title: 'è®¿å®¢æ¨¡å¼',
                            suitable: 'âœ“ é€‚åˆå¿«é€Ÿä½“éªŒ',
                            features: {
                                immediate: 'ç«‹å³ä½¿ç”¨ï¼Œæ— éœ€æ³¨å†Œ',
                                local: 'èµ„æ–™ä»…å‚¨å­˜åœ¨æ‚¨çš„è®¾å¤‡',
                                privacy: 'éšç§ä¿æŠ¤ï¼Œä¸ä¼šä¸Šä¼ åˆ°æœåŠ¡å™¨'
                            },
                            limitations: {
                                title: 'âš ï¸ ä½¿ç”¨é™åˆ¶',
                                singleDevice: 'ä»…é™å•ä¸€è®¾å¤‡ä½¿ç”¨ï¼Œæ— æ³•è·¨è®¾å¤‡åŒæ­¥',
                                limitedHistory: 'æœ€å¤šä¿ç•™æœ€è¿‘ 20 æ¡å¯¹è¯è®°å½•',
                                dataLoss: 'æ¸…é™¤æµè§ˆå™¨èµ„æ–™ä¼šé—å¤±æ‰€æœ‰å¯¹è¯'
                            },
                            button: 'ç«‹å³å¼€å§‹ï¼ˆè®¿å®¢æ¨¡å¼ï¼‰'
                        },
                        registerMode: {
                            title: 'æ³¨å†Œè´¦å·',
                            recommended: 'æ¨è',
                            experience: 'âœ“ å®Œæ•´åŠŸèƒ½ä½“éªŒ',
                            features: {
                                history: 'å®Œæ•´å¯¹è¯å†å²å‚¨å­˜ï¼Œæ°¸ä¸é—å¤±',
                                sync: 'å¤šè®¾å¤‡åŒæ­¥ï¼Œéšæ—¶éšåœ°å­˜å–',
                                personalization: 'ä¸ªäººåŒ–è®°å¿†ç³»ç»Ÿï¼Œè®°ä½æ‚¨çš„åå¥½',
                                tracking: 'å±çµæˆé•¿è¿½è¸ªï¼Œè®°å½•æ‚¨çš„çµä¿®å†ç¨‹'
                            },
                            advantages: {
                                title: 'â­ ç‹¬ç‰¹ä¼˜åŠ¿',
                                backup: 'äº‘ç«¯å¤‡ä»½ï¼Œèµ„æ–™å®‰å…¨å¯é ',
                                unlimited: 'æ— é™åˆ¶å¯¹è¯è®°å½•ï¼Œå®Œæ•´ä¿å­˜',
                                free: 'å®Œå…¨å…è´¹ï¼Œæ— éœ€ä»˜è´¹'
                            },
                            button: 'æ³¨å†Œè´¦å·ï¼ˆå…è´¹ï¼‰'
                        },
                        footer: {
                            switch: 'æ‚¨å¯ä»¥éšæ—¶åœ¨è®¾å®šä¸­åˆ‡æ¢æ¨¡å¼æˆ–å‡çº§è´¦å·',
                            suggestion: 'ğŸ’¡ å»ºè®®ï¼šé¦–æ¬¡ä½¿ç”¨å»ºè®®é€‰æ‹©æ³¨å†Œæ¨¡å¼ï¼Œäº«å—å®Œæ•´åŠŸèƒ½'
                        }
                    },
                    language: {
                        select: 'é€‰æ‹©è¯­è¨€',
                        english: 'English',
                        traditional: 'ç¹é«”ä¸­æ–‡',
                        simplified: 'ç®€ä½“ä¸­æ–‡'
                    },
                    header: {
                        backToWelcome: 'è¿”å›æ¬¢è¿é¡µé¢'
                    },
                    header: {
                        title: 'AI ç‰§å¸ˆ',
                        subtitle: 'ä½ çš„éšèº«çµä¿®å¯¼å¸ˆ',
                        backToWelcome: 'è¿”å›æ¬¢è¿é¡µé¢',
                        settings: 'è®¾å®š',
                        clearHistory: 'æ¸…é™¤å¯¹è¯è®°å½•',
                        clearHistoryHint: 'æŒ‰è¿™é‡Œæ¸…é™¤æ‰€æœ‰å¯¹è¯çºªå½•',
                        guestMode: 'è®¿å®¢æ¨¡å¼',
                        loggedIn: 'å·²ç™»å…¥',
                        logout: 'ç™»å‡º',
                        upgradeAccount: 'å‡çº§ä¸ºæ³¨å†Œè´¦å·',
                        conversationManagement: 'å¯¹è¯ç®¡ç†',
                        adminPanel: 'ç®¡ç†å‘˜é¢æ¿'
                    },
                    modes: {
                        bibleOnly: 'å”¯ç‹¬åœ£ç»',
                        biblePlusWeb: 'åœ£ç»+ç½‘ç»œ'
                    },
                    input: {
                        placeholder: 'è¯·è¾“å…¥æ‚¨çš„é—®é¢˜...'
                    },
                    settings: {
                        title: 'è®¾å®š',
                        accountInfo: 'è´¦å·èµ„è®¯',
                        email: 'Email',
                        username: 'ä½¿ç”¨è€…åç§°',
                        nickname: 'æ˜µç§°',
                        changePassword: 'æ›´æ”¹å¯†ç ',
                        currentPassword: 'ç›®å‰å¯†ç ',
                        newPassword: 'æ–°å¯†ç ',
                        confirmPassword: 'ç¡®è®¤æ–°å¯†ç ',
                        enterCurrentPassword: 'è¯·è¾“å…¥ç›®å‰å¯†ç ',
                        enterNewPassword: 'è¯·è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘ 6 ä¸ªå­—å…ƒï¼‰',
                        enterConfirmPassword: 'è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç ',
                        changing: 'æ›´æ”¹ä¸­...',
                        changePasswordButton: 'æ›´æ”¹å¯†ç ',
                        showPassword: 'æ˜¾ç¤ºå¯†ç ',
                        hidePassword: 'éšè—å¯†ç ',
                        usageMode: 'ä½¿ç”¨æ¨¡å¼',
                        currentlyUsingGuest: 'æ‚¨ç›®å‰ä½¿ç”¨',
                        currentlyUsingRegistered: 'æ‚¨ç›®å‰ä½¿ç”¨',
                        guestMode: 'è®¿å®¢æ¨¡å¼',
                        registeredMode: 'æ³¨å†Œæ¨¡å¼',
                        guestLimitations: {
                            max20: 'æœ€å¤šä¿ç•™æœ€è¿‘ 20 æ¡å¯¹è¯',
                            localOnly: 'èµ„æ–™ä»…å‚¨å­˜åœ¨æ‚¨çš„è®¾å¤‡',
                            noSync: 'æ— æ³•è·¨è®¾å¤‡åŒæ­¥'
                        },
                        registeredFeatures: {
                            fullHistory: 'å®Œæ•´å¯¹è¯å†å²å‚¨å­˜',
                            multiDevice: 'å¤šè®¾å¤‡åŒæ­¥',
                            personalization: 'ä¸ªäººåŒ–è®°å¿†ç³»ç»Ÿ',
                            tracking: 'å±çµæˆé•¿è¿½è¸ª'
                        },
                        upgradeButton: 'å‡çº§ä¸ºæ³¨å†Œè´¦å·',
                        other: 'å…¶ä»–',
                        reselectMode: 'é‡æ–°é€‰æ‹©ä½¿ç”¨æ¨¡å¼',
                        fillAllFields: 'è¯·å¡«å†™æ‰€æœ‰æ ä½',
                        passwordMismatch: 'æ–°å¯†ç ä¸ç¡®è®¤å¯†ç ä¸ä¸€è‡´',
                        passwordTooShort: 'æ–°å¯†ç é•¿åº¦è‡³å°‘éœ€è¦ 6 ä¸ªå­—å…ƒ',
                        changeSuccess: 'å¯†ç æ›´æ”¹æˆåŠŸï¼',
                        changeFailed: 'æ›´æ”¹å¯†ç å¤±è´¥',
                        changeError: 'æ›´æ”¹å¯†ç å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚'
                    },
                    auth: {
                        login: 'ç™»å…¥',
                        register: 'æ³¨å†Œ',
                        email: 'Email',
                        username: 'ä½¿ç”¨è€…åç§°',
                        nickname: 'æ˜µç§°ï¼ˆé€‰å¡«ï¼‰',
                        password: 'å¯†ç ',
                        confirmPassword: 'ç¡®è®¤å¯†ç ',
                        enterEmail: 'è¯·è¾“å…¥æ‚¨çš„ Email',
                        enterUsername: 'è¯·è¾“å…¥ä½¿ç”¨è€…åç§°',
                        enterNickname: 'AI ç‰§å¸ˆå¦‚ä½•ç§°å‘¼æ‚¨ï¼Ÿ',
                        enterPassword: 'è¯·è¾“å…¥å¯†ç ',
                        enterConfirmPassword: 'è¯·å†æ¬¡è¾“å…¥å¯†ç ',
                        alreadyHaveAccount: 'å·²æœ‰è´¦å·ï¼Ÿç‚¹æ­¤ç™»å…¥',
                        noAccount: 'è¿˜æ²¡æœ‰è´¦å·ï¼Ÿç‚¹æ­¤æ³¨å†Œ',
                        loginButton: 'ç™»å…¥',
                        registerButton: 'æ³¨å†Œ',
                        loggingIn: 'ç™»å…¥ä¸­...',
                        registering: 'æ³¨å†Œä¸­...',
                        loginSuccess: 'ç™»å…¥æˆåŠŸï¼',
                        registerSuccess: 'æ³¨å†ŒæˆåŠŸï¼',
                        loginFailed: 'ç™»å…¥å¤±è´¥',
                        registerFailed: 'æ³¨å†Œå¤±è´¥',
                        fillAllFields: 'è¯·å¡«å†™æ‰€æœ‰æ ä½',
                        passwordMismatch: 'å¯†ç ä¸ç¡®è®¤å¯†ç ä¸ä¸€è‡´',
                        passwordTooShort: 'å¯†ç é•¿åº¦è‡³å°‘éœ€è¦ 6 ä¸ªå­—å…ƒ',
                        invalidEmail: 'è¯·è¾“å…¥æœ‰æ•ˆçš„ Email åœ°å€'
                    },
                    logout: {
                        confirm: 'ç¡®å®šè¦ç™»å‡ºå—ï¼Ÿæ‚¨çš„å¯¹è¯è®°å½•å°†ä¿ç•™åœ¨äº‘ç«¯ï¼Œä½†æœ¬åœ°å°†åˆ‡æ¢ä¸ºè®¿å®¢æ¨¡å¼ã€‚',
                        title: 'ç™»å‡º'
                    },
                    conversations: {
                        title: 'å¯¹è¯ç®¡ç†',
                        noConversations: 'å°šæ— å¯¹è¯è®°å½•',
                        loadError: 'è½½å…¥å¯¹è¯è®°å½•å¤±è´¥'
                    },
                    admin: {
                        title: 'ç®¡ç†å‘˜é¢æ¿',
                        users: 'ä½¿ç”¨è€…',
                        stats: 'ç»Ÿè®¡èµ„æ–™',
                        loading: 'è½½å…¥ä¸­...',
                        loadError: 'è½½å…¥ç®¡ç†å‘˜èµ„æ–™å¤±è´¥'
                    },
                    disclaimer: {
                        title: 'å…è´£å£°æ˜',
                        view: 'æŸ¥çœ‹å…è´£å£°æ˜',
                        close: 'å…³é—­'
                    },
                    welcomeMessage: {
                        text: 'æ„¿ä¸»ä¸ä½ åŒåœ¨ã€‚æˆ‘æ˜¯ä½ çš„ AI ç‰§å¸ˆã€‚æ— è®ºä½ å¿ƒä¸­æœ‰ä»€ä¹ˆç–‘é—®ï¼Œæˆ–æƒ³å¯»æ±‚åœ£ç»çš„çœŸç†ï¼Œéƒ½è¯·å‘Šè¯‰æˆ‘ã€‚\n\nä½ å¯ä»¥é€‰æ‹©ä»…ç”¨åœ£ç»å›ç­”ï¼Œæˆ–æ˜¯ç»“åˆå†å²ä¸ç½‘ç»œèµ„æ–™ã€‚è¯·é—®ä»Šå¤©æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„ï¼Ÿ'
                    }
                }
            };

            // èªè¨€ç‹€æ…‹ç®¡ç†
            const loadLanguage = () => {
                try {
                    const saved = localStorage.getItem('ai-pastor-language');
                    if (saved && ['en', 'zh-TW', 'zh-CN'].includes(saved)) {
                        return saved;
                    }
                } catch (e) {
                    console.warn('ç„¡æ³•è¼‰å…¥èªè¨€è¨­å®š', e);
                }
                return 'en'; // é è¨­è‹±æ–‡
            };

            const saveLanguage = (lang) => {
                try {
                    localStorage.setItem('ai-pastor-language', lang);
                    // æ›´æ–° HTML lang å±¬æ€§
                    document.documentElement.lang = lang;
                } catch (e) {
                    console.warn('ç„¡æ³•ä¿å­˜èªè¨€è¨­å®š', e);
                }
            };

            const [language, setLanguage] = useState(loadLanguage);
            
            // ç¿»è­¯å‡½æ•¸
            const t = (key) => {
                const keys = key.split('.');
                let value = translations[language];
                for (const k of keys) {
                    value = value?.[k];
                }
                return value || key;
            };

            // ç•¶èªè¨€æ”¹è®Šæ™‚æ›´æ–° HTML lang å±¬æ€§
            React.useEffect(() => {
                document.documentElement.lang = language;
            }, [language]);

            // ç”¨æˆ¶ç‹€æ…‹ç®¡ç†
            const loadUserState = () => {
                try {
                    const saved = localStorage.getItem('ai-pastor-user-state');
                    if (saved) {
                        return JSON.parse(saved);
                    }
                } catch (e) {
                    console.warn('ç„¡æ³•è¼‰å…¥ç”¨æˆ¶ç‹€æ…‹', e);
                }
                return { mode: 'guest', hasSeenWelcome: false };
            };

            const saveUserState = (state) => {
                try {
                    localStorage.setItem('ai-pastor-user-state', JSON.stringify(state));
                } catch (e) {
                    console.warn('ç„¡æ³•ä¿å­˜ç”¨æˆ¶ç‹€æ…‹', e);
                }
            };

            const [userState, setUserState] = useState(loadUserState);
            // æª¢æŸ¥ URL åƒæ•¸ï¼Œå¦‚æœæœ‰ ?showWelcome=false å‰‡ä¸é¡¯ç¤ºæ­¡è¿ç•«é¢
            const urlParams = new URLSearchParams(window.location.search);
            const forceHideWelcome = urlParams.get('showWelcome') === 'false';
            // æ–¹æ¡ˆä¸€ï¼šæ¯æ¬¡è¨ªå•éƒ½é¡¯ç¤ºæ­¡è¿é é¢ï¼ˆé™¤é URL åƒæ•¸æ˜ç¢ºè¨­ç½®ç‚º falseï¼‰
            const [showWelcomeModal, setShowWelcomeModal] = useState(!forceHideWelcome);
            const [showAuthModal, setShowAuthModal] = useState(false);
            const [showSettingsModal, setShowSettingsModal] = useState(false);
            const [showConversationsModal, setShowConversationsModal] = useState(false);
            const [showAdminModal, setShowAdminModal] = useState(false);
            const [showDisclaimerModal, setShowDisclaimerModal] = useState(false);
            const [authMode, setAuthMode] = useState('login'); // 'login' or 'register'
            const [authForm, setAuthForm] = useState({ email: '', username: '', password: '', nickname: '' });
            const [showPassword, setShowPassword] = useState(false); // é¡¯ç¤º/éš±è—å¯†ç¢¼
            
            // ç®¡ç†å“¡ç›¸é—œç‹€æ…‹
            const ADMIN_EMAIL = 'superkevinchou@gmail.com';
            const isAdmin = userState.mode === 'registered' && userState.user?.email === ADMIN_EMAIL;
            const [adminUsers, setAdminUsers] = useState([]);
            const [adminStats, setAdminStats] = useState(null);
            const [adminLoading, setAdminLoading] = useState(false);
            const [adminSearchTerm, setAdminSearchTerm] = useState('');
            const [selectedUser, setSelectedUser] = useState(null);
            
            // æ›´æ”¹å¯†ç¢¼ç›¸é—œç‹€æ…‹
            const [changePasswordForm, setChangePasswordForm] = useState({ oldPassword: '', newPassword: '', confirmPassword: '' });
            const [changingPassword, setChangingPassword] = useState(false);
            const [showOldPassword, setShowOldPassword] = useState(false);
            const [showNewPassword, setShowNewPassword] = useState(false);
            const [showConfirmPassword, setShowConfirmPassword] = useState(false);

            // è™•ç†ç€è¦½å™¨è¿”å›æŒ‰éˆ• - å…è¨±è¿”å›æ­¡è¿é¸æ“‡ç•Œé¢
            useEffect(() => {
                // ç•¶é¡¯ç¤ºæ­¡è¿ç•Œé¢æ™‚ï¼Œç¢ºä¿æœ‰æ­·å²è¨˜éŒ„
                if (showWelcomeModal) {
                    if (!window.history.state || window.history.state.step !== 'welcome') {
                        window.history.replaceState({ step: 'welcome' }, '', window.location.href);
                    }
                }
            }, [showWelcomeModal]);

            // ç›£è½ç€è¦½å™¨è¿”å›æŒ‰éˆ•
            useEffect(() => {
                const handlePopState = (event) => {
                    // ç•¶ç”¨æˆ¶æŒ‰è¿”å›æŒ‰éˆ•æ™‚
                    if (event.state) {
                        if (event.state.step === 'welcome') {
                            // è¿”å›æ­¡è¿ç•Œé¢ï¼ˆå…è¨±é‡æ–°é¸æ“‡æ¨¡å¼ï¼‰
                            setShowWelcomeModal(true);
                            setShowAuthModal(false);
                        } else if (event.state.step === 'auth') {
                            // è¿”å›è¨»å†Š/ç™»å…¥ç•Œé¢
                            setShowAuthModal(true);
                            setShowWelcomeModal(false);
                        }
                    } else {
                        // å¦‚æœæ²’æœ‰ stateï¼ˆé¦–æ¬¡è¼‰å…¥ï¼‰ï¼Œä¸”é‚„æ²’çœ‹éæ­¡è¿ç•Œé¢ï¼Œé¡¯ç¤ºæ­¡è¿ç•Œé¢
                        if (!userState.hasSeenWelcome) {
                            setShowWelcomeModal(true);
                            setShowAuthModal(false);
                        }
                    }
                };

                window.addEventListener('popstate', handlePopState);
                return () => window.removeEventListener('popstate', handlePopState);
            }, [userState.hasSeenWelcome]);

            // å¾ localStorage è¼‰å…¥æ­·å²å°è©±
            const loadHistory = () => {
                try {
                    const saved = localStorage.getItem('ai-pastor-history');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        // è¨ªå®¢æ¨¡å¼ï¼šåªä¿ç•™æœ€è¿‘ 20 æ¢è¨Šæ¯ä»¥é¿å…éå¤§
                        // è¨»å†Šæ¨¡å¼ï¼šä¿ç•™æ‰€æœ‰è¨Šæ¯ï¼ˆæœªä¾†å¾å¾Œç«¯è¼‰å…¥ï¼‰
                        return userState.mode === 'guest' ? parsed.slice(-20) : parsed;
                    }
                } catch (e) {
                    console.warn('ç„¡æ³•è¼‰å…¥æ­·å²è¨˜éŒ„', e);
                }
                // ä½¿ç”¨ç•¶å‰èªè¨€è¼‰å…¥æ­¡è¿è¨Šæ¯
                const currentLang = language || loadLanguage();
                return [
                    { role: 'model', content: translations[currentLang]?.welcomeMessage?.text || translations['en'].welcomeMessage.text }
                ];
            };

            const [messages, setMessages] = useState(() => {
                // åˆå§‹åŒ–æ™‚ä½¿ç”¨ç•¶å‰èªè¨€
                const currentLang = loadLanguage();
                try {
                    const saved = localStorage.getItem('ai-pastor-history');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        return userState.mode === 'guest' ? parsed.slice(-20) : parsed;
                    }
                } catch (e) {
                    console.warn('ç„¡æ³•è¼‰å…¥æ­·å²è¨˜éŒ„', e);
                }
                return [
                    { role: 'model', content: translations[currentLang]?.welcomeMessage?.text || translations['en'].welcomeMessage.text }
                ];
            });
            const [input, setInput] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [mode, setMode] = useState('bible-only');
            const messagesEndRef = useRef(null);
            const chatAreaRef = useRef(null);

            // ç•¶ç”¨æˆ¶ç‹€æ…‹æ”¹è®Šæ™‚é‡æ–°è¼‰å…¥æ­·å²
            useEffect(() => {
                setMessages(loadHistory());
            }, [userState.mode]);

            // ç•¶èªè¨€æ”¹è®Šæ™‚ï¼Œå¦‚æœåªæœ‰æ­¡è¿è¨Šæ¯ï¼Œæ›´æ–°ç‚ºæ–°èªè¨€çš„æ­¡è¿è¨Šæ¯
            useEffect(() => {
                if (messages.length === 1 && messages[0].role === 'model') {
                    // æª¢æŸ¥æ˜¯å¦ç‚ºæ­¡è¿è¨Šæ¯ï¼ˆé€šéæª¢æŸ¥æ˜¯å¦åŒ…å«ç‰¹å®šæ–‡å­—ï¼‰
                    const welcomeText = messages[0].content;
                    const isWelcomeMessage = welcomeText.includes('é¡˜ä¸»èˆ‡ä½ åŒåœ¨') || 
                                            welcomeText.includes('æ„¿ä¸»ä¸ä½ åŒåœ¨') || 
                                            welcomeText.includes('May the Lord be with you') ||
                                            welcomeText.includes('AI Pastor') || 
                                            welcomeText.includes('AI ç‰§å¸«');
                    if (isWelcomeMessage) {
                        setMessages([{ role: 'model', content: t('welcomeMessage.text') }]);
                    }
                }
            }, [language]);

            useEffect(() => {
                lucide.createIcons();
            }, []);

            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
                lucide.createIcons();
            }, [messages, isLoading]);

            // ä¿å­˜å°è©±æ­·å²
            useEffect(() => {
                // è¨ªå®¢æ¨¡å¼ï¼šåªä¿å­˜åˆ° localStorageï¼ˆä¸æœƒä¸Šå‚³åˆ°å¾Œç«¯ï¼‰
                // è¨»å†Šæ¨¡å¼ï¼šä¿å­˜åˆ° localStorage å’Œå¾Œç«¯
                if (userState.mode === 'guest') {
                    // è¨ªå®¢æ¨¡å¼ï¼šåªä¿å­˜åˆ°æœ¬åœ°ï¼Œä¸ä¿å­˜åˆ°å¾Œç«¯
                    try {
                        localStorage.setItem('ai-pastor-history', JSON.stringify(messages));
                    } catch (e) {
                        console.warn('ç„¡æ³•ä¿å­˜æ­·å²è¨˜éŒ„åˆ°æœ¬åœ°', e);
                    }
                } else if (userState.mode === 'registered' && userState.user?.token) {
                    // è¨»å†Šæ¨¡å¼ï¼šä¿å­˜åˆ°æœ¬åœ°å’Œå¾Œç«¯
                    try {
                        localStorage.setItem('ai-pastor-history', JSON.stringify(messages));
                    } catch (e) {
                        console.warn('ç„¡æ³•ä¿å­˜æ­·å²è¨˜éŒ„åˆ°æœ¬åœ°', e);
                    }
                    
                    // åªä¿å­˜è¨»å†Šå¾Œçš„å°è©±åˆ°å¾Œç«¯ï¼ˆä¸ä¿å­˜è¨ªå®¢å°è©±ï¼‰
                    if (messages.length > 0) {
                        saveHistoryToBackend(userState.user.token, messages);
                    }
                }
            }, [messages, userState.mode, userState.user?.token]);

            // ä¿å­˜å°è©±æ­·å²åˆ°å¾Œç«¯
            const saveHistoryToBackend = async (token, messages) => {
                try {
                    const apiUrl = API_BASE_URL ? `${API_BASE_URL}/api/user` : '/api/user';
                    await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            token,
                            type: 'messages',
                            data: { messages }
                        })
                    });
                } catch (error) {
                    console.error('ä¿å­˜åˆ°å¾Œç«¯å¤±æ•—:', error);
                    // å¤±æ•—æ™‚ä¸å½±éŸ¿ç”¨æˆ¶é«”é©—ï¼Œå› ç‚ºå·²ç¶“ä¿å­˜åˆ° localStorage
                }
            };

            const handleSend = async (e) => {
                if (e && e.preventDefault) {
                    e.preventDefault();
                }
                if (!input.trim() || isLoading) return;

                const userMessage = input.trim();
                setInput('');
                setIsLoading(true);

                const newMessages = [...messages, { role: 'user', content: userMessage }];
                setMessages(newMessages);

                try {
                    const { text, grounding } = await callGeminiAPI(userMessage, messages, mode);
                    setMessages(prev => [...prev, { role: 'model', content: text, grounding }]);
                } catch (error) {
                    const errorMessage = error.message || 'ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤';
                    setMessages(prev => [...prev, { 
                        role: 'model', 
                        content: `æŠ±æ­‰ï¼Œåœ¨è™•ç†æ‚¨çš„å•é¡Œæ™‚é‡åˆ°å›°é›£ï¼š\n\n**${errorMessage}**\n\nè«‹ç¨å¾Œå†è©¦ï¼Œæˆ–æª¢æŸ¥ API Key è¨­å®šæ˜¯å¦æ­£ç¢ºã€‚` 
                    }]);
                } finally {
                    setIsLoading(false);
                }
            };

            const clearHistory = () => {
                if (window.confirm(t('settings.clearHistory') + '?')) {
                    localStorage.removeItem('ai-pastor-history');
                    const currentLang = language || loadLanguage();
                    setMessages([
                        { role: 'model', content: translations[currentLang]?.welcomeMessage?.text || translations['en'].welcomeMessage.text }
                    ]);
                }
            };

            // è™•ç†æ­¡è¿ç•Œé¢é¸æ“‡
            const handleWelcomeChoice = (choice) => {
                if (choice === 'guest') {
                    const newState = { ...userState, hasSeenWelcome: true, mode: 'guest' };
                    setUserState(newState);
                    saveUserState(newState);
                    setShowWelcomeModal(false);
                    // æ·»åŠ æ­·å²è¨˜éŒ„ï¼Œå…è¨±è¿”å›
                    window.history.pushState({ step: 'main', choice: 'guest' }, '', window.location.pathname);
                } else if (choice === 'register') {
                    setShowWelcomeModal(false);
                    setShowAuthModal(true);
                    setAuthMode('register');
                    // æ·»åŠ æ­·å²è¨˜éŒ„ï¼Œå…è¨±è¿”å›
                    window.history.pushState({ step: 'auth', choice: 'register' }, '', window.location.pathname);
                }
            };

            // è™•ç†è¨»å†Š/ç™»å…¥ Modal é—œé–‰æŒ‰éˆ• - è¿”å›æ­¡è¿ç•Œé¢
            const handleCloseAuthModal = () => {
                setShowAuthModal(false);
                // å¦‚æœæ˜¯åœ¨è¨»å†Šæµç¨‹ä¸­é—œé–‰ï¼Œè¿”å›æ­¡è¿ç•Œé¢
                if (window.history.state && window.history.state.step === 'auth') {
                    setShowWelcomeModal(true);
                    // æ›´æ–°æ­·å²è¨˜éŒ„
                    window.history.pushState({ step: 'welcome' }, '', window.location.href);
                }
            };

            // è™•ç†è¨»å†Š/ç™»å…¥
            const handleAuth = async (e) => {
                if (e) e.preventDefault();
                setIsLoading(true);

                try {
                    const apiUrl = API_BASE_URL ? `${API_BASE_URL}/api/auth` : '/api/auth';
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: authMode === 'register' ? 'register' : 'login',
                            email: authForm.email,
                            username: authForm.username,
                            password: authForm.password,
                            nickname: authForm.nickname
                        })
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || 'èªè­‰å¤±æ•—');
                    }

                    // èªè­‰æˆåŠŸ
                    const newState = {
                        ...userState,
                        hasSeenWelcome: true,
                        mode: 'registered',
                        user: {
                            email: data.user.email,
                            username: data.user.username,
                            nickname: data.user.nickname,
                            token: data.token
                        }
                    };
                    setUserState(newState);
                    saveUserState(newState);
                    setShowAuthModal(false);
                    setAuthForm({ email: '', username: '', password: '', nickname: '' });

                    // è¨»å†Šæ™‚æ¸…é™¤è¨ªå®¢æ¨¡å¼çš„å°è©±è¨˜éŒ„ï¼ˆä¸å„²å­˜è¨ªå®¢å°è©±ï¼‰
                    if (authMode === 'register') {
                        // æ¸…é™¤ localStorage ä¸­çš„è¨ªå®¢å°è©±è¨˜éŒ„
                        try {
                            localStorage.removeItem('ai-pastor-history');
                            setMessages([]); // æ¸…ç©ºç•¶å‰å°è©±
                        } catch (e) {
                            console.warn('æ¸…é™¤è¨ªå®¢å°è©±è¨˜éŒ„å¤±æ•—:', e);
                        }
                        alert(t('auth.registerSuccess') + ' ' + 'è¨ªå®¢æ™‚æœŸçš„å°è©±è¨˜éŒ„å·²æ¸…é™¤ï¼Œæ–°çš„å°è©±å°‡ä¿å­˜åˆ°é›²ç«¯ã€‚');
                    } else {
                        // ç™»å…¥æ™‚å¾å¾Œç«¯è¼‰å…¥æ­·å²
                        await loadHistoryFromBackend(data.token);
                        alert(t('auth.loginSuccess'));
                    }
                } catch (error) {
                    console.error('èªè­‰éŒ¯èª¤:', error);
                    alert(`èªè­‰å¤±æ•—ï¼š${error.message}`);
                } finally {
                    setIsLoading(false);
                }
            };

            // æ³¨æ„ï¼šå·²ç§»é™¤ migrateLocalDataToBackend å‡½æ•¸
            // è¨ªå®¢æ¨¡å¼çš„å°è©±è¨˜éŒ„ä¸æœƒè¢«é·ç§»åˆ°å¾Œç«¯ï¼Œç¢ºä¿ä¸å„²å­˜ä»»ä½•è¨ªå®¢å°è©±

            // è¼‰å…¥ç®¡ç†å“¡æ•¸æ“š
            const loadAdminData = async () => {
                if (!isAdmin) return;
                
                setAdminLoading(true);
                try {
                    const apiUrl = API_BASE_URL || '';
                    // ä½¿ç”¨é è¨­å¯†ç¢¼ï¼ˆå¾Œç«¯æœƒå¾ç’°å¢ƒè®Šæ•¸ ADMIN_PASSWORD è®€å–ï¼Œå¦‚æœæœªè¨­å®šå‰‡ä½¿ç”¨é è¨­å€¼ï¼‰
                    const adminPassword = 'admin123';
                    
                    // ç²å–ç”¨æˆ¶åˆ—è¡¨
                    const usersResponse = await fetch(`${apiUrl}/api/admin/users?password=${encodeURIComponent(adminPassword)}`);
                    if (usersResponse.ok) {
                        const usersData = await usersResponse.json();
                        setAdminUsers(usersData.users || []);
                    } else if (usersResponse.status === 401) {
                        alert('ç®¡ç†å“¡å¯†ç¢¼é©—è­‰å¤±æ•—ã€‚è«‹ç¢ºèªå¾Œç«¯ç’°å¢ƒè®Šæ•¸ ADMIN_PASSWORD è¨­å®šæ­£ç¢ºã€‚');
                        return;
                    } else {
                        const errorData = await usersResponse.json().catch(() => ({ error: 'æœªçŸ¥éŒ¯èª¤' }));
                        throw new Error(errorData.error || 'è¼‰å…¥ç”¨æˆ¶åˆ—è¡¨å¤±æ•—');
                    }
                    
                    // ç²å–çµ±è¨ˆè³‡è¨Š
                    const statsResponse = await fetch(`${apiUrl}/api/admin/stats?password=${encodeURIComponent(adminPassword)}`);
                    if (statsResponse.ok) {
                        const statsData = await statsResponse.json();
                        setAdminStats(statsData.stats || null);
                    } else if (statsResponse.status === 401) {
                        // å¦‚æœç”¨æˆ¶åˆ—è¡¨å·²è¼‰å…¥ï¼Œåªè­¦å‘Šçµ±è¨ˆè³‡è¨Š
                        console.warn('çµ±è¨ˆè³‡è¨Šè¼‰å…¥å¤±æ•—ï¼šå¯†ç¢¼é©—è­‰å¤±æ•—');
                    }
                } catch (error) {
                    console.error('è¼‰å…¥ç®¡ç†å“¡æ•¸æ“šå¤±æ•—:', error);
                    alert(`è¼‰å…¥ç®¡ç†å“¡æ•¸æ“šå¤±æ•—ï¼š${error.message || 'è«‹æª¢æŸ¥å¾Œç«¯é€£æ¥'}`);
                } finally {
                    setAdminLoading(false);
                }
            };

            // å¾å¾Œç«¯è¼‰å…¥æ­·å²
            const loadHistoryFromBackend = async (token) => {
                try {
                    const apiUrl = API_BASE_URL ? `${API_BASE_URL}/api/user?token=${encodeURIComponent(token)}&type=messages` : `/api/user?token=${encodeURIComponent(token)}&type=messages`;
                    const response = await fetch(apiUrl);

                    if (!response.ok) {
                        throw new Error('ç„¡æ³•è¼‰å…¥æ­·å²è¨˜éŒ„');
                    }

                    const data = await response.json();
                    if (data.success && data.messages && data.messages.length > 0) {
                        setMessages(data.messages);
                        // åŒæ™‚æ›´æ–° localStorage ä½œç‚ºå‚™ä»½
                        localStorage.setItem('ai-pastor-history', JSON.stringify(data.messages));
                    }
                } catch (error) {
                    console.error('è¼‰å…¥æ­·å²å¤±æ•—:', error);
                }
            };

            // è™•ç†ç™»å‡º
            const handleLogout = () => {
                if (window.confirm(t('logout.confirm'))) {
                    const newState = { mode: 'guest', hasSeenWelcome: true };
                    setUserState(newState);
                    saveUserState(newState);
                }
            };

            return (
                <div className="flex flex-col h-screen w-full max-w-4xl mx-auto shadow-2xl bg-gradient-to-b from-slate-900/95 via-slate-800/90 to-slate-900/95 overflow-hidden backdrop-blur-xl" style={{ width: '100%', maxWidth: '100%', position: 'relative', overflow: 'hidden', border: '1px solid rgba(255, 215, 0, 0.3)' }}>
                    {/* æ­¡è¿é¸æ“‡ Modal - æ¯æ¬¡è¨ªå•éƒ½é¡¯ç¤ºï¼Œå¯ä»¥é¸æ“‡æ¨¡å¼æˆ–é—œé–‰ */}
                    {showWelcomeModal && (
                        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-3 sm:p-4" onClick={(e) => {
                            // å¦‚æœé‚„æ²’é¸æ“‡éæ¨¡å¼ï¼ˆé¦–æ¬¡è¨ªå•ï¼‰ï¼Œå¿…é ˆé¸æ“‡æ¨¡å¼ï¼Œä¸èƒ½é»æ“ŠèƒŒæ™¯é—œé–‰
                            if (!userState.hasSeenWelcome) {
                                e.stopPropagation();
                            } else {
                                // å¦‚æœå·²ç¶“é¸æ“‡éæ¨¡å¼ï¼Œé»æ“ŠèƒŒæ™¯å¯ä»¥é—œé–‰æ­¡è¿é é¢
                                setShowWelcomeModal(false);
                            }
                        }}>
                            <div className="bg-gradient-to-br from-slate-800 via-slate-900 to-slate-800 rounded-2xl shadow-2xl border-2 border-amber-500/30 max-w-2xl w-full max-h-[95vh] overflow-y-auto" onClick={(e) => e.stopPropagation()}>
                                <div className="p-6 sm:p-8">
                                    {/* èªè¨€é¸æ“‡å™¨ */}
                                    <div className="flex justify-end mb-4">
                                        <div className="relative">
                                            <select
                                                value={language}
                                                onChange={(e) => {
                                                    const newLang = e.target.value;
                                                    setLanguage(newLang);
                                                    saveLanguage(newLang);
                                                }}
                                                className="bg-slate-700/70 border border-amber-500/30 rounded-lg px-4 py-2 text-amber-50 text-sm font-medium focus:outline-none focus:border-amber-500/50 focus:ring-2 focus:ring-amber-500/20 cursor-pointer appearance-none pr-8"
                                                style={{ backgroundImage: 'url("data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'12\' height=\'12\' viewBox=\'0 0 12 12\'%3E%3Cpath fill=\'%23fbbf24\' d=\'M6 9L1 4h10z\'/%3E%3C/svg%3E")', backgroundRepeat: 'no-repeat', backgroundPosition: 'right 0.75rem center', backgroundSize: '12px' }}
                                            >
                                                <option value="en">English</option>
                                                <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
                                                <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div className="text-center mb-6">
                                        <div className="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gradient-to-br from-amber-500 to-amber-600 mb-4 shadow-lg">
                                            <Icon name="cross" size={32} className="text-white" />
                                        </div>
                                        <h2 className="text-2xl sm:text-3xl font-bold text-amber-50 mb-2 font-serif">{t('welcome.title')}</h2>
                                        <p className="text-amber-200/80 text-sm sm:text-base">{t('welcome.subtitle')}</p>
                                    </div>

                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6 mb-6">
                                        {/* è¨ªå®¢æ¨¡å¼å¡ç‰‡ */}
                                        <div className="bg-slate-700/50 rounded-xl p-5 sm:p-6 border-2 border-slate-600/50 hover:border-amber-500/50 transition-all flex flex-col">
                                            <div className="flex items-center mb-4">
                                                <Icon name="user" size={24} className="text-amber-400 mr-3 flex-shrink-0" />
                                                <h3 className="text-xl font-bold text-amber-50">{t('welcome.guestMode.title')}</h3>
                                            </div>
                                            
                                            {/* å„ªé» */}
                                            <div className="mb-4 flex-1">
                                                <p className="text-xs text-amber-300/80 font-semibold mb-2">{t('welcome.guestMode.suitable')}</p>
                                                <ul className="space-y-2 text-sm text-amber-200/70 mb-3">
                                                    <li className="flex items-start">
                                                        <Icon name="check" size={16} className="text-green-400 mr-2 mt-0.5 flex-shrink-0" />
                                                        <span>{t('welcome.guestMode.features.immediate')}</span>
                                                    </li>
                                                    <li className="flex items-start">
                                                        <Icon name="check" size={16} className="text-green-400 mr-2 mt-0.5 flex-shrink-0" />
                                                        <span>{t('welcome.guestMode.features.local')}</span>
                                                    </li>
                                                    <li className="flex items-start">
                                                        <Icon name="check" size={16} className="text-green-400 mr-2 mt-0.5 flex-shrink-0" />
                                                        <span>{t('welcome.guestMode.features.privacy')}</span>
                                                    </li>
                                                </ul>
                                                
                                                {/* ç‰¹æ®Šé™åˆ¶ */}
                                                <div className="mt-4 pt-3 border-t border-slate-600/50">
                                                    <p className="text-xs text-amber-300/80 font-semibold mb-2">{t('welcome.guestMode.limitations.title')}</p>
                                                    <ul className="space-y-1.5 text-xs text-amber-200/60">
                                                        <li className="flex items-start">
                                                            <Icon name="info" size={14} className="text-amber-400 mr-2 mt-0.5 flex-shrink-0" />
                                                            <span>{t('welcome.guestMode.limitations.singleDevice')}</span>
                                                        </li>
                                                        <li className="flex items-start">
                                                            <Icon name="info" size={14} className="text-amber-400 mr-2 mt-0.5 flex-shrink-0" />
                                                            <span>{t('welcome.guestMode.limitations.limitedHistory')}</span>
                                                        </li>
                                                        <li className="flex items-start">
                                                            <Icon name="info" size={14} className="text-amber-400 mr-2 mt-0.5 flex-shrink-0" />
                                                            <span>{t('welcome.guestMode.limitations.dataLoss')}</span>
                                                        </li>
                                                    </ul>
                                                </div>
                                            </div>
                                            
                                            <button
                                                onClick={() => handleWelcomeChoice('guest')}
                                                className="w-full bg-gradient-to-r from-amber-600 to-amber-700 hover:from-amber-700 hover:to-amber-800 text-white font-semibold py-3 px-4 rounded-lg transition-all shadow-lg hover:shadow-xl active:scale-95 mt-auto"
                                            >
                                                {t('welcome.guestMode.button')}
                                            </button>
                                        </div>

                                        {/* è¨»å†Šæ¨¡å¼å¡ç‰‡ */}
                                        <div className="bg-gradient-to-br from-amber-900/30 to-amber-800/20 rounded-xl p-5 sm:p-6 border-2 border-amber-500/50 hover:border-amber-400/70 transition-all flex flex-col">
                                            <div className="flex items-center mb-4">
                                                <Icon name="user-plus" size={24} className="text-amber-300 mr-3 flex-shrink-0" />
                                                <h3 className="text-xl font-bold text-amber-50">{t('welcome.registerMode.title')}</h3>
                                                <span className="ml-2 px-2 py-0.5 bg-amber-500/20 text-amber-300 text-xs rounded-full">{t('welcome.registerMode.recommended')}</span>
                                            </div>
                                            
                                            {/* å„ªé» */}
                                            <div className="mb-4 flex-1">
                                                <p className="text-xs text-amber-300/80 font-semibold mb-2">{t('welcome.registerMode.experience')}</p>
                                                <ul className="space-y-2 text-sm text-amber-200/70 mb-3">
                                                    <li className="flex items-start">
                                                        <Icon name="check" size={16} className="text-green-400 mr-2 mt-0.5 flex-shrink-0" />
                                                        <span>{t('welcome.registerMode.features.history')}</span>
                                                    </li>
                                                    <li className="flex items-start">
                                                        <Icon name="check" size={16} className="text-green-400 mr-2 mt-0.5 flex-shrink-0" />
                                                        <span>{t('welcome.registerMode.features.sync')}</span>
                                                    </li>
                                                    <li className="flex items-start">
                                                        <Icon name="check" size={16} className="text-green-400 mr-2 mt-0.5 flex-shrink-0" />
                                                        <span>{t('welcome.registerMode.features.personalization')}</span>
                                                    </li>
                                                    <li className="flex items-start">
                                                        <Icon name="check" size={16} className="text-green-400 mr-2 mt-0.5 flex-shrink-0" />
                                                        <span>{t('welcome.registerMode.features.tracking')}</span>
                                                    </li>
                                                </ul>
                                                
                                                {/* ç‰¹æ®Šå„ªå‹¢ */}
                                                <div className="mt-4 pt-3 border-t border-amber-500/30">
                                                    <p className="text-xs text-amber-300/80 font-semibold mb-2">{t('welcome.registerMode.advantages.title')}</p>
                                                    <ul className="space-y-1.5 text-xs text-amber-200/60">
                                                        <li className="flex items-start">
                                                            <Icon name="star" size={14} className="text-amber-400 mr-2 mt-0.5 flex-shrink-0" />
                                                            <span>{t('welcome.registerMode.advantages.backup')}</span>
                                                        </li>
                                                        <li className="flex items-start">
                                                            <Icon name="star" size={14} className="text-amber-400 mr-2 mt-0.5 flex-shrink-0" />
                                                            <span>{t('welcome.registerMode.advantages.unlimited')}</span>
                                                        </li>
                                                        <li className="flex items-start">
                                                            <Icon name="star" size={14} className="text-amber-400 mr-2 mt-0.5 flex-shrink-0" />
                                                            <span>{t('welcome.registerMode.advantages.free')}</span>
                                                        </li>
                                                    </ul>
                                                </div>
                                            </div>
                                            
                                            <button
                                                onClick={() => handleWelcomeChoice('register')}
                                                className="w-full bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-400 hover:to-amber-500 text-white font-semibold py-3 px-4 rounded-lg transition-all shadow-lg hover:shadow-xl active:scale-95 mt-auto"
                                            >
                                                {t('welcome.registerMode.button')}
                                            </button>
                                        </div>
                                    </div>

                                    <div className="text-center space-y-2">
                                        <p className="text-xs text-amber-300/60">
                                            {t('welcome.footer.switch')}
                                        </p>
                                        <p className="text-xs text-amber-400/50">
                                            {t('welcome.footer.suggestion')}
                                        </p>
                                        <p className="text-xs text-amber-300/40 mt-3 pt-3 border-t border-amber-500/20">
                                            <button
                                                onClick={() => {
                                                    setShowWelcomeModal(false);
                                                    setShowDisclaimerModal(true);
                                                }}
                                                className="text-amber-300/60 hover:text-amber-200/80 underline transition-colors"
                                            >
                                                {language === 'en' ? 'Legal Disclaimer' : language === 'zh-TW' ? 'å…è²¬è²æ˜' : 'å…è´£å£°æ˜'}
                                            </button>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* è¨»å†Š/ç™»å…¥ Modal */}
                    {showAuthModal && (
                        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4" onClick={handleCloseAuthModal}>
                            <div className="bg-gradient-to-br from-slate-800 via-slate-900 to-slate-800 rounded-2xl shadow-2xl border-2 border-amber-500/30 max-w-md w-full" onClick={(e) => e.stopPropagation()}>
                                <div className="p-6 sm:p-8">
                                    <div className="flex items-center justify-between mb-6">
                                        <h2 className="text-2xl font-bold text-amber-50 font-serif">
                                            {authMode === 'register' ? t('auth.register') : t('auth.login')}
                                        </h2>
                                        <button
                                            onClick={handleCloseAuthModal}
                                            className="text-amber-200/70 hover:text-amber-100 transition-colors"
                                        >
                                            <Icon name="x" size={24} />
                                        </button>
                                    </div>

                                    <form onSubmit={handleAuth} className="space-y-4">
                                        {authMode === 'register' && (
                                            <>
                                                <div>
                                                    <label className="block text-sm font-medium text-amber-200/80 mb-2">ä½¿ç”¨è€…åç¨±</label>
                                                    <input
                                                        type="text"
                                                        value={authForm.username}
                                                        onChange={(e) => setAuthForm({...authForm, username: e.target.value})}
                                                        className="w-full bg-slate-700/50 border border-slate-600/50 rounded-lg px-4 py-2.5 text-amber-50 focus:outline-none focus:border-amber-500/50 focus:ring-2 focus:ring-amber-500/20"
                                                        placeholder={t('auth.enterUsername')}
                                                        required
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-amber-200/80 mb-2">æš±ç¨±ï¼ˆé¸å¡«ï¼‰</label>
                                                    <input
                                                        type="text"
                                                        value={authForm.nickname}
                                                        onChange={(e) => setAuthForm({...authForm, nickname: e.target.value})}
                                                        className="w-full bg-slate-700/50 border border-slate-600/50 rounded-lg px-4 py-2.5 text-amber-50 focus:outline-none focus:border-amber-500/50 focus:ring-2 focus:ring-amber-500/20"
                                                        placeholder={t('auth.enterNickname')}
                                                    />
                                                </div>
                                            </>
                                        )}
                                        <div>
                                            <label className="block text-sm font-medium text-amber-200/80 mb-2">Email</label>
                                            <input
                                                type="email"
                                                value={authForm.email}
                                                onChange={(e) => setAuthForm({...authForm, email: e.target.value})}
                                                className="w-full bg-slate-700/50 border border-slate-600/50 rounded-lg px-4 py-2.5 text-amber-50 focus:outline-none focus:border-amber-500/50 focus:ring-2 focus:ring-amber-500/20"
                                                placeholder="your@email.com"
                                                required
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-amber-200/80 mb-2">å¯†ç¢¼</label>
                                            <div className="relative">
                                                <input
                                                    type={showPassword ? "text" : "password"}
                                                    value={authForm.password}
                                                    onChange={(e) => setAuthForm({...authForm, password: e.target.value})}
                                                    className="w-full bg-slate-700/50 border border-slate-600/50 rounded-lg px-4 py-2.5 pr-12 text-amber-50 focus:outline-none focus:border-amber-500/50 focus:ring-2 focus:ring-amber-500/20"
                                                    placeholder={t('auth.enterPassword')}
                                                    required
                                                    minLength={6}
                                                />
                                                <button
                                                    type="button"
                                                    onClick={() => setShowPassword(!showPassword)}
                                                    className="absolute right-3 top-1/2 transform -translate-y-1/2 text-amber-200/70 hover:text-amber-100 transition-colors p-1"
                                                    aria-label={showPassword ? "éš±è—å¯†ç¢¼" : "é¡¯ç¤ºå¯†ç¢¼"}
                                                >
                                                    <Icon name={showPassword ? "eye-off" : "eye"} size={20} />
                                                </button>
                                            </div>
                                        </div>
                                        <button
                                            type="submit"
                                            className="w-full bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-400 hover:to-amber-500 text-white font-semibold py-3 px-4 rounded-lg transition-all shadow-lg hover:shadow-xl active:scale-95"
                                        >
                                            {authMode === 'register' ? t('auth.registerButton') : t('auth.loginButton')}
                                        </button>
                                    </form>

                                    <div className="mt-4 text-center">
                                        <button
                                            onClick={() => {
                                                setAuthMode(authMode === 'register' ? 'login' : 'register');
                                                setAuthForm({ email: '', username: '', password: '', nickname: '' });
                                                setShowPassword(false); // é‡ç½®å¯†ç¢¼é¡¯ç¤ºç‹€æ…‹
                                            }}
                                            className="text-sm text-amber-300/70 hover:text-amber-200 transition-colors"
                                        >
                                            {authMode === 'register' ? t('auth.alreadyHaveAccount') : t('auth.noAccount')}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Header - 3D æœªä¾†æ„Ÿè¨­è¨ˆ */}
                    <header className="bg-gradient-to-r from-slate-900/95 via-slate-800/90 to-slate-900/95 text-amber-50 px-2 sm:px-4 py-0.5 sm:py-1.5 shadow-lg shadow-amber-900/30 flex items-center justify-between z-10 shrink-0 border-b border-amber-500/30 futuristic-border" style={{ height: '38px', minHeight: '38px', maxHeight: '38px', backdropFilter: 'blur(10px)' }}>
                        <div className="flex items-center gap-1 sm:gap-2 min-w-0 flex-1">
                            <div className="bg-gradient-to-br from-amber-500 to-amber-600 p-0.5 sm:p-1 rounded-lg shrink-0 shadow-md shadow-amber-600/30">
                                <Icon name="cross" size={12} className="sm:w-4 sm:h-4 text-white" />
                            </div>
                            <div className="min-w-0">
                                <h1 className="text-xs sm:text-base md:text-xl font-bold tracking-wide font-serif truncate bg-gradient-to-r from-amber-50 to-amber-100 bg-clip-text text-transparent text-3d">{t('header.title')}</h1>
                                <p className="text-xs text-amber-200/80 hidden sm:block glow-animate">{t('header.subtitle')}</p>
                            </div>
                        </div>
                        <div className="flex items-center gap-1 sm:gap-2 shrink-0">
                            {/* ç®¡ç†å“¡æŒ‰éˆ•ï¼ˆåƒ…ç®¡ç†å“¡å¯è¦‹ï¼‰ */}
                            {isAdmin && (
                                <button
                                    onClick={() => {
                                        setShowAdminModal(true);
                                        loadAdminData();
                                    }}
                                    className="text-xs sm:text-sm text-red-300/90 hover:text-red-200 transition-all duration-200 px-1 sm:px-1.5 py-0.5 rounded-lg hover:bg-red-900/40 active:bg-red-900/60 active:scale-95 shrink-0 hover:shadow-md"
                                    title={t('header.adminPanel')}
                                >
                                    <Icon name="shield" size={12} className="sm:w-3.5 sm:h-3.5" />
                                </button>
                            )}
                            {/* å°è©±ç®¡ç†æŒ‰éˆ•ï¼ˆè¨»å†Šç”¨æˆ¶ï¼‰ */}
                            {userState.mode === 'registered' && (
                                <button
                                    onClick={() => setShowConversationsModal(true)}
                                    className="text-xs sm:text-sm text-amber-200/80 hover:text-amber-100 transition-all duration-200 px-1 sm:px-1.5 py-0.5 rounded-lg hover:bg-amber-800/40 active:bg-amber-800/60 active:scale-95 shrink-0 hover:shadow-md"
                                    title={t('header.conversationManagement')}
                                >
                                    <Icon name="message-square" size={12} className="sm:w-3.5 sm:h-3.5" />
                                </button>
                            )}
                            {/* è¿”å›æ­¡è¿é é¢æŒ‰éˆ• */}
                            <button
                                onClick={() => {
                                    setShowWelcomeModal(true);
                                }}
                                className="text-xs sm:text-sm text-amber-200/80 hover:text-amber-100 transition-all duration-200 px-1 sm:px-1.5 py-0.5 rounded-lg hover:bg-amber-800/40 active:bg-amber-800/60 active:scale-95 shrink-0 hover:shadow-md"
                                title={t('header.backToWelcome')}
                            >
                                <Icon name="home" size={12} className="sm:w-3.5 sm:h-3.5" />
                            </button>
                            {/* è¨­å®šæŒ‰éˆ• */}
                            <button
                                onClick={() => setShowSettingsModal(true)}
                                className="text-xs sm:text-sm text-amber-200/80 hover:text-amber-100 transition-all duration-200 px-1 sm:px-1.5 py-0.5 rounded-lg hover:bg-amber-800/40 active:bg-amber-800/60 active:scale-95 shrink-0 hover:shadow-md"
                                title={t('header.settings')}
                            >
                                <Icon name="settings" size={12} className="sm:w-3.5 sm:h-3.5" />
                            </button>
                            <span className="text-[10px] sm:text-xs text-amber-200/70 whitespace-nowrap hidden sm:inline">{t('header.clearHistoryHint')}</span>
                            <button
                                onClick={clearHistory}
                                className="text-xs sm:text-sm text-amber-200/80 hover:text-amber-100 transition-all duration-200 px-1 sm:px-1.5 py-0.5 rounded-lg hover:bg-amber-800/40 active:bg-amber-800/60 active:scale-95 shrink-0 hover:shadow-md"
                                title={t('header.clearHistory')}
                            >
                                <Icon name="trash-2" size={12} className="sm:w-3.5 sm:h-3.5" />
                            </button>
                            {userState.mode === 'guest' ? (
                                <button
                                    onClick={() => setShowAuthModal(true)}
                                    className="text-xs sm:text-sm text-amber-300/80 hover:text-amber-200 transition-all duration-200 px-2 py-1 rounded-lg hover:bg-amber-800/40 active:bg-amber-800/60 active:scale-95 shrink-0 hover:shadow-md flex items-center gap-1"
                                    title={t('header.upgradeAccount')}
                                >
                                    <Icon name="user-plus" size={12} className="sm:w-3.5 sm:h-3.5" />
                                    <span className="hidden sm:inline">{t('header.guestMode')}</span>
                                </button>
                            ) : (
                                <div className="flex items-center gap-2">
                                    <div className="text-xs text-amber-200/80 hidden sm:block">
                                        {userState.user?.nickname || userState.user?.username || t('header.loggedIn')}
                                    </div>
                                    <button
                                        onClick={handleLogout}
                                        className="text-xs sm:text-sm text-amber-200/80 hover:text-amber-100 transition-all duration-200 px-1 sm:px-1.5 py-0.5 rounded-lg hover:bg-amber-800/40 active:bg-amber-800/60 active:scale-95 shrink-0 hover:shadow-md"
                                        title={t('header.logout')}
                                    >
                                        <Icon name="log-out" size={12} className="sm:w-3.5 sm:h-3.5" />
                                    </button>
                                </div>
                            )}
                        </div>
                    </header>

                    {/* Mode Toggle - 3D æœªä¾†æ„Ÿè¨­è¨ˆ */}
                    <div className="mode-toggle-container bg-gradient-to-b from-slate-800/90 to-slate-900/90 p-0.5 sm:p-1.5 border-b border-amber-500/30 flex justify-center shrink-0 shadow-sm futuristic-border" style={{ height: '36px', minHeight: '36px', maxHeight: '36px', backdropFilter: 'blur(10px)' }}>
                         <div className="flex bg-slate-700/40 backdrop-blur-sm p-0.5 sm:p-1 rounded-xl w-full max-w-md shadow-inner futuristic-border">
                            <button
                                onClick={() => setMode('bible-only')}
                                className={`flex-1 flex items-center justify-center px-1 sm:px-2 md:px-4 py-0.5 sm:py-1 md:py-2 rounded-lg text-[10px] sm:text-xs md:text-sm font-medium transition-all duration-200 active:scale-95 ${
                                    mode === 'bible-only' 
                                        ? 'bg-gradient-to-r from-amber-500/80 to-amber-600/80 text-amber-50 shadow-md shadow-amber-500/50 border border-amber-400/50 futuristic-glow' 
                                        : 'text-amber-200/60 hover:text-amber-100 hover:bg-slate-700/50'
                                }`}
                            >
                                <Icon name="book-open" size={10} className="sm:w-3.5 sm:h-3.5 mr-0.5 sm:mr-1" /> 
                                <span className="whitespace-nowrap text-[10px] sm:text-xs md:text-sm">{t('modes.bibleOnly')}</span>
                            </button>
                            <button
                                onClick={() => setMode('bible-plus')}
                                className={`flex-1 flex items-center justify-center px-1 sm:px-2 md:px-4 py-0.5 sm:py-1 md:py-2 rounded-lg text-[10px] sm:text-xs md:text-sm font-medium transition-all duration-200 active:scale-95 ${
                                    mode === 'bible-plus' 
                                        ? 'bg-gradient-to-r from-blue-500/80 to-blue-600/80 text-blue-50 shadow-md shadow-blue-500/50 border border-blue-400/50 futuristic-glow' 
                                        : 'text-amber-200/60 hover:text-amber-100 hover:bg-slate-700/50'
                                }`}
                            >
                                <Icon name="globe" size={10} className="sm:w-3.5 sm:h-3.5 mr-0.5 sm:mr-1" /> 
                                <span className="whitespace-nowrap text-[10px] sm:text-xs md:text-sm">{t('modes.biblePlusWeb')}</span>
                            </button>
                        </div>
                    </div>

                    {/* Chat Area - ä½¿ç”¨ flex-1 ç¢ºä¿ä½”ç”¨å‰©é¤˜ç©ºé–“ï¼Œä¸æ“ å£“å›ºå®šå…ƒç´  */}
                    <div ref={chatAreaRef} className="chat-area flex-1 overflow-y-auto px-2 sm:px-4 py-1 sm:py-2 md:py-4 scrollbar-thin min-h-0 relative" style={{ position: 'relative', overflowY: 'auto' }}>
                        {/* è–èª•ç¯€æœªä¾†æ„ŸèƒŒæ™¯ - çµ•å°å®šä½åœ¨èƒŒæ™¯å±¤ï¼Œç¢ºä¿ä¸é˜»æ“‹å…§å®¹ */}
                        <div style={{ 
                            position: 'absolute', 
                            top: 0, 
                            left: 0, 
                            right: 0, 
                            bottom: 0, 
                            zIndex: 0, 
                            pointerEvents: 'none',
                            overflow: 'hidden',
                            backgroundColor: '#000000', // æ·±é»‘è‰²èƒŒæ™¯
                            width: '100%',
                            height: '100%'
                        }}>
                            {/* å„ªå…ˆä½¿ç”¨ 3Dï¼Œå¤±æ•—å‰‡ä½¿ç”¨ 2D è–èª•ç¯€èƒŒæ™¯ */}
                            <FuturisticScene containerRef={chatAreaRef} />
                            {/* 2D è–èª•ç¯€èƒŒæ™¯ä½œç‚ºå‚™ç”¨ï¼ˆç¢ºä¿ç¸½æ˜¯æœ‰èƒŒæ™¯é¡¯ç¤ºï¼‰ */}
                            <ChristmasBackground2D containerRef={chatAreaRef} />
                        </div>
                        
                        {/* " Merry Christmas" æ–‡å­—ï¼ˆCSS å‹•ç•«æ•ˆæœï¼Œç¢ºä¿å¯è¦‹ï¼‰ */}
                        <div id="merry-christmas-text" style={{
                            position: 'absolute',
                            top: '50%',
                            left: '5%',
                            transform: 'translateY(-50%)',
                            color: '#FFB6C1',
                            fontFamily: "'Brush Script MT', 'Noto Serif TC', cursive",
                            fontSize: 'clamp(2rem, 5vw, 4rem)',
                            pointerEvents: 'none',
                            textShadow: '0 0 15px #ff0055, 0 0 30px #ff0055, 0 0 45px #ff0055, 0 0 60px rgba(255, 0, 85, 0.5)',
                            zIndex: 100,
                            opacity: 1,
                            fontWeight: 'normal',
                            letterSpacing: '0.1em',
                            whiteSpace: 'nowrap',
                            background: 'linear-gradient(90deg, #666 0%, #fff 50%, #666 100%)',
                            backgroundSize: '200% auto',
                            WebkitBackgroundClip: 'text',
                            WebkitTextFillColor: 'transparent',
                            backgroundClip: 'text',
                            animation: 'shine 3s linear infinite',
                            filter: 'drop-shadow(0 0 10px rgba(255, 182, 193, 0.8))',
                            mixBlendMode: 'screen'
                        }}>
                            Merry Christmas
                        </div>
                        
                        {/* è¨Šæ¯å…§å®¹ï¼ˆåœ¨ç²’å­ä¹‹ä¸Šï¼‰ - ç¢ºä¿æœ‰æ­£ç¢ºçš„ z-index å’Œå®šä½ */}
                        <div style={{ 
                            position: 'relative', 
                            zIndex: 10, 
                            width: '100%',
                            minHeight: '100%'
                        }}>
                            {messages && messages.length > 0 ? (
                                <>
                                    {messages.map((msg, index) => (
                                        <MessageBubble key={index} role={msg.role} content={msg.content} grounding={msg.grounding} />
                                    ))}
                                    {isLoading && (
                                        <div className="flex w-full justify-start mb-4 sm:mb-6 message-enter">
                                            <div className="flex-shrink-0 mr-2 sm:mr-3 mt-1">
                                                <div className="w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-gradient-to-br from-slate-800 to-slate-900 flex items-center justify-center text-amber-400 border-2 border-amber-500/50 ring-2 ring-amber-500/20 shadow-lg">
                                                    <Icon name="loader-2" size={16} className="sm:w-5 sm:h-5 animate-spin" />
                                                </div>
                                            </div>
                                            <div className="bg-gradient-to-br from-white to-stone-50 border border-stone-200/80 rounded-3xl rounded-bl-md px-4 sm:px-5 py-3 sm:py-4 shadow-lg shadow-stone-200/50 backdrop-blur-sm text-xs sm:text-sm text-stone-600">
                                                <span className="inline-flex items-center gap-2">
                                                    <span className="animate-pulse">ç‰§å¸«æ­£åœ¨æŸ¥è€ƒç¶“æ–‡</span>
                                                    <span className="flex gap-1">
                                                        <span className="w-1 h-1 bg-amber-500 rounded-full animate-bounce" style={{ animationDelay: '0ms' }}></span>
                                                        <span className="w-1 h-1 bg-amber-500 rounded-full animate-bounce" style={{ animationDelay: '150ms' }}></span>
                                                        <span className="w-1 h-1 bg-amber-500 rounded-full animate-bounce" style={{ animationDelay: '300ms' }}></span>
                                                    </span>
                                                </span>
                                            </div>
                                        </div>
                                    )}
                                    <div ref={messagesEndRef} />
                                </>
                            ) : (
                                <div className="flex items-center justify-center h-full">
                                    <div className="text-stone-400 text-sm">è¼‰å…¥ä¸­...</div>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Input Area - 3D æœªä¾†æ„Ÿè¨­è¨ˆ */}
                    <div className="input-container bg-gradient-to-t from-slate-900/95 via-slate-800/90 to-slate-900/95 border-t border-amber-500/30 shrink-0 safe-area-inset-bottom shadow-lg shadow-amber-900/30 futuristic-border" style={{ minHeight: '60px', maxHeight: '60px', padding: '0.375rem', backdropFilter: 'blur(10px)' }}>
                        <form onSubmit={handleSend} className="relative flex items-end gap-1 sm:gap-2">
                            <div className="flex-1 relative">
                                <textarea
                                    value={input}
                                    onChange={(e) => setInput(e.target.value)}
                                    onKeyDown={(e) => {
                                        // æŒ‰ Enter ç™¼é€ï¼ˆShift+Enter æ›è¡Œï¼‰
                                        if (e.key === 'Enter' && !e.shiftKey) {
                                            e.preventDefault();
                                            handleSend(e);
                                        }
                                    }}
                                    placeholder={t('input.placeholder')}
                                    rows={3}
                                    className="w-full py-1 sm:py-1.5 md:py-3 pl-2 sm:pl-4 md:pl-5 pr-8 sm:pr-11 md:pr-14 rounded-2xl bg-gradient-to-br from-stone-50 to-stone-100 border border-stone-300/80 focus:border-amber-500 focus:ring-2 focus:ring-amber-200/50 outline-none transition-all duration-200 resize-none overflow-y-auto font-serif shadow-inner placeholder:text-stone-400"
                                    disabled={isLoading}
                                    style={{ 
                                        minHeight: '2.25rem', 
                                        maxHeight: '2.5rem',
                                        lineHeight: '1.3',
                                        fontSize: '0.8rem'
                                    }}
                                />
                            </div>
                            <button
                                type="submit"
                                disabled={!input.trim() || isLoading}
                                className={`p-2 sm:p-2.5 md:p-3 rounded-full shadow-lg transition-all duration-200 active:scale-90 shrink-0 mb-0.5 sm:mb-1 ${
                                    !input.trim() || isLoading
                                    ? 'bg-gradient-to-br from-slate-700 to-slate-800 text-slate-400 cursor-not-allowed border border-slate-600/50'
                                    : 'bg-gradient-to-br from-amber-600 via-amber-700 to-amber-800 hover:from-amber-700 hover:via-amber-800 hover:to-amber-900 active:from-amber-800 active:via-amber-900 active:to-amber-950 text-white shadow-amber-900/30 hover:shadow-xl hover:shadow-amber-900/40 hover:scale-105 futuristic-glow border-2 border-amber-400/50'
                                }`}
                            >
                                <Icon name="send" size={16} className="sm:w-4 sm:h-4 md:w-5 md:h-5" />
                            </button>
                        </form>
                    </div>

                    {/* è¨­å®š Modal */}
                    {showSettingsModal && (
                        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4" onClick={() => setShowSettingsModal(false)}>
                            <div className="bg-gradient-to-br from-slate-800 via-slate-900 to-slate-800 rounded-2xl shadow-2xl border-2 border-amber-500/30 max-w-md w-full max-h-[90vh] overflow-y-auto" onClick={(e) => e.stopPropagation()}>
                                <div className="p-6 sm:p-8">
                                    <div className="flex items-center justify-between mb-6">
                                        <h2 className="text-2xl font-bold text-amber-50 font-serif">{t('settings.title')}</h2>
                                        <button
                                            onClick={() => setShowSettingsModal(false)}
                                            className="text-amber-200/70 hover:text-amber-100 transition-colors"
                                        >
                                            <Icon name="x" size={24} />
                                        </button>
                                    </div>

                                    <div className="space-y-4">
                                        {/* ç”¨æˆ¶è³‡è¨Š */}
                                        {userState.mode === 'registered' && userState.user && (
                                            <>
                                                <div className="bg-slate-700/50 rounded-xl p-4 border border-slate-600/50">
                                                    <h3 className="text-lg font-semibold text-amber-50 mb-3">{t('settings.accountInfo')}</h3>
                                                    <div className="space-y-2 text-sm">
                                                        <div>
                                                            <span className="text-amber-200/70">{t('settings.email')}:</span>
                                                            <span className="text-amber-50 ml-2">{userState.user.email}</span>
                                                        </div>
                                                        <div>
                                                            <span className="text-amber-200/70">{t('settings.username')}:</span>
                                                            <span className="text-amber-50 ml-2">{userState.user.username}</span>
                                                        </div>
                                                        <div>
                                                            <span className="text-amber-200/70">{t('settings.nickname')}:</span>
                                                            <span className="text-amber-50 ml-2">{userState.user.nickname}</span>
                                                        </div>
                                                    </div>
                                                </div>

                                                {/* æ›´æ”¹å¯†ç¢¼ */}
                                                <div className="bg-slate-700/50 rounded-xl p-4 border border-slate-600/50">
                                                    <h3 className="text-lg font-semibold text-amber-50 mb-3">{t('settings.changePassword')}</h3>
                                                    <form onSubmit={async (e) => {
                                                        e.preventDefault();
                                                        if (!changePasswordForm.oldPassword || !changePasswordForm.newPassword || !changePasswordForm.confirmPassword) {
                                                            alert(t('settings.fillAllFields'));
                                                            return;
                                                        }
                                                        if (changePasswordForm.newPassword !== changePasswordForm.confirmPassword) {
                                                            alert(t('settings.passwordMismatch'));
                                                            return;
                                                        }
                                                        if (changePasswordForm.newPassword.length < 6) {
                                                            alert(t('settings.passwordTooShort'));
                                                            return;
                                                        }
                                                        
                                                        setChangingPassword(true);
                                                        try {
                                                            const apiUrl = API_BASE_URL ? `${API_BASE_URL}/api/auth` : '/api/auth';
                                                            const response = await fetch(apiUrl, {
                                                                method: 'POST',
                                                                headers: { 'Content-Type': 'application/json' },
                                                                body: JSON.stringify({
                                                                    action: 'changePassword',
                                                                    token: userState.user.token,
                                                                    oldPassword: changePasswordForm.oldPassword,
                                                                    newPassword: changePasswordForm.newPassword
                                                                })
                                                            });

                                                            const data = await response.json();
                                                            if (response.ok && data.success) {
                                                                alert(t('settings.changeSuccess'));
                                                                setChangePasswordForm({ oldPassword: '', newPassword: '', confirmPassword: '' });
                                                                setShowOldPassword(false);
                                                                setShowNewPassword(false);
                                                                setShowConfirmPassword(false);
                                                            } else {
                                                                alert(data.error || t('settings.changeFailed'));
                                                            }
                                                        } catch (error) {
                                                            console.error('æ›´æ”¹å¯†ç¢¼éŒ¯èª¤:', error);
                                                            alert(t('settings.changeError'));
                                                        } finally {
                                                            setChangingPassword(false);
                                                        }
                                                    }} className="space-y-3">
                                                        <div>
                                                            <label className="block text-sm font-medium text-amber-200/80 mb-2">{t('settings.currentPassword')}</label>
                                                            <div className="relative">
                                                                <input
                                                                    type={showOldPassword ? "text" : "password"}
                                                                    value={changePasswordForm.oldPassword}
                                                                    onChange={(e) => setChangePasswordForm({...changePasswordForm, oldPassword: e.target.value})}
                                                                    className="w-full bg-slate-600/50 border border-slate-500/50 rounded-lg px-4 py-2.5 pr-12 text-amber-50 focus:outline-none focus:border-amber-500/50 focus:ring-2 focus:ring-amber-500/20"
                                                                    placeholder={t('settings.enterCurrentPassword')}
                                                                    required
                                                                />
                                                                <button
                                                                    type="button"
                                                                    onClick={() => setShowOldPassword(!showOldPassword)}
                                                                    className="absolute right-3 top-1/2 transform -translate-y-1/2 text-amber-200/70 hover:text-amber-100 transition-colors p-1"
                                                                    aria-label={showOldPassword ? t('settings.hidePassword') : t('settings.showPassword')}
                                                                >
                                                                    <Icon name={showOldPassword ? "eye-off" : "eye"} size={20} />
                                                                </button>
                                                            </div>
                                                        </div>
                                                        <div>
                                                            <label className="block text-sm font-medium text-amber-200/80 mb-2">{t('settings.newPassword')}</label>
                                                            <div className="relative">
                                                                <input
                                                                    type={showNewPassword ? "text" : "password"}
                                                                    value={changePasswordForm.newPassword}
                                                                    onChange={(e) => setChangePasswordForm({...changePasswordForm, newPassword: e.target.value})}
                                                                    className="w-full bg-slate-600/50 border border-slate-500/50 rounded-lg px-4 py-2.5 pr-12 text-amber-50 focus:outline-none focus:border-amber-500/50 focus:ring-2 focus:ring-amber-500/20"
                                                                    placeholder={t('settings.enterNewPassword')}
                                                                    required
                                                                    minLength={6}
                                                                />
                                                                <button
                                                                    type="button"
                                                                    onClick={() => setShowNewPassword(!showNewPassword)}
                                                                    className="absolute right-3 top-1/2 transform -translate-y-1/2 text-amber-200/70 hover:text-amber-100 transition-colors p-1"
                                                                    aria-label={showNewPassword ? t('settings.hidePassword') : t('settings.showPassword')}
                                                                >
                                                                    <Icon name={showNewPassword ? "eye-off" : "eye"} size={20} />
                                                                </button>
                                                            </div>
                                                        </div>
                                                        <div>
                                                            <label className="block text-sm font-medium text-amber-200/80 mb-2">{t('settings.confirmPassword')}</label>
                                                            <div className="relative">
                                                                <input
                                                                    type={showConfirmPassword ? "text" : "password"}
                                                                    value={changePasswordForm.confirmPassword}
                                                                    onChange={(e) => setChangePasswordForm({...changePasswordForm, confirmPassword: e.target.value})}
                                                                    className="w-full bg-slate-600/50 border border-slate-500/50 rounded-lg px-4 py-2.5 pr-12 text-amber-50 focus:outline-none focus:border-amber-500/50 focus:ring-2 focus:ring-amber-500/20"
                                                                    placeholder={t('settings.enterConfirmPassword')}
                                                                    required
                                                                    minLength={6}
                                                                />
                                                                <button
                                                                    type="button"
                                                                    onClick={() => setShowConfirmPassword(!showConfirmPassword)}
                                                                    className="absolute right-3 top-1/2 transform -translate-y-1/2 text-amber-200/70 hover:text-amber-100 transition-colors p-1"
                                                                    aria-label={showConfirmPassword ? t('settings.hidePassword') : t('settings.showPassword')}
                                                                >
                                                                    <Icon name={showConfirmPassword ? "eye-off" : "eye"} size={20} />
                                                                </button>
                                                            </div>
                                                        </div>
                                                        <button
                                                            type="submit"
                                                            disabled={changingPassword}
                                                            className="w-full bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-400 hover:to-amber-500 text-white font-semibold py-2.5 px-4 rounded-lg transition-all shadow-lg hover:shadow-xl active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                                                        >
                                                            {changingPassword ? (
                                                                <>
                                                                    <Icon name="loader" size={16} className="animate-spin" />
                                                                    <span>{t('settings.changing')}</span>
                                                                </>
                                                            ) : (
                                                                <span>{t('settings.changePasswordButton')}</span>
                                                            )}
                                                        </button>
                                                    </form>
                                                </div>
                                            </>
                                        )}

                                        {/* æ¨¡å¼èªªæ˜ */}
                                        <div className="bg-slate-700/50 rounded-xl p-4 border border-slate-600/50">
                                            <h3 className="text-lg font-semibold text-amber-50 mb-3">{t('settings.usageMode')}</h3>
                                            <div className="text-sm text-amber-200/70">
                                                {userState.mode === 'guest' ? (
                                                    <div>
                                                        <p className="mb-2">{t('settings.currentlyUsingGuest')} <strong className="text-amber-300">{t('settings.guestMode')}</strong></p>
                                                        <ul className="list-disc list-inside space-y-1 text-xs">
                                                            <li>{t('settings.guestLimitations.max20')}</li>
                                                            <li>{t('settings.guestLimitations.localOnly')}</li>
                                                            <li>{t('settings.guestLimitations.noSync')}</li>
                                                        </ul>
                                                        <button
                                                            onClick={() => {
                                                                setShowSettingsModal(false);
                                                                setShowAuthModal(true);
                                                                setAuthMode('register');
                                                            }}
                                                            className="mt-3 w-full bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-400 hover:to-amber-500 text-white font-semibold py-2 px-4 rounded-lg transition-all shadow-lg hover:shadow-xl active:scale-95 text-sm"
                                                        >
                                                            {t('settings.upgradeButton')}
                                                        </button>
                                                    </div>
                                                ) : (
                                                    <div>
                                                        <p className="mb-2">{t('settings.currentlyUsingRegistered')} <strong className="text-green-400">{t('settings.registeredMode')}</strong></p>
                                                        <ul className="list-disc list-inside space-y-1 text-xs">
                                                            <li>{t('settings.registeredFeatures.fullHistory')}</li>
                                                            <li>{t('settings.registeredFeatures.multiDevice')}</li>
                                                            <li>{t('settings.registeredFeatures.personalization')}</li>
                                                            <li>{t('settings.registeredFeatures.tracking')}</li>
                                                        </ul>
                                                    </div>
                                                )}
                                            </div>
                                        </div>

                                        {/* å…¶ä»–è¨­å®š */}
                                        <div className="bg-slate-700/50 rounded-xl p-4 border border-slate-600/50">
                                            <h3 className="text-lg font-semibold text-amber-50 mb-3">{t('settings.other')}</h3>
                                            <div className="space-y-2">
                                                <button
                                                    onClick={() => {
                                                        setShowSettingsModal(false);
                                                        setShowDisclaimerModal(true);
                                                    }}
                                                    className="w-full text-left text-sm text-amber-200/70 hover:text-amber-100 py-2 px-3 rounded-lg hover:bg-slate-600/50 transition-colors"
                                                >
                                                    {t('disclaimer.view')}
                                                </button>
                                                <button
                                                    onClick={() => {
                                                        // é‡ç½® hasSeenWelcomeï¼Œè®“æ­¡è¿ç•«é¢å¯ä»¥é‡æ–°é¡¯ç¤º
                                                        const resetState = { ...userState, hasSeenWelcome: false };
                                                        setUserState(resetState);
                                                        saveUserState(resetState);
                                                        setShowSettingsModal(false);
                                                        setShowWelcomeModal(true);
                                                    }}
                                                    className="w-full text-left text-sm text-amber-200/70 hover:text-amber-100 py-2 px-3 rounded-lg hover:bg-slate-600/50 transition-colors"
                                                >
                                                    {t('settings.reselectMode')}
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* å…è²¬è²æ˜ Modal */}
                    {showDisclaimerModal && (
                        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4" onClick={() => setShowDisclaimerModal(false)}>
                            <div className="bg-gradient-to-br from-slate-800 via-slate-900 to-slate-800 rounded-2xl shadow-2xl border-2 border-amber-500/30 max-w-3xl w-full max-h-[90vh] overflow-y-auto" onClick={(e) => e.stopPropagation()}>
                                <div className="p-6 sm:p-8">
                                    <div className="flex items-center justify-between mb-6">
                                        <h2 className="text-2xl font-bold text-amber-50 font-serif">{t('disclaimer.title')}</h2>
                                        <button
                                            onClick={() => setShowDisclaimerModal(false)}
                                            className="text-amber-200/70 hover:text-amber-100 transition-colors"
                                        >
                                            <Icon name="x" size={24} />
                                        </button>
                                    </div>

                                    <div className="prose prose-invert max-w-none text-amber-50/90 text-sm leading-relaxed">
                                        {language === 'en' ? (
                                            <div className="space-y-4">
                                                <p className="font-bold text-amber-200">BY USING AI PASTOR, YOU ACKNOWLEDGE AND AGREE TO THE FOLLOWING DISCLAIMERS:</p>
                                                
                                                <div>
                                                    <h3 className="text-lg font-semibold text-amber-100 mb-2">No Professional Advice</h3>
                                                    <p>AI Pastor is provided for informational and educational purposes only. It does not constitute professional pastoral counseling, medical/psychiatric/psychological advice, legal advice, financial advice, professional therapy, or emergency services.</p>
                                                </div>

                                                <div>
                                                    <h3 className="text-lg font-semibold text-amber-100 mb-2">Not a Replacement for Professional Services</h3>
                                                    <p>AI Pastor cannot and should never replace consultation with licensed healthcare professionals, legal counsel, financial advisors, professional mental health therapy, emergency services (call 911), or personal pastoral counseling from real pastors.</p>
                                                </div>

                                                <div>
                                                    <h3 className="text-lg font-semibold text-amber-100 mb-2">Use at Your Own Risk</h3>
                                                    <ul className="list-disc list-inside space-y-1 ml-4">
                                                        <li>AI responses may contain errors - AI technology is not perfect</li>
                                                        <li>AI Pastor is provided "as is" without warranties of any kind</li>
                                                        <li>Users are solely responsible for evaluating the accuracy of AI responses</li>
                                                        <li>The developer assumes no liability for decisions made based on AI responses</li>
                                                    </ul>
                                                </div>

                                                <div>
                                                    <h3 className="text-lg font-semibold text-amber-100 mb-2">Limitation of Liability</h3>
                                                    <p>To the fullest extent permitted by law, the developer disclaims all liability for any damages, losses, or injuries arising from use of AI Pastor. The developer is not responsible for any consequences resulting from reliance on AI-generated responses and does not guarantee the accuracy, completeness, or suitability of any information provided.</p>
                                                </div>

                                                <div>
                                                    <h3 className="text-lg font-semibold text-amber-100 mb-2">Emergency Situations</h3>
                                                    <p className="font-bold text-red-300">If you are experiencing a crisis or emergency, call 911 or your local emergency services immediately. Do not rely solely on AI Pastor for emergency situations.</p>
                                                </div>

                                                <div>
                                                    <h3 className="text-lg font-semibold text-amber-100 mb-2">User Agreement</h3>
                                                    <p>By using AI Pastor, you agree that you understand AI Pastor is an experimental tool and may contain errors, you will not hold the developer liable for any outcomes, you will seek appropriate professional help when needed, and you use this service at your own risk and discretion.</p>
                                                </div>

                                                <div className="bg-slate-700/50 p-4 rounded-lg border border-slate-600/50">
                                                    <p className="font-semibold text-amber-200">Acceptance of Terms: Your use of AI Pastor constitutes acceptance of this disclaimer. If you do not agree to these terms, please do not use AI Pastor.</p>
                                                </div>
                                            </div>
                                        ) : language === 'zh-TW' ? (
                                            <div className="space-y-4">
                                                <p className="font-bold text-amber-200">ä½¿ç”¨ AI ç‰§å¸«å³è¡¨ç¤ºæ‚¨æ‰¿èªä¸¦åŒæ„ä»¥ä¸‹å…è²¬è²æ˜ï¼š</p>
                                                
                                                <div>
                                                    <h3 className="text-lg font-semibold text-amber-100 mb-2">ç„¡å°ˆæ¥­å»ºè­°</h3>
                                                    <p>AI ç‰§å¸«åƒ…ä¾›è³‡è¨Šå’Œæ•™è‚²ç”¨é€”ã€‚ä¸æ§‹æˆå°ˆæ¥­ç‰§å¸«è¼”å°ã€é†«ç™‚/ç²¾ç¥/å¿ƒç†å»ºè­°ã€æ³•å¾‹å»ºè­°ã€è²¡å‹™å»ºè­°ã€å°ˆæ¥­æ²»ç™‚æˆ–ç·Šæ€¥æœå‹™ã€‚</p>
                                                </div>

                                                <div>
                                                    <h3 className="text-lg font-semibold text-amber-100 mb-2">ä¸èƒ½æ›¿ä»£å°ˆæ¥­æœå‹™</h3>
                                                    <p>AI ç‰§å¸«ä¸èƒ½ä¸”ä¸æ‡‰æ›¿ä»£èˆ‡æŒç‰Œé†«ç™‚å°ˆæ¥­äººå“¡çš„è«®è©¢ã€æ³•å¾‹é¡§å•ã€è²¡å‹™é¡§å•ã€å°ˆæ¥­å¿ƒç†å¥åº·æ²»ç™‚ã€ç·Šæ€¥æœå‹™ï¼ˆæ’¥æ‰“ 119ï¼‰ï¼Œæˆ–çœŸå¯¦ç‰§å¸«çš„å€‹äººç‰§å¸«è¼”å°ã€‚</p>
                                                </div>

                                                <div>
                                                    <h3 className="text-lg font-semibold text-amber-100 mb-2">ä½¿ç”¨é¢¨éšªè‡ªè² </h3>
                                                    <ul className="list-disc list-inside space-y-1 ml-4">
                                                        <li>AI å›æ‡‰å¯èƒ½åŒ…å«éŒ¯èª¤ - AI æŠ€è¡“ä¸¦ä¸å®Œç¾</li>
                                                        <li>AI ç‰§å¸«ä»¥ã€Œç¾ç‹€ã€æä¾›ï¼Œä¸æä¾›ä»»ä½•å½¢å¼çš„ä¿è­‰</li>
                                                        <li>ç”¨æˆ¶éœ€è‡ªè¡Œè² è²¬è©•ä¼° AI å›æ‡‰çš„æº–ç¢ºæ€§</li>
                                                        <li>é–‹ç™¼è€…ä¸å°åŸºæ–¼ AI å›æ‡‰åšå‡ºçš„æ±ºå®šæ‰¿æ“”ä»»ä½•è²¬ä»»</li>
                                                    </ul>
                                                </div>

                                                <div>
                                                    <h3 className="text-lg font-semibold text-amber-100 mb-2">è²¬ä»»é™åˆ¶</h3>
                                                    <p>åœ¨æ³•å¾‹å…è¨±çš„æœ€å¤§ç¯„åœå…§ï¼Œé–‹ç™¼è€…ä¸æ‰¿æ“”å› ä½¿ç”¨ AI ç‰§å¸«è€Œç”¢ç”Ÿçš„ä»»ä½•æå®³ã€æå¤±æˆ–å‚·å®³çš„è²¬ä»»ã€‚é–‹ç™¼è€…ä¸å°ä¾è³´ AI ç”Ÿæˆå›æ‡‰è€Œç”¢ç”Ÿçš„ä»»ä½•å¾Œæœè² è²¬ï¼Œä¹Ÿä¸ä¿è­‰æ‰€æä¾›è³‡è¨Šçš„æº–ç¢ºæ€§ã€å®Œæ•´æ€§æˆ–é©ç”¨æ€§ã€‚</p>
                                                </div>

                                                <div>
                                                    <h3 className="text-lg font-semibold text-amber-100 mb-2">ç·Šæ€¥æƒ…æ³</h3>
                                                    <p className="font-bold text-red-300">å¦‚æœæ‚¨é‡åˆ°å±æ©Ÿæˆ–ç·Šæ€¥æƒ…æ³ï¼Œè«‹ç«‹å³æ’¥æ‰“ 119 æˆ–ç•¶åœ°ç·Šæ€¥æœå‹™ã€‚ä¸è¦åƒ…ä¾è³´ AI ç‰§å¸«è™•ç†ç·Šæ€¥æƒ…æ³ã€‚</p>
                                                </div>

                                                <div>
                                                    <h3 className="text-lg font-semibold text-amber-100 mb-2">ç”¨æˆ¶å”è­°</h3>
                                                    <p>ä½¿ç”¨ AI ç‰§å¸«å³è¡¨ç¤ºæ‚¨åŒæ„ï¼šæ‚¨ç†è§£ AI ç‰§å¸«æ˜¯å¯¦é©—æ€§å·¥å…·ä¸”å¯èƒ½åŒ…å«éŒ¯èª¤ï¼Œæ‚¨ä¸æœƒè¦æ±‚é–‹ç™¼è€…å°ä»»ä½•çµæœè² è²¬ï¼Œæ‚¨æœƒåœ¨éœ€è¦æ™‚å°‹æ±‚é©ç•¶çš„å°ˆæ¥­å¹«åŠ©ï¼Œä¸¦ä¸”æ‚¨è‡ªè¡Œæ‰¿æ“”ä½¿ç”¨æ­¤æœå‹™çš„é¢¨éšªã€‚</p>
                                                </div>

                                                <div className="bg-slate-700/50 p-4 rounded-lg border border-slate-600/50">
                                                    <p className="font-semibold text-amber-200">æ¥å—æ¢æ¬¾ï¼šæ‚¨ä½¿ç”¨ AI ç‰§å¸«å³è¡¨ç¤ºæ¥å—æ­¤å…è²¬è²æ˜ã€‚å¦‚æœæ‚¨ä¸åŒæ„é€™äº›æ¢æ¬¾ï¼Œè«‹å‹¿ä½¿ç”¨ AI ç‰§å¸«ã€‚</p>
                                                </div>
                                            </div>
                                        ) : (
                                            <div className="space-y-4">
                                                <p className="font-bold text-amber-200">ä½¿ç”¨ AI ç‰§å¸ˆå³è¡¨ç¤ºæ‚¨æ‰¿è®¤å¹¶åŒæ„ä»¥ä¸‹å…è´£å£°æ˜ï¼š</p>
                                                
                                                <div>
                                                    <h3 className="text-lg font-semibold text-amber-100 mb-2">æ— ä¸“ä¸šå»ºè®®</h3>
                                                    <p>AI ç‰§å¸ˆä»…ä¾›èµ„è®¯å’Œæ•™è‚²ç”¨é€”ã€‚ä¸æ„æˆä¸“ä¸šç‰§å¸ˆè¾…å¯¼ã€åŒ»ç–—/ç²¾ç¥/å¿ƒç†å»ºè®®ã€æ³•å¾‹å»ºè®®ã€è´¢åŠ¡å»ºè®®ã€ä¸“ä¸šæ²»ç–—æˆ–ç´§æ€¥æœåŠ¡ã€‚</p>
                                                </div>

                                                <div>
                                                    <h3 className="text-lg font-semibold text-amber-100 mb-2">ä¸èƒ½æ›¿ä»£ä¸“ä¸šæœåŠ¡</h3>
                                                    <p>AI ç‰§å¸ˆä¸èƒ½ä¸”ä¸åº”æ›¿ä»£ä¸æŒç‰ŒåŒ»ç–—ä¸“ä¸šäººå‘˜çš„å’¨è¯¢ã€æ³•å¾‹é¡¾é—®ã€è´¢åŠ¡é¡¾é—®ã€ä¸“ä¸šå¿ƒç†å¥åº·æ²»ç–—ã€ç´§æ€¥æœåŠ¡ï¼ˆæ‹¨æ‰“ 119ï¼‰ï¼Œæˆ–çœŸå®ç‰§å¸ˆçš„ä¸ªäººç‰§å¸ˆè¾…å¯¼ã€‚</p>
                                                </div>

                                                <div>
                                                    <h3 className="text-lg font-semibold text-amber-100 mb-2">ä½¿ç”¨é£é™©è‡ªè´Ÿ</h3>
                                                    <ul className="list-disc list-inside space-y-1 ml-4">
                                                        <li>AI å›åº”å¯èƒ½åŒ…å«é”™è¯¯ - AI æŠ€æœ¯å¹¶ä¸å®Œç¾</li>
                                                        <li>AI ç‰§å¸ˆä»¥ã€Œç°çŠ¶ã€æä¾›ï¼Œä¸æä¾›ä»»ä½•å½¢å¼çš„ä¿è¯</li>
                                                        <li>ç”¨æˆ·éœ€è‡ªè¡Œè´Ÿè´£è¯„ä¼° AI å›åº”çš„å‡†ç¡®æ€§</li>
                                                        <li>å¼€å‘è€…ä¸å¯¹åŸºäº AI å›åº”åšå‡ºçš„å†³å®šæ‰¿æ‹…ä»»ä½•è´£ä»»</li>
                                                    </ul>
                                                </div>

                                                <div>
                                                    <h3 className="text-lg font-semibold text-amber-100 mb-2">è´£ä»»é™åˆ¶</h3>
                                                    <p>åœ¨æ³•å¾‹å…è®¸çš„æœ€å¤§èŒƒå›´å†…ï¼Œå¼€å‘è€…ä¸æ‰¿æ‹…å› ä½¿ç”¨ AI ç‰§å¸ˆè€Œäº§ç”Ÿçš„ä»»ä½•æŸå®³ã€æŸå¤±æˆ–ä¼¤å®³çš„è´£ä»»ã€‚å¼€å‘è€…ä¸å¯¹ä¾èµ– AI ç”Ÿæˆå›åº”è€Œäº§ç”Ÿçš„ä»»ä½•åæœè´Ÿè´£ï¼Œä¹Ÿä¸ä¿è¯æ‰€æä¾›èµ„è®¯çš„å‡†ç¡®æ€§ã€å®Œæ•´æ€§æˆ–é€‚ç”¨æ€§ã€‚</p>
                                                </div>

                                                <div>
                                                    <h3 className="text-lg font-semibold text-amber-100 mb-2">ç´§æ€¥æƒ…å†µ</h3>
                                                    <p className="font-bold text-red-300">å¦‚æœæ‚¨é‡åˆ°å±æœºæˆ–ç´§æ€¥æƒ…å†µï¼Œè¯·ç«‹å³æ‹¨æ‰“ 119 æˆ–å½“åœ°ç´§æ€¥æœåŠ¡ã€‚ä¸è¦ä»…ä¾èµ– AI ç‰§å¸ˆå¤„ç†ç´§æ€¥æƒ…å†µã€‚</p>
                                                </div>

                                                <div>
                                                    <h3 className="text-lg font-semibold text-amber-100 mb-2">ç”¨æˆ·åè®®</h3>
                                                    <p>ä½¿ç”¨ AI ç‰§å¸ˆå³è¡¨ç¤ºæ‚¨åŒæ„ï¼šæ‚¨ç†è§£ AI ç‰§å¸ˆæ˜¯å®éªŒæ€§å·¥å…·ä¸”å¯èƒ½åŒ…å«é”™è¯¯ï¼Œæ‚¨ä¸ä¼šè¦æ±‚å¼€å‘è€…å¯¹ä»»ä½•ç»“æœè´Ÿè´£ï¼Œæ‚¨ä¼šåœ¨éœ€è¦æ—¶å¯»æ±‚é€‚å½“çš„ä¸“ä¸šå¸®åŠ©ï¼Œå¹¶ä¸”æ‚¨è‡ªè¡Œæ‰¿æ‹…ä½¿ç”¨æ­¤æœåŠ¡çš„é£é™©ã€‚</p>
                                                </div>

                                                <div className="bg-slate-700/50 p-4 rounded-lg border border-slate-600/50">
                                                    <p className="font-semibold text-amber-200">æ¥å—æ¡æ¬¾ï¼šæ‚¨ä½¿ç”¨ AI ç‰§å¸ˆå³è¡¨ç¤ºæ¥å—æ­¤å…è´£å£°æ˜ã€‚å¦‚æœæ‚¨ä¸åŒæ„è¿™äº›æ¡æ¬¾ï¼Œè¯·å‹¿ä½¿ç”¨ AI ç‰§å¸ˆã€‚</p>
                                                </div>
                                            </div>
                                        )}
                                    </div>

                                    <div className="mt-6 flex justify-end">
                                        <button
                                            onClick={() => setShowDisclaimerModal(false)}
                                            className="bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-400 hover:to-amber-500 text-white font-semibold py-2 px-6 rounded-lg transition-all shadow-lg hover:shadow-xl active:scale-95"
                                        >
                                            {t('disclaimer.close')}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* å°è©±ç®¡ç† Modalï¼ˆåƒ…è¨»å†Šç”¨æˆ¶ï¼‰ */}
                    {showConversationsModal && userState.mode === 'registered' && (
                        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4" onClick={() => setShowConversationsModal(false)}>
                            <div className="bg-gradient-to-br from-slate-800 via-slate-900 to-slate-800 rounded-2xl shadow-2xl border-2 border-amber-500/30 max-w-2xl w-full max-h-[90vh] overflow-y-auto" onClick={(e) => e.stopPropagation()}>
                                <div className="p-6 sm:p-8">
                                    <div className="flex items-center justify-between mb-6">
                                        <h2 className="text-2xl font-bold text-amber-50 font-serif">{t('conversations.title')}</h2>
                                        <button
                                            onClick={() => setShowConversationsModal(false)}
                                            className="text-amber-200/70 hover:text-amber-100 transition-colors"
                                        >
                                            <Icon name="x" size={24} />
                                        </button>
                                    </div>

                                    <div className="space-y-4">
                                        <div className="bg-slate-700/50 rounded-xl p-4 border border-slate-600/50">
                                            <div className="flex items-center justify-between mb-2">
                                                <span className="text-amber-50 font-semibold">ç›®å‰å°è©±</span>
                                                <span className="text-xs text-amber-200/70">{messages.length} æ¢è¨Šæ¯</span>
                                            </div>
                                            <p className="text-sm text-amber-200/70 mb-3">
                                                æ‚¨çš„æ‰€æœ‰å°è©±è¨˜éŒ„å·²è‡ªå‹•ä¿å­˜åˆ°é›²ç«¯ï¼Œå¯åœ¨ä»»ä½•è£ç½®ä¸Šå­˜å–ã€‚
                                            </p>
                                            <button
                                                onClick={() => {
                                                    if (window.confirm('ç¢ºå®šè¦æ¸…é™¤ç›®å‰å°è©±è¨˜éŒ„å—ï¼Ÿ')) {
                                                        clearHistory();
                                                        setShowConversationsModal(false);
                                                    }
                                                }}
                                                className="w-full bg-red-600/80 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition-all shadow-lg hover:shadow-xl active:scale-95 text-sm"
                                            >
                                                æ¸…é™¤ç›®å‰å°è©±
                                            </button>
                                        </div>

                                        <div className="bg-slate-700/50 rounded-xl p-4 border border-slate-600/50">
                                            <h3 className="text-amber-50 font-semibold mb-2">è³‡æ–™åŒæ­¥</h3>
                                            <p className="text-sm text-amber-200/70 mb-3">
                                                æ‚¨çš„å°è©±è¨˜éŒ„æœƒè‡ªå‹•åŒæ­¥åˆ°é›²ç«¯ã€‚å¦‚æœéœ€è¦æ‰‹å‹•åŒæ­¥ï¼Œè«‹é‡æ–°è¼‰å…¥é é¢ã€‚
                                            </p>
                                            <button
                                                onClick={async () => {
                                                    if (userState.user?.token) {
                                                        try {
                                                            await saveHistoryToBackend(userState.user.token, messages);
                                                            alert('å°è©±è¨˜éŒ„å·²åŒæ­¥åˆ°é›²ç«¯ï¼');
                                                        } catch (error) {
                                                            alert('åŒæ­¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
                                                        }
                                                    }
                                                }}
                                                className="w-full bg-amber-600/80 hover:bg-amber-600 text-white font-semibold py-2 px-4 rounded-lg transition-all shadow-lg hover:shadow-xl active:scale-95 text-sm"
                                            >
                                                ç«‹å³åŒæ­¥åˆ°é›²ç«¯
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* ç®¡ç†å“¡é¢æ¿ Modalï¼ˆåƒ…ç®¡ç†å“¡å¯è¦‹ï¼‰ */}
                    {showAdminModal && isAdmin && (
                        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4" onClick={() => {
                            setShowAdminModal(false);
                            setSelectedUser(null);
                            setAdminSearchTerm('');
                        }}>
                            <div className="bg-gradient-to-br from-slate-800 via-slate-900 to-slate-800 rounded-2xl shadow-2xl border-2 border-red-500/30 max-w-6xl w-full max-h-[90vh] overflow-y-auto" onClick={(e) => e.stopPropagation()}>
                                <div className="p-6 sm:p-8">
                                    <div className="flex items-center justify-between mb-6">
                                        <div>
                                            <h2 className="text-2xl font-bold text-red-400 font-serif flex items-center gap-2">
                                                <Icon name="shield" size={24} />
                                                {t('admin.title')}
                                            </h2>
                                            <p className="text-sm text-amber-200/70 mt-1">æŸ¥çœ‹å’Œç®¡ç†æ‰€æœ‰è¨»å†Šç”¨æˆ¶</p>
                                        </div>
                                        <button
                                            onClick={() => {
                                                setShowAdminModal(false);
                                                setSelectedUser(null);
                                                setAdminSearchTerm('');
                                            }}
                                            className="text-amber-200/70 hover:text-amber-100 transition-colors"
                                        >
                                            <Icon name="x" size={24} />
                                        </button>
                                    </div>

                                    {/* çµ±è¨ˆè³‡è¨Šå¡ç‰‡ */}
                                    {adminStats && (
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                            <div className="bg-slate-700/50 rounded-xl p-4 border border-slate-600/50">
                                                <div className="flex items-center justify-between">
                                                    <div>
                                                        <p className="text-sm text-amber-200/70">ç¸½ç”¨æˆ¶æ•¸</p>
                                                        <p className="text-2xl font-bold text-amber-50 mt-1">{adminStats.totalUsers || 0}</p>
                                                    </div>
                                                    <Icon name="users" size={32} className="text-amber-400/50" />
                                                </div>
                                            </div>
                                            <div className="bg-slate-700/50 rounded-xl p-4 border border-slate-600/50">
                                                <div className="flex items-center justify-between">
                                                    <div>
                                                        <p className="text-sm text-amber-200/70">æ´»èº Session</p>
                                                        <p className="text-2xl font-bold text-amber-50 mt-1">{adminStats.totalSessions || 0}</p>
                                                    </div>
                                                    <Icon name="activity" size={32} className="text-amber-400/50" />
                                                </div>
                                            </div>
                                            <div className="bg-slate-700/50 rounded-xl p-4 border border-slate-600/50">
                                                <div className="flex items-center justify-between">
                                                    <div>
                                                        <p className="text-sm text-amber-200/70">ç”¨æˆ¶æ•¸æ“š</p>
                                                        <p className="text-2xl font-bold text-amber-50 mt-1">{adminStats.totalUserData || 0}</p>
                                                    </div>
                                                    <Icon name="database" size={32} className="text-amber-400/50" />
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {/* æœå°‹å’Œåˆ·æ–° */}
                                    <div className="flex items-center gap-4 mb-4">
                                        <div className="flex-1 relative">
                                            <Icon name="search" size={18} className="absolute left-3 top-1/2 transform -translate-y-1/2 text-amber-200/50" />
                                            <input
                                                type="text"
                                                placeholder="æœå°‹ç”¨æˆ¶ï¼ˆEmailã€ä½¿ç”¨è€…åç¨±ã€æš±ç¨±ï¼‰..."
                                                value={adminSearchTerm}
                                                onChange={(e) => setAdminSearchTerm(e.target.value)}
                                                className="w-full bg-slate-700/50 border border-slate-600/50 rounded-lg px-10 py-2 text-amber-50 placeholder-amber-200/30 focus:outline-none focus:border-amber-500/50"
                                            />
                                        </div>
                                        <button
                                            onClick={loadAdminData}
                                            disabled={adminLoading}
                                            className="px-4 py-2 bg-amber-600/80 hover:bg-amber-600 text-white font-semibold rounded-lg transition-all shadow-lg hover:shadow-xl active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
                                        >
                                            <Icon name={adminLoading ? "loader" : "refresh-cw"} size={16} className={adminLoading ? "animate-spin" : ""} />
                                            {adminLoading ? 'è¼‰å…¥ä¸­...' : 'åˆ·æ–°'}
                                        </button>
                                    </div>

                                    {/* ç”¨æˆ¶åˆ—è¡¨ */}
                                    <div className="bg-slate-700/30 rounded-xl border border-slate-600/50 overflow-hidden">
                                        {adminLoading ? (
                                            <div className="p-8 text-center">
                                                <Icon name="loader" size={32} className="animate-spin text-amber-400 mx-auto mb-2" />
                                                <p className="text-amber-200/70">è¼‰å…¥ä¸­...</p>
                                            </div>
                                        ) : adminUsers.length === 0 ? (
                                            <div className="p-8 text-center">
                                                <Icon name="users" size={32} className="text-amber-400/50 mx-auto mb-2" />
                                                <p className="text-amber-200/70">ç›®å‰æ²’æœ‰è¨»å†Šç”¨æˆ¶</p>
                                            </div>
                                        ) : (
                                            <div className="overflow-x-auto">
                                                <table className="w-full">
                                                    <thead className="bg-slate-800/50">
                                                        <tr>
                                                            <th className="px-4 py-3 text-left text-xs font-semibold text-amber-200/80 uppercase tracking-wider">Email</th>
                                                            <th className="px-4 py-3 text-left text-xs font-semibold text-amber-200/80 uppercase tracking-wider">ä½¿ç”¨è€…åç¨±</th>
                                                            <th className="px-4 py-3 text-left text-xs font-semibold text-amber-200/80 uppercase tracking-wider">æš±ç¨±</th>
                                                            <th className="px-4 py-3 text-left text-xs font-semibold text-amber-200/80 uppercase tracking-wider">è¨»å†Šæ™‚é–“</th>
                                                            <th className="px-4 py-3 text-left text-xs font-semibold text-amber-200/80 uppercase tracking-wider">æ“ä½œ</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody className="divide-y divide-slate-700/50">
                                                        {adminUsers
                                                            .filter(user => {
                                                                if (!adminSearchTerm) return true;
                                                                const search = adminSearchTerm.toLowerCase();
                                                                return (
                                                                    user.email?.toLowerCase().includes(search) ||
                                                                    user.username?.toLowerCase().includes(search) ||
                                                                    user.nickname?.toLowerCase().includes(search)
                                                                );
                                                            })
                                                            .map((user, index) => (
                                                                <tr key={user.email || index} className="hover:bg-slate-700/30 transition-colors">
                                                                    <td className="px-4 py-3 text-sm text-amber-50">{user.email || '-'}</td>
                                                                    <td className="px-4 py-3 text-sm text-amber-200/80">{user.username || '-'}</td>
                                                                    <td className="px-4 py-3 text-sm text-amber-200/80">{user.nickname || '-'}</td>
                                                                    <td className="px-4 py-3 text-sm text-amber-200/70">
                                                                        {user.createdAt ? new Date(user.createdAt).toLocaleString('zh-TW', {
                                                                            year: 'numeric',
                                                                            month: '2-digit',
                                                                            day: '2-digit',
                                                                            hour: '2-digit',
                                                                            minute: '2-digit'
                                                                        }) : '-'}
                                                                    </td>
                                                                    <td className="px-4 py-3 text-sm">
                                                                        <button
                                                                            onClick={() => setSelectedUser(selectedUser?.email === user.email ? null : user)}
                                                                            className="text-amber-400 hover:text-amber-300 transition-colors flex items-center gap-1"
                                                                        >
                                                                            <Icon name={selectedUser?.email === user.email ? "chevron-up" : "chevron-down"} size={16} />
                                                                            {selectedUser?.email === user.email ? 'æ”¶èµ·' : 'è©³æƒ…'}
                                                                        </button>
                                                                    </td>
                                                                </tr>
                                                            ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                        )}
                                    </div>

                                    {/* ç”¨æˆ¶è©³æƒ…å±•é–‹ */}
                                    {selectedUser && (
                                        <div className="mt-4 bg-slate-700/50 rounded-xl p-4 border border-slate-600/50">
                                            <h3 className="text-lg font-semibold text-amber-50 mb-3">ç”¨æˆ¶è©³æƒ…</h3>
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                <div>
                                                    <p className="text-sm text-amber-200/70 mb-1">Email</p>
                                                    <p className="text-amber-50">{selectedUser.email || '-'}</p>
                                                </div>
                                                <div>
                                                    <p className="text-sm text-amber-200/70 mb-1">ä½¿ç”¨è€…åç¨±</p>
                                                    <p className="text-amber-50">{selectedUser.username || '-'}</p>
                                                </div>
                                                <div>
                                                    <p className="text-sm text-amber-200/70 mb-1">æš±ç¨±</p>
                                                    <p className="text-amber-50">{selectedUser.nickname || '-'}</p>
                                                </div>
                                                <div>
                                                    <p className="text-sm text-amber-200/70 mb-1">è¨»å†Šæ™‚é–“</p>
                                                    <p className="text-amber-50">
                                                        {selectedUser.createdAt ? new Date(selectedUser.createdAt).toLocaleString('zh-TW') : '-'}
                                                    </p>
                                                </div>
                                                <div>
                                                    <p className="text-sm text-amber-200/70 mb-1">æœ€å¾Œæ›´æ–°</p>
                                                    <p className="text-amber-50">
                                                        {selectedUser.updatedAt ? new Date(selectedUser.updatedAt).toLocaleString('zh-TW') : '-'}
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {/* é¡¯ç¤ºæœå°‹çµæœæ•¸é‡ */}
                                    {adminSearchTerm && (
                                        <div className="mt-4 text-sm text-amber-200/70 text-center">
                                            æ‰¾åˆ° {adminUsers.filter(user => {
                                                const search = adminSearchTerm.toLowerCase();
                                                return (
                                                    user.email?.toLowerCase().includes(search) ||
                                                    user.username?.toLowerCase().includes(search) ||
                                                    user.nickname?.toLowerCase().includes(search)
                                                );
                                            }).length} å€‹ç¬¦åˆæ¢ä»¶çš„ç”¨æˆ¶
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

